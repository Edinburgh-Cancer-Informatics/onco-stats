<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Edinburgh Cancer Informatics Group">
<meta name="dcterms.date" content="2025-12-05">

<title>Survival Analysis in R: A Practical Tutorial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="survival_analysis_tutorial_files/libs/clipboard/clipboard.min.js"></script>
<script src="survival_analysis_tutorial_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="survival_analysis_tutorial_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="survival_analysis_tutorial_files/libs/quarto-html/popper.min.js"></script>
<script src="survival_analysis_tutorial_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="survival_analysis_tutorial_files/libs/quarto-html/anchor.min.js"></script>
<link href="survival_analysis_tutorial_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="survival_analysis_tutorial_files/libs/quarto-html/quarto-syntax-highlighting-234273d1456647dabc34a594ac50e507.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="survival_analysis_tutorial_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="survival_analysis_tutorial_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="survival_analysis_tutorial_files/libs/bootstrap/bootstrap-b95c42e6fe75e37898ff14454f2d5385.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#why-survival-analysis" id="toc-why-survival-analysis" class="nav-link" data-scroll-target="#why-survival-analysis"><span class="header-section-number">2</span> Why Survival Analysis?</a>
  <ul class="collapse">
  <li><a href="#the-problem-with-standard-methods" id="toc-the-problem-with-standard-methods" class="nav-link" data-scroll-target="#the-problem-with-standard-methods"><span class="header-section-number">2.1</span> The Problem with Standard Methods</a></li>
  <li><a href="#what-happens-if-we-ignore-censoring" id="toc-what-happens-if-we-ignore-censoring" class="nav-link" data-scroll-target="#what-happens-if-we-ignore-censoring"><span class="header-section-number">2.2</span> What Happens If We Ignore Censoring?</a></li>
  <li><a href="#key-concepts" id="toc-key-concepts" class="nav-link" data-scroll-target="#key-concepts"><span class="header-section-number">2.3</span> Key Concepts</a></li>
  <li><a href="#the-non-informative-censoring-assumption" id="toc-the-non-informative-censoring-assumption" class="nav-link" data-scroll-target="#the-non-informative-censoring-assumption"><span class="header-section-number">2.4</span> The Non-Informative Censoring Assumption</a></li>
  </ul></li>
  <li><a href="#loading-the-data" id="toc-loading-the-data" class="nav-link" data-scroll-target="#loading-the-data"><span class="header-section-number">3</span> Loading the Data</a>
  <ul class="collapse">
  <li><a href="#calculating-survival-times-from-dates" id="toc-calculating-survival-times-from-dates" class="nav-link" data-scroll-target="#calculating-survival-times-from-dates"><span class="header-section-number">3.1</span> Calculating Survival Times from Dates</a></li>
  </ul></li>
  <li><a href="#patient-characteristics" id="toc-patient-characteristics" class="nav-link" data-scroll-target="#patient-characteristics"><span class="header-section-number">4</span> Patient Characteristics</a>
  <ul class="collapse">
  <li><a href="#summary-table" id="toc-summary-table" class="nav-link" data-scroll-target="#summary-table"><span class="header-section-number">4.1</span> Summary Table</a></li>
  <li><a href="#distribution-by-health-board" id="toc-distribution-by-health-board" class="nav-link" data-scroll-target="#distribution-by-health-board"><span class="header-section-number">4.2</span> Distribution by Health Board</a></li>
  </ul></li>
  <li><a href="#creating-a-survival-object" id="toc-creating-a-survival-object" class="nav-link" data-scroll-target="#creating-a-survival-object"><span class="header-section-number">5</span> Creating a Survival Object</a>
  <ul class="collapse">
  <li><a href="#understanding-censoring" id="toc-understanding-censoring" class="nav-link" data-scroll-target="#understanding-censoring"><span class="header-section-number">5.1</span> Understanding Censoring</a></li>
  <li><a href="#creating-the-survival-object" id="toc-creating-the-survival-object" class="nav-link" data-scroll-target="#creating-the-survival-object"><span class="header-section-number">5.2</span> Creating the Survival Object</a></li>
  </ul></li>
  <li><a href="#kaplan-meier-survival-estimation" id="toc-kaplan-meier-survival-estimation" class="nav-link" data-scroll-target="#kaplan-meier-survival-estimation"><span class="header-section-number">6</span> Kaplan-Meier Survival Estimation</a>
  <ul class="collapse">
  <li><a href="#fitting-the-km-curve" id="toc-fitting-the-km-curve" class="nav-link" data-scroll-target="#fitting-the-km-curve"><span class="header-section-number">6.1</span> Fitting the KM Curve</a></li>
  <li><a href="#plotting-the-overall-survival-curve" id="toc-plotting-the-overall-survival-curve" class="nav-link" data-scroll-target="#plotting-the-overall-survival-curve"><span class="header-section-number">6.2</span> Plotting the Overall Survival Curve</a></li>
  <li><a href="#median-survival-time" id="toc-median-survival-time" class="nav-link" data-scroll-target="#median-survival-time"><span class="header-section-number">6.3</span> Median Survival Time</a></li>
  <li><a href="#estimating-survival-at-specific-time-points" id="toc-estimating-survival-at-specific-time-points" class="nav-link" data-scroll-target="#estimating-survival-at-specific-time-points"><span class="header-section-number">6.4</span> Estimating Survival at Specific Time Points</a></li>
  </ul></li>
  <li><a href="#survival-curves-by-subgroups" id="toc-survival-curves-by-subgroups" class="nav-link" data-scroll-target="#survival-curves-by-subgroups"><span class="header-section-number">7</span> Survival Curves by Subgroups</a>
  <ul class="collapse">
  <li><a href="#by-hormone-receptor-status" id="toc-by-hormone-receptor-status" class="nav-link" data-scroll-target="#by-hormone-receptor-status"><span class="header-section-number">7.1</span> By Hormone Receptor Status</a></li>
  <li><a href="#by-ecog-performance-status" id="toc-by-ecog-performance-status" class="nav-link" data-scroll-target="#by-ecog-performance-status"><span class="header-section-number">7.2</span> By ECOG Performance Status</a></li>
  <li><a href="#by-number-of-metastatic-sites" id="toc-by-number-of-metastatic-sites" class="nav-link" data-scroll-target="#by-number-of-metastatic-sites"><span class="header-section-number">7.3</span> By Number of Metastatic Sites</a></li>
  </ul></li>
  <li><a href="#hazard-functions" id="toc-hazard-functions" class="nav-link" data-scroll-target="#hazard-functions"><span class="header-section-number">8</span> Hazard Functions</a>
  <ul class="collapse">
  <li><a href="#cumulative-hazard-function" id="toc-cumulative-hazard-function" class="nav-link" data-scroll-target="#cumulative-hazard-function"><span class="header-section-number">8.1</span> Cumulative Hazard Function</a></li>
  <li><a href="#smoothed-hazard-function" id="toc-smoothed-hazard-function" class="nav-link" data-scroll-target="#smoothed-hazard-function"><span class="header-section-number">8.2</span> Smoothed Hazard Function</a></li>
  </ul></li>
  <li><a href="#log-rank-test" id="toc-log-rank-test" class="nav-link" data-scroll-target="#log-rank-test"><span class="header-section-number">9</span> Log-Rank Test</a>
  <ul class="collapse">
  <li><a href="#how-the-log-rank-test-works" id="toc-how-the-log-rank-test-works" class="nav-link" data-scroll-target="#how-the-log-rank-test-works"><span class="header-section-number">9.1</span> How the Log-Rank Test Works</a></li>
  <li><a href="#comparing-hormone-receptor-groups" id="toc-comparing-hormone-receptor-groups" class="nav-link" data-scroll-target="#comparing-hormone-receptor-groups"><span class="header-section-number">9.2</span> Comparing Hormone Receptor Groups</a></li>
  <li><a href="#comparing-ecog-performance-status-groups" id="toc-comparing-ecog-performance-status-groups" class="nav-link" data-scroll-target="#comparing-ecog-performance-status-groups"><span class="header-section-number">9.3</span> Comparing ECOG Performance Status Groups</a></li>
  <li><a href="#stratified-log-rank-test" id="toc-stratified-log-rank-test" class="nav-link" data-scroll-target="#stratified-log-rank-test"><span class="header-section-number">9.4</span> Stratified Log-Rank Test</a></li>
  </ul></li>
  <li><a href="#cox-proportional-hazards-regression" id="toc-cox-proportional-hazards-regression" class="nav-link" data-scroll-target="#cox-proportional-hazards-regression"><span class="header-section-number">10</span> Cox Proportional Hazards Regression</a>
  <ul class="collapse">
  <li><a href="#why-use-cox-regression" id="toc-why-use-cox-regression" class="nav-link" data-scroll-target="#why-use-cox-regression"><span class="header-section-number">10.1</span> Why Use Cox Regression?</a></li>
  <li><a href="#the-cox-model" id="toc-the-cox-model" class="nav-link" data-scroll-target="#the-cox-model"><span class="header-section-number">10.2</span> The Cox Model</a></li>
  <li><a href="#the-proportional-hazards-assumption" id="toc-the-proportional-hazards-assumption" class="nav-link" data-scroll-target="#the-proportional-hazards-assumption"><span class="header-section-number">10.3</span> The Proportional Hazards Assumption</a></li>
  <li><a href="#univariable-cox-models" id="toc-univariable-cox-models" class="nav-link" data-scroll-target="#univariable-cox-models"><span class="header-section-number">10.4</span> Univariable Cox Models</a></li>
  <li><a href="#multivariable-cox-model" id="toc-multivariable-cox-model" class="nav-link" data-scroll-target="#multivariable-cox-model"><span class="header-section-number">10.5</span> Multivariable Cox Model</a></li>
  <li><a href="#understanding-hazard-ratios" id="toc-understanding-hazard-ratios" class="nav-link" data-scroll-target="#understanding-hazard-ratios"><span class="header-section-number">10.6</span> Understanding Hazard Ratios</a></li>
  <li><a href="#formatted-multivariable-results" id="toc-formatted-multivariable-results" class="nav-link" data-scroll-target="#formatted-multivariable-results"><span class="header-section-number">10.7</span> Formatted Multivariable Results</a></li>
  <li><a href="#forest-plot-of-hazard-ratios" id="toc-forest-plot-of-hazard-ratios" class="nav-link" data-scroll-target="#forest-plot-of-hazard-ratios"><span class="header-section-number">10.8</span> Forest Plot of Hazard Ratios</a></li>
  <li><a href="#model-fit-statistics" id="toc-model-fit-statistics" class="nav-link" data-scroll-target="#model-fit-statistics"><span class="header-section-number">10.9</span> Model Fit Statistics</a></li>
  <li><a href="#predicting-survival-for-specific-patients" id="toc-predicting-survival-for-specific-patients" class="nav-link" data-scroll-target="#predicting-survival-for-specific-patients"><span class="header-section-number">10.10</span> Predicting Survival for Specific Patients</a></li>
  </ul></li>
  <li><a href="#practice-exercises" id="toc-practice-exercises" class="nav-link" data-scroll-target="#practice-exercises"><span class="header-section-number">11</span> Practice Exercises</a>
  <ul class="collapse">
  <li><a href="#exercise-1-the-lung-cancer-dataset" id="toc-exercise-1-the-lung-cancer-dataset" class="nav-link" data-scroll-target="#exercise-1-the-lung-cancer-dataset"><span class="header-section-number">11.1</span> Exercise 1: The Lung Cancer Dataset</a>
  <ul class="collapse">
  <li><a href="#task-1a-recode-the-status-variable" id="toc-task-1a-recode-the-status-variable" class="nav-link" data-scroll-target="#task-1a-recode-the-status-variable"><span class="header-section-number">11.1.1</span> Task 1a: Recode the status variable</a></li>
  <li><a href="#task-1b-create-a-kaplan-meier-curve-by-sex" id="toc-task-1b-create-a-kaplan-meier-curve-by-sex" class="nav-link" data-scroll-target="#task-1b-create-a-kaplan-meier-curve-by-sex"><span class="header-section-number">11.1.2</span> Task 1b: Create a Kaplan-Meier curve by sex</a></li>
  <li><a href="#task-1c-test-for-differences-and-fit-a-cox-model" id="toc-task-1c-test-for-differences-and-fit-a-cox-model" class="nav-link" data-scroll-target="#task-1c-test-for-differences-and-fit-a-cox-model"><span class="header-section-number">11.1.3</span> Task 1c: Test for differences and fit a Cox model</a></li>
  </ul></li>
  <li><a href="#exercise-2-the-colon-cancer-dataset" id="toc-exercise-2-the-colon-cancer-dataset" class="nav-link" data-scroll-target="#exercise-2-the-colon-cancer-dataset"><span class="header-section-number">11.2</span> Exercise 2: The Colon Cancer Dataset</a>
  <ul class="collapse">
  <li><a href="#task-2a-compare-survival-by-treatment" id="toc-task-2a-compare-survival-by-treatment" class="nav-link" data-scroll-target="#task-2a-compare-survival-by-treatment"><span class="header-section-number">11.2.1</span> Task 2a: Compare survival by treatment</a></li>
  <li><a href="#task-2b-fit-a-multivariable-cox-model" id="toc-task-2b-fit-a-multivariable-cox-model" class="nav-link" data-scroll-target="#task-2b-fit-a-multivariable-cox-model"><span class="header-section-number">11.2.2</span> Task 2b: Fit a multivariable Cox model</a></li>
  </ul></li>
  <li><a href="#exercise-3-the-aml-dataset" id="toc-exercise-3-the-aml-dataset" class="nav-link" data-scroll-target="#exercise-3-the-aml-dataset"><span class="header-section-number">11.3</span> Exercise 3: The AML Dataset</a>
  <ul class="collapse">
  <li><a href="#task-3a-calculate-median-survival-by-group" id="toc-task-3a-calculate-median-survival-by-group" class="nav-link" data-scroll-target="#task-3a-calculate-median-survival-by-group"><span class="header-section-number">11.3.1</span> Task 3a: Calculate median survival by group</a></li>
  <li><a href="#task-3b-estimate-survival-probability-at-30-weeks" id="toc-task-3b-estimate-survival-probability-at-30-weeks" class="nav-link" data-scroll-target="#task-3b-estimate-survival-probability-at-30-weeks"><span class="header-section-number">11.3.2</span> Task 3b: Estimate survival probability at 30 weeks</a></li>
  </ul></li>
  <li><a href="#exercise-4-cox-modelling-with-the-veteran-dataset" id="toc-exercise-4-cox-modelling-with-the-veteran-dataset" class="nav-link" data-scroll-target="#exercise-4-cox-modelling-with-the-veteran-dataset"><span class="header-section-number">11.4</span> Exercise 4: Cox Modelling with the Veteran Dataset</a>
  <ul class="collapse">
  <li><a href="#task-4a-fit-a-cox-model" id="toc-task-4a-fit-a-cox-model" class="nav-link" data-scroll-target="#task-4a-fit-a-cox-model"><span class="header-section-number">11.4.1</span> Task 4a: Fit a Cox model</a></li>
  </ul></li>
  <li><a href="#exercise-5-interpretation-questions" id="toc-exercise-5-interpretation-questions" class="nav-link" data-scroll-target="#exercise-5-interpretation-questions"><span class="header-section-number">11.5</span> Exercise 5: Interpretation Questions</a>
  <ul class="collapse">
  <li><a href="#question-5a" id="toc-question-5a" class="nav-link" data-scroll-target="#question-5a"><span class="header-section-number">11.5.1</span> Question 5a</a></li>
  <li><a href="#question-5b" id="toc-question-5b" class="nav-link" data-scroll-target="#question-5b"><span class="header-section-number">11.5.2</span> Question 5b</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">12</span> Summary</a></li>
  <li><a href="#session-information" id="toc-session-information" class="nav-link" data-scroll-target="#session-information"><span class="header-section-number">13</span> Session Information</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Survival Analysis in R: A Practical Tutorial</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Using Scottish Metastatic Breast Cancer Data</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Edinburgh Cancer Informatics Group </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 5, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This tutorial provides a practical introduction to survival analysis using R, illustrated with a synthetic cohort of patients with metastatic breast cancer from Scottish NHS Health Boards. By the end of this tutorial, you will be able to:</p>
<ul>
<li>Create and interpret survival objects</li>
<li>Fit and visualise Kaplan-Meier survival curves</li>
<li>Conduct log-rank tests to compare survival between groups</li>
<li>Fit Cox proportional hazards regression models</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About the Data
</div>
</div>
<div class="callout-body-container callout-body">
<p>The dataset used in this tutorial is <strong>entirely synthetic</strong> and was generated for educational purposes. It does not contain any real patient data but has been designed to reflect realistic patterns seen in metastatic breast cancer populations.</p>
</div>
</div>
</section>
<section id="why-survival-analysis" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Why Survival Analysis?</h1>
<p>Before diving into the methods, it’s worth understanding why we need specialised techniques for time-to-event data.</p>
<section id="the-problem-with-standard-methods" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="the-problem-with-standard-methods"><span class="header-section-number">2.1</span> The Problem with Standard Methods</h2>
<p>Imagine you’re analysing a clinical trial where patients were followed for up to 5 years. At the end of the study, some patients have died, but others are still alive. If you simply calculate the proportion who died, you’re ignoring valuable information — patients who were still alive contributed follow-up time showing they <em>survived at least that long</em>.</p>
<p>This is the problem of <strong>censoring</strong>. A patient is censored when we know they survived up to a certain point, but we don’t know what happened after that. Common reasons for censoring include: - The study ended while the patient was still alive - The patient was lost to follow-up - The patient withdrew from the study</p>
</section>
<section id="what-happens-if-we-ignore-censoring" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="what-happens-if-we-ignore-censoring"><span class="header-section-number">2.2</span> What Happens If We Ignore Censoring?</h2>
<p>Consider a simple example with 10 patients. Five died during follow-up, three were still alive when the study ended (censored), and two were lost to follow-up (also censored).</p>
<p>If we naively calculate survival as “proportion who didn’t die”, we might include the censored patients in the denominator as if they were followed for the entire study period. This <strong>overestimates survival</strong> because we’re treating patients with incomplete follow-up as if they definitely survived.</p>
<p>Conversely, if we calculate median survival time only among those who died, we <strong>underestimate</strong> it because we’re excluding patients who survived longer but were censored.</p>
<p>Survival analysis methods — particularly the Kaplan-Meier estimator — correctly account for censored observations by including each patient’s follow-up time in the analysis up until the point they were censored.</p>
</section>
<section id="key-concepts" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="key-concepts"><span class="header-section-number">2.3</span> Key Concepts</h2>
<p><strong>Survival function S(t)</strong>: The probability of surviving beyond time <em>t</em>. It starts at 1 (everyone alive at time 0) and decreases over time.</p>
<p><strong>Hazard</strong>: The instantaneous risk of the event occurring at time <em>t</em>, given that the individual has survived up to that point. Think of it as the “danger” at each moment.</p>
<p><strong>Censoring</strong>: When we have incomplete information about a patient’s outcome. Most commonly “right-censoring” — we know the patient survived <em>at least</em> until a certain time, but not what happened afterwards.</p>
<p><strong>Proportional hazards</strong>: The assumption (used in Cox regression) that the ratio of hazards between groups remains constant over time. This doesn’t mean hazards are constant — they can both increase or decrease — but their <em>ratio</em> stays the same.</p>
</section>
<section id="the-non-informative-censoring-assumption" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="the-non-informative-censoring-assumption"><span class="header-section-number">2.4</span> The Non-Informative Censoring Assumption</h2>
<p>Most survival methods assume <strong>non-informative censoring</strong> — that a patient’s censoring time is unrelated to their underlying survival time. If this assumption is violated, survival estimates can be biased.</p>
<p><strong>Examples of potentially informative censoring:</strong></p>
<ul>
<li>Sicker patients drop out of a study because they feel too unwell to attend appointments → survival estimates biased upward (look better than reality)</li>
<li>Patients who are doing well stop attending follow-up because they feel they don’t need it → survival estimates biased downward</li>
<li>Patients with severe side effects withdraw from a treatment trial → treatment effect estimates biased</li>
</ul>
<p>When designing or analysing a study, carefully consider whether reasons for censoring might be related to prognosis. If informative censoring is suspected, sensitivity analyses or specialised methods may be needed.</p>
</section>
</section>
<section id="loading-the-data" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Loading the Data</h1>
<p>We begin by loading our synthetic Scottish metastatic breast cancer cohort from the Excel file.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"scottish_mbc_cohort.xlsx"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview the data structure</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(mbc_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 850
Columns: 21
$ patient_id           &lt;chr&gt; "MBC0001", "MBC0002", "MBC0003", "MBC0004", "MBC0…
$ health_board         &lt;chr&gt; "NHS Highland", "NHS Lothian", "NHS Tayside", "NH…
$ age_at_diagnosis     &lt;dbl&gt; 58, 80, 45, 72, 79, 87, 79, 74, 51, 74, 74, 42, 5…
$ sex                  &lt;chr&gt; "Female", "Female", "Female", "Female", "Female",…
$ simd_quintile        &lt;dbl&gt; 1, 4, 2, 4, 2, 1, 3, 1, 3, 4, 1, 1, 5, 1, 1, 4, 4…
$ ecog_ps              &lt;dbl&gt; 0, 1, 0, 2, 0, 0, 3, 3, 1, 0, 2, 1, 0, 1, 2, 1, 0…
$ er_status            &lt;chr&gt; "Negative", "Negative", "Negative", "Negative", "…
$ pr_status            &lt;chr&gt; "Negative", "Negative", "Negative", "Negative", "…
$ her2_status          &lt;chr&gt; "Negative", "Negative", "Negative", "Negative", "…
$ n_metastatic_sites   &lt;dbl&gt; 1, 1, 2, 1, 1, 2, 2, 3, 2, 1, 1, 4, 5, 2, 4, 4, 2…
$ bone_mets            &lt;chr&gt; "Yes", "No", "Yes", "No", "No", "Yes", "Yes", "Ye…
$ liver_mets           &lt;chr&gt; "Yes", "No", "No", "No", "No", "No", "No", "Yes",…
$ lung_mets            &lt;chr&gt; "No", "No", "No", "Yes", "Yes", "No", "No", "Yes"…
$ brain_mets           &lt;chr&gt; "No", "No", "No", "No", "No", "Yes", "No", "No", …
$ presentation         &lt;chr&gt; "De novo metastatic", "Recurrent", "Recurrent", "…
$ diagnosis_date       &lt;dttm&gt; 2020-03-01, 2022-11-11, 2021-07-25, 2022-05-21, …
$ first_line_treatment &lt;chr&gt; "Chemotherapy", "Chemotherapy", "Chemotherapy", "…
$ observed_time        &lt;dbl&gt; 40.8, 13.6, 9.2, 0.5, 4.8, 37.3, 13.7, 17.6, 11.1…
$ status               &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1…
$ age_group            &lt;chr&gt; "50-64", "75+", "&lt;50", "65-74", "75+", "75+", "75…
$ hormone_receptor     &lt;chr&gt; "HR-negative", "HR-negative", "HR-negative", "HR-…</code></pre>
</div>
</div>
<p>The dataset contains 850 patients diagnosed between 2018-01-05 and 2022-12-28 across all 14 Scottish NHS Health Boards.</p>
<section id="calculating-survival-times-from-dates" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="calculating-survival-times-from-dates"><span class="header-section-number">3.1</span> Calculating Survival Times from Dates</h2>
<p>In practice, clinical data often comes with dates rather than pre-calculated survival times. Here’s how to calculate follow-up time from diagnosis and last contact dates using the <code>lubridate</code> package.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Creating survival times from dates</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>date_example <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">patient_id =</span> <span class="fu">c</span>(<span class="st">"P001"</span>, <span class="st">"P002"</span>, <span class="st">"P003"</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">diagnosis_date =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2020-03-15"</span>, <span class="st">"2019-08-22"</span>, <span class="st">"2021-01-10"</span>)),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">last_contact_date =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2023-06-20"</span>, <span class="st">"2022-04-15"</span>, <span class="st">"2023-12-31"</span>)),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">status =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># 1 = died, 0 = alive/censored</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate follow-up time in months</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>date_example <span class="ot">&lt;-</span> date_example <span class="sc">|&gt;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">follow_up_months =</span> <span class="fu">as.numeric</span>(</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">difftime</span>(last_contact_date, diagnosis_date, <span class="at">units =</span> <span class="st">"days"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">/</span> <span class="fl">30.44</span>  <span class="co"># average days per month</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>date_example <span class="sc">|&gt;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 22%">
<col style="width: 26%">
<col style="width: 10%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">patient_id</th>
<th style="text-align: left;">diagnosis_date</th>
<th style="text-align: left;">last_contact_date</th>
<th style="text-align: right;">status</th>
<th style="text-align: right;">follow_up_months</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">P001</td>
<td style="text-align: left;">2020-03-15</td>
<td style="text-align: left;">2023-06-20</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">39.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">P002</td>
<td style="text-align: left;">2019-08-22</td>
<td style="text-align: left;">2022-04-15</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">31.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">P003</td>
<td style="text-align: left;">2021-01-10</td>
<td style="text-align: left;">2023-12-31</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">35.6</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Time Units
</div>
</div>
<div class="callout-body-container callout-body">
<p>Choose time units appropriate for your disease. For aggressive cancers like metastatic breast cancer, months are sensible. For slow-growing conditions, years might be better. Whatever you choose, be consistent throughout your analysis.</p>
</div>
</div>
</section>
</section>
<section id="patient-characteristics" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Patient Characteristics</h1>
<p>Before conducting survival analysis, it is essential to understand the composition of our cohort. We present descriptive statistics stratified by hormone receptor status.</p>
<section id="summary-table" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="summary-table"><span class="header-section-number">4.1</span> Summary Table</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create summary table</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">simd_quintile =</span> <span class="fu">factor</span>(simd_quintile),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">ecog_ps =</span> <span class="fu">factor</span>(ecog_ps),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> <span class="fu">factor</span>(status, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Censored"</span>, <span class="st">"Died"</span>))</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    hormone_receptor, age_at_diagnosis, age_group, sex, simd_quintile, ecog_ps,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    er_status, pr_status, her2_status,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    n_metastatic_sites, bone_mets, liver_mets, lung_mets, brain_mets,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    presentation, first_line_treatment, observed_time, status</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> hormone_receptor,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="fu">list</span>(</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="st">"{median} ({p25}, {p75})"</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all_categorical</span>() <span class="sc">~</span> <span class="st">"{n} ({p}%)"</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">digits =</span> <span class="fu">list</span>(<span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing =</span> <span class="st">"ifany"</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_overall</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-characteristics" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-characteristics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Patient characteristics by hormone receptor status
</figcaption>
<div aria-describedby="tbl-characteristics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="foivgihkks" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#foivgihkks table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#foivgihkks thead, #foivgihkks tbody, #foivgihkks tfoot, #foivgihkks tr, #foivgihkks td, #foivgihkks th {
  border-style: none;
}

#foivgihkks p {
  margin: 0;
  padding: 0;
}

#foivgihkks .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#foivgihkks .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#foivgihkks .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#foivgihkks .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#foivgihkks .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#foivgihkks .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#foivgihkks .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#foivgihkks .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#foivgihkks .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#foivgihkks .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#foivgihkks .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#foivgihkks .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#foivgihkks .gt_spanner_row {
  border-bottom-style: hidden;
}

#foivgihkks .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#foivgihkks .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#foivgihkks .gt_from_md > :first-child {
  margin-top: 0;
}

#foivgihkks .gt_from_md > :last-child {
  margin-bottom: 0;
}

#foivgihkks .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#foivgihkks .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#foivgihkks .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#foivgihkks .gt_row_group_first td {
  border-top-width: 2px;
}

#foivgihkks .gt_row_group_first th {
  border-top-width: 2px;
}

#foivgihkks .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#foivgihkks .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#foivgihkks .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#foivgihkks .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#foivgihkks .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#foivgihkks .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#foivgihkks .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#foivgihkks .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#foivgihkks .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#foivgihkks .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#foivgihkks .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#foivgihkks .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#foivgihkks .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#foivgihkks .gt_left {
  text-align: left;
}

#foivgihkks .gt_center {
  text-align: center;
}

#foivgihkks .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#foivgihkks .gt_font_normal {
  font-weight: normal;
}

#foivgihkks .gt_font_bold {
  font-weight: bold;
}

#foivgihkks .gt_font_italic {
  font-style: italic;
}

#foivgihkks .gt_super {
  font-size: 65%;
}

#foivgihkks .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#foivgihkks .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#foivgihkks .gt_indent_1 {
  text-indent: 5px;
}

#foivgihkks .gt_indent_2 {
  text-indent: 10px;
}

#foivgihkks .gt_indent_3 {
  text-indent: 15px;
}

#foivgihkks .gt_indent_4 {
  text-indent: 20px;
}

#foivgihkks .gt_indent_5 {
  text-indent: 25px;
}

#foivgihkks .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#foivgihkks div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="gt_col_headings header">
<th id="label" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="stat_0" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>Overall</strong><br>
N = 850<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>1</sup></span></th>
<th id="stat_1" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR-negative</strong><br>
N = 192<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>1</sup></span></th>
<th id="stat_2" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR-positive</strong><br>
N = 658<span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>1</sup></span></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">age_at_diagnosis</td>
<td class="gt_row gt_center" headers="stat_0">61.0 (54.0, 70.0)</td>
<td class="gt_row gt_center" headers="stat_1">61.0 (55.0, 69.0)</td>
<td class="gt_row gt_center" headers="stat_2">61.0 (54.0, 70.0)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">age_group</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;&lt;50</td>
<td class="gt_row gt_center" headers="stat_0">123 (14%)</td>
<td class="gt_row gt_center" headers="stat_1">24 (13%)</td>
<td class="gt_row gt_center" headers="stat_2">99 (15%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;50-64</td>
<td class="gt_row gt_center" headers="stat_0">396 (47%)</td>
<td class="gt_row gt_center" headers="stat_1">95 (49%)</td>
<td class="gt_row gt_center" headers="stat_2">301 (46%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;65-74</td>
<td class="gt_row gt_center" headers="stat_0">210 (25%)</td>
<td class="gt_row gt_center" headers="stat_1">46 (24%)</td>
<td class="gt_row gt_center" headers="stat_2">164 (25%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;75+</td>
<td class="gt_row gt_center" headers="stat_0">121 (14%)</td>
<td class="gt_row gt_center" headers="stat_1">27 (14%)</td>
<td class="gt_row gt_center" headers="stat_2">94 (14%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">sex</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Female</td>
<td class="gt_row gt_center" headers="stat_0">842 (99%)</td>
<td class="gt_row gt_center" headers="stat_1">187 (97%)</td>
<td class="gt_row gt_center" headers="stat_2">655 (100%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Male</td>
<td class="gt_row gt_center" headers="stat_0">8 (0.9%)</td>
<td class="gt_row gt_center" headers="stat_1">5 (2.6%)</td>
<td class="gt_row gt_center" headers="stat_2">3 (0.5%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">simd_quintile</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td class="gt_row gt_center" headers="stat_0">204 (24%)</td>
<td class="gt_row gt_center" headers="stat_1">45 (23%)</td>
<td class="gt_row gt_center" headers="stat_2">159 (24%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;2</td>
<td class="gt_row gt_center" headers="stat_0">208 (24%)</td>
<td class="gt_row gt_center" headers="stat_1">44 (23%)</td>
<td class="gt_row gt_center" headers="stat_2">164 (25%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;3</td>
<td class="gt_row gt_center" headers="stat_0">155 (18%)</td>
<td class="gt_row gt_center" headers="stat_1">38 (20%)</td>
<td class="gt_row gt_center" headers="stat_2">117 (18%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;4</td>
<td class="gt_row gt_center" headers="stat_0">153 (18%)</td>
<td class="gt_row gt_center" headers="stat_1">33 (17%)</td>
<td class="gt_row gt_center" headers="stat_2">120 (18%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;5</td>
<td class="gt_row gt_center" headers="stat_0">130 (15%)</td>
<td class="gt_row gt_center" headers="stat_1">32 (17%)</td>
<td class="gt_row gt_center" headers="stat_2">98 (15%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">ecog_ps</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;0</td>
<td class="gt_row gt_center" headers="stat_0">248 (29%)</td>
<td class="gt_row gt_center" headers="stat_1">49 (26%)</td>
<td class="gt_row gt_center" headers="stat_2">199 (30%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td class="gt_row gt_center" headers="stat_0">348 (41%)</td>
<td class="gt_row gt_center" headers="stat_1">87 (45%)</td>
<td class="gt_row gt_center" headers="stat_2">261 (40%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;2</td>
<td class="gt_row gt_center" headers="stat_0">192 (23%)</td>
<td class="gt_row gt_center" headers="stat_1">38 (20%)</td>
<td class="gt_row gt_center" headers="stat_2">154 (23%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;3</td>
<td class="gt_row gt_center" headers="stat_0">62 (7.3%)</td>
<td class="gt_row gt_center" headers="stat_1">18 (9.4%)</td>
<td class="gt_row gt_center" headers="stat_2">44 (6.7%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">er_status</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Negative</td>
<td class="gt_row gt_center" headers="stat_0">225 (26%)</td>
<td class="gt_row gt_center" headers="stat_1">192 (100%)</td>
<td class="gt_row gt_center" headers="stat_2">33 (5.0%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Positive</td>
<td class="gt_row gt_center" headers="stat_0">625 (74%)</td>
<td class="gt_row gt_center" headers="stat_1">0 (0%)</td>
<td class="gt_row gt_center" headers="stat_2">625 (95%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">pr_status</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Negative</td>
<td class="gt_row gt_center" headers="stat_0">275 (32%)</td>
<td class="gt_row gt_center" headers="stat_1">192 (100%)</td>
<td class="gt_row gt_center" headers="stat_2">83 (13%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Positive</td>
<td class="gt_row gt_center" headers="stat_0">575 (68%)</td>
<td class="gt_row gt_center" headers="stat_1">0 (0%)</td>
<td class="gt_row gt_center" headers="stat_2">575 (87%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">her2_status</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Negative</td>
<td class="gt_row gt_center" headers="stat_0">699 (82%)</td>
<td class="gt_row gt_center" headers="stat_1">164 (85%)</td>
<td class="gt_row gt_center" headers="stat_2">535 (81%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Positive</td>
<td class="gt_row gt_center" headers="stat_0">151 (18%)</td>
<td class="gt_row gt_center" headers="stat_1">28 (15%)</td>
<td class="gt_row gt_center" headers="stat_2">123 (19%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">n_metastatic_sites</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td class="gt_row gt_center" headers="stat_0">307 (36%)</td>
<td class="gt_row gt_center" headers="stat_1">66 (34%)</td>
<td class="gt_row gt_center" headers="stat_2">241 (37%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;2</td>
<td class="gt_row gt_center" headers="stat_0">242 (28%)</td>
<td class="gt_row gt_center" headers="stat_1">64 (33%)</td>
<td class="gt_row gt_center" headers="stat_2">178 (27%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;3</td>
<td class="gt_row gt_center" headers="stat_0">161 (19%)</td>
<td class="gt_row gt_center" headers="stat_1">37 (19%)</td>
<td class="gt_row gt_center" headers="stat_2">124 (19%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;4</td>
<td class="gt_row gt_center" headers="stat_0">106 (12%)</td>
<td class="gt_row gt_center" headers="stat_1">18 (9.4%)</td>
<td class="gt_row gt_center" headers="stat_2">88 (13%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;5</td>
<td class="gt_row gt_center" headers="stat_0">34 (4.0%)</td>
<td class="gt_row gt_center" headers="stat_1">7 (3.6%)</td>
<td class="gt_row gt_center" headers="stat_2">27 (4.1%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">bone_mets</td>
<td class="gt_row gt_center" headers="stat_0">624 (73%)</td>
<td class="gt_row gt_center" headers="stat_1">149 (78%)</td>
<td class="gt_row gt_center" headers="stat_2">475 (72%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">liver_mets</td>
<td class="gt_row gt_center" headers="stat_0">307 (36%)</td>
<td class="gt_row gt_center" headers="stat_1">69 (36%)</td>
<td class="gt_row gt_center" headers="stat_2">238 (36%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">lung_mets</td>
<td class="gt_row gt_center" headers="stat_0">260 (31%)</td>
<td class="gt_row gt_center" headers="stat_1">53 (28%)</td>
<td class="gt_row gt_center" headers="stat_2">207 (31%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">brain_mets</td>
<td class="gt_row gt_center" headers="stat_0">90 (11%)</td>
<td class="gt_row gt_center" headers="stat_1">21 (11%)</td>
<td class="gt_row gt_center" headers="stat_2">69 (10%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">presentation</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;De novo metastatic</td>
<td class="gt_row gt_center" headers="stat_0">250 (29%)</td>
<td class="gt_row gt_center" headers="stat_1">62 (32%)</td>
<td class="gt_row gt_center" headers="stat_2">188 (29%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Recurrent</td>
<td class="gt_row gt_center" headers="stat_0">600 (71%)</td>
<td class="gt_row gt_center" headers="stat_1">130 (68%)</td>
<td class="gt_row gt_center" headers="stat_2">470 (71%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">first_line_treatment</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Chemo + Targeted</td>
<td class="gt_row gt_center" headers="stat_0">105 (12%)</td>
<td class="gt_row gt_center" headers="stat_1">26 (14%)</td>
<td class="gt_row gt_center" headers="stat_2">79 (12%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Chemotherapy</td>
<td class="gt_row gt_center" headers="stat_0">284 (33%)</td>
<td class="gt_row gt_center" headers="stat_1">166 (86%)</td>
<td class="gt_row gt_center" headers="stat_2">118 (18%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Endocrine + Targeted</td>
<td class="gt_row gt_center" headers="stat_0">339 (40%)</td>
<td class="gt_row gt_center" headers="stat_1">0 (0%)</td>
<td class="gt_row gt_center" headers="stat_2">339 (52%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Endocrine only</td>
<td class="gt_row gt_center" headers="stat_0">122 (14%)</td>
<td class="gt_row gt_center" headers="stat_1">0 (0%)</td>
<td class="gt_row gt_center" headers="stat_2">122 (19%)</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">observed_time</td>
<td class="gt_row gt_center" headers="stat_0">13.2 (5.6, 23.4)</td>
<td class="gt_row gt_center" headers="stat_1">8.6 (4.4, 17.3)</td>
<td class="gt_row gt_center" headers="stat_2">14.6 (6.5, 25.4)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">status</td>
<td class="gt_row gt_center" headers="stat_0"><br>
</td>
<td class="gt_row gt_center" headers="stat_1"><br>
</td>
<td class="gt_row gt_center" headers="stat_2"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Censored</td>
<td class="gt_row gt_center" headers="stat_0">147 (17%)</td>
<td class="gt_row gt_center" headers="stat_1">16 (8.3%)</td>
<td class="gt_row gt_center" headers="stat_2">131 (20%)</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Died</td>
<td class="gt_row gt_center" headers="stat_0">703 (83%)</td>
<td class="gt_row gt_center" headers="stat_1">176 (92%)</td>
<td class="gt_row gt_center" headers="stat_2">527 (80%)</td>
</tr>
</tbody><tfoot class="gt_footnotes">
<tr class="odd">
<td colspan="4" class="gt_footnote"><span class="gt_footnote_marks" style="white-space:nowrap;font-style:italic;font-weight:normal;line-height:0;"><sup>1</sup></span> Median (Q1, Q3); n (%)</td>
</tr>
</tfoot>

</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="distribution-by-health-board" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="distribution-by-health-board"><span class="header-section-number">4.2</span> Distribution by Health Board</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(health_board) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">health_board =</span> <span class="fu">fct_reorder</span>(health_board, n)) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">y =</span> health_board, <span class="at">fill =</span> n)) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> n), <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.2</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"plasma"</span>, <span class="at">end =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.15</span>))) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Number of patients"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Patient distribution by NHS Health Board"</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-healthboard" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-healthboard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="survival_analysis_tutorial_files/figure-html/fig-healthboard-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-healthboard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Patient distribution across Scottish NHS Health Boards
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="creating-a-survival-object" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Creating a Survival Object</h1>
<p>The foundation of survival analysis in R is the <code>Surv()</code> function from the <code>survival</code> package. This function creates a special object that encodes both the time-to-event and the censoring indicator.</p>
<section id="understanding-censoring" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="understanding-censoring"><span class="header-section-number">5.1</span> Understanding Censoring</h2>
<p>In our dataset:</p>
<ul>
<li><code>observed_time</code>: Time from diagnosis to death or last follow-up (months)</li>
<li><code>status</code>: Event indicator (1 = death occurred, 0 = censored/alive)</li>
</ul>
<p>Censoring occurs when we do not observe the event of interest. In this study, patients are censored if they were still alive at the end of the study period.</p>
</section>
<section id="creating-the-survival-object" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="creating-the-survival-object"><span class="header-section-number">5.2</span> Creating the Survival Object</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the survival object</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>surv_obj <span class="ot">&lt;-</span> <span class="fu">Surv</span>(<span class="at">time =</span> mbc_data<span class="sc">$</span>observed_time, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">event =</span> mbc_data<span class="sc">$</span>status)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the first 20 observations</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(surv_obj, <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 40.8  13.6+  9.2   0.5   4.8  37.3  13.7+ 17.6  11.1  13.5   9.5   2.3 
[13] 30.8  15.6+ 18.2  20.6   2.6   7.0  16.8  11.9 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpreting the Output
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the survival object:</p>
<ul>
<li>Numbers without a <code>+</code> indicate observed events (deaths)</li>
<li>Numbers with a <code>+</code> indicate censored observations (patient was alive at that time)</li>
</ul>
</div>
</div>
</section>
</section>
<section id="kaplan-meier-survival-estimation" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Kaplan-Meier Survival Estimation</h1>
<p>The Kaplan-Meier (KM) estimator is a non-parametric method for estimating the survival function from observed survival times.</p>
<section id="fitting-the-km-curve" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="fitting-the-km-curve"><span class="header-section-number">6.1</span> Fitting the KM Curve</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Kaplan-Meier estimator for the entire cohort</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>km_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> mbc_data)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the KM fit</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km_fit, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">36</span>, <span class="dv">48</span>, <span class="dv">60</span>), <span class="at">extend =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(observed_time, status) ~ 1, data = mbc_data)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    6    626     226   0.7341  0.0152       0.7050       0.7644
   12    463     163   0.5424  0.0171       0.5099       0.5769
   24    207     184   0.3031  0.0164       0.2725       0.3371
   36     94      76   0.1790  0.0147       0.1523       0.2104
   48     27      44   0.0824  0.0124       0.0614       0.1106
   60      9       8   0.0515  0.0117       0.0330       0.0804</code></pre>
</div>
</div>
<p>The output shows survival probabilities at specific time points with 95% confidence intervals.</p>
</section>
<section id="plotting-the-overall-survival-curve" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="plotting-the-overall-survival-curve"><span class="header-section-number">6.2</span> Plotting the Overall Survival Curve</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  km_fit,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.col =</span> <span class="st">"strata"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.height =</span> <span class="fl">0.25</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival in Metastatic Breast Cancer"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="st">"#2E86AB"</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv.median.line =</span> <span class="st">"hv"</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-km-overall" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-km-overall-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="survival_analysis_tutorial_files/figure-html/fig-km-overall-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-km-overall-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Overall survival in the Scottish metastatic breast cancer cohort
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="median-survival-time" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="median-survival-time"><span class="header-section-number">6.3</span> Median Survival Time</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract median survival with confidence interval</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>surv_median <span class="ot">&lt;-</span> <span class="fu">surv_median</span>(km_fit)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>surv_median <span class="sc">|&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Strata"</span>, <span class="st">"Median"</span>, <span class="st">"Lower 95% CI"</span>, <span class="st">"Upper 95% CI"</span>),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">digits =</span> <span class="dv">1</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Median overall survival (months)"</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Median overall survival (months)</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Strata</th>
<th style="text-align: right;">Median</th>
<th style="text-align: right;">Lower 95% CI</th>
<th style="text-align: right;">Upper 95% CI</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">All</td>
<td style="text-align: right;">13.3</td>
<td style="text-align: right;">12.3</td>
<td style="text-align: right;">15.1</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The median survival time is the time at which 50% of patients have experienced the event. It’s the preferred measure of “average” survival because survival times are typically skewed — a few long survivors can dramatically inflate the mean.</p>
</section>
<section id="estimating-survival-at-specific-time-points" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="estimating-survival-at-specific-time-points"><span class="header-section-number">6.4</span> Estimating Survival at Specific Time Points</h2>
<p>Often we want to report survival probability at clinically meaningful time points, such as 1-year or 2-year survival.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get survival estimates at specific times</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>time_points <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">36</span>, <span class="dv">48</span>, <span class="dv">60</span>)  <span class="co"># months</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>surv_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(km_fit, <span class="at">times =</span> time_points, <span class="at">extend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a nice table</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Time (months)</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>time,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">N at risk</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>n.risk,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Survival probability</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>surv,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">95% CI lower</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>lower,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">95% CI upper</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>upper</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Survival (95% CI)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%% (%.1f%%-%.1f%%)"</span>, </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">`</span><span class="at">Survival probability</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">`</span><span class="at">95% CI lower</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">`</span><span class="at">95% CI upper</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">Time (months)</span><span class="st">`</span>, <span class="st">`</span><span class="at">N at risk</span><span class="st">`</span>, <span class="st">`</span><span class="at">Survival (95% CI)</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">Time (months)</th>
<th style="text-align: right;">N at risk</th>
<th style="text-align: left;">Survival (95% CI)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">12</td>
<td style="text-align: right;">463</td>
<td style="text-align: left;">54.2% (51.0%-57.7%)</td>
</tr>
<tr class="even">
<td style="text-align: right;">24</td>
<td style="text-align: right;">207</td>
<td style="text-align: left;">30.3% (27.3%-33.7%)</td>
</tr>
<tr class="odd">
<td style="text-align: right;">36</td>
<td style="text-align: right;">94</td>
<td style="text-align: left;">17.9% (15.2%-21.0%)</td>
</tr>
<tr class="even">
<td style="text-align: right;">48</td>
<td style="text-align: right;">27</td>
<td style="text-align: left;">8.2% (6.1%-11.1%)</td>
</tr>
<tr class="odd">
<td style="text-align: right;">60</td>
<td style="text-align: right;">9</td>
<td style="text-align: left;">5.2% (3.3%-8.0%)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Don’t Ignore Censoring!
</div>
</div>
<div class="callout-body-container callout-body">
<p>A common mistake is to calculate survival as simply “number who didn’t die / total number”. This ignores censoring and will give you biased estimates. Always use proper survival analysis methods like Kaplan-Meier.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The <code>extend</code> Argument
</div>
</div>
<div class="callout-body-container callout-body">
<p>When using <code>summary()</code> on a survfit object with specific time points, you may encounter an error if a requested time exceeds the maximum follow-up in your data. Setting <code>extend = TRUE</code> allows the function to return the last known survival estimate for times beyond the data — essentially assuming no further events occurred.</p>
</div>
</div>
</section>
</section>
<section id="survival-curves-by-subgroups" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Survival Curves by Subgroups</h1>
<p>One of the most common uses of KM analysis is comparing survival between different patient groups.</p>
<section id="by-hormone-receptor-status" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="by-hormone-receptor-status"><span class="header-section-number">7.1</span> By Hormone Receptor Status</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>km_hr <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> hormone_receptor, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> mbc_data)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  km_hr,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.height =</span> <span class="fl">0.30</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by Hormone Receptor Status"</span>,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"HR Status"</span>,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"HR-negative"</span>, <span class="st">"HR-positive"</span>),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#E74C3C"</span>, <span class="st">"#3498DB"</span>),</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-km-hr" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-km-hr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="survival_analysis_tutorial_files/figure-html/fig-km-hr-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-km-hr-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Survival by hormone receptor status
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="by-ecog-performance-status" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="by-ecog-performance-status"><span class="header-section-number">7.2</span> By ECOG Performance Status</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>km_ecog <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> ecog_ps, </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mbc_data)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  km_ecog,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.height =</span> <span class="fl">0.35</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by ECOG Performance Status"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"ECOG PS"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="st">"jco"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-km-ecog" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-km-ecog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="survival_analysis_tutorial_files/figure-html/fig-km-ecog-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-km-ecog-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Survival by ECOG performance status
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="by-number-of-metastatic-sites" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="by-number-of-metastatic-sites"><span class="header-section-number">7.3</span> By Number of Metastatic Sites</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create grouped metastatic sites variable</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">mets_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>      n_metastatic_sites <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"1 site"</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>      n_metastatic_sites <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"2 sites"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      n_metastatic_sites <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"3+ sites"</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"1 site"</span>, <span class="st">"2 sites"</span>, <span class="st">"3+ sites"</span>))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>km_mets <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> mets_group, </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mbc_data)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  km_mets,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.height =</span> <span class="fl">0.30</span>,</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by Number of Metastatic Sites"</span>,</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"Metastatic Sites"</span>,</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#27AE60"</span>, <span class="st">"#F39C12"</span>, <span class="st">"#C0392B"</span>),</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-km-mets" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-km-mets-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="survival_analysis_tutorial_files/figure-html/fig-km-mets-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-km-mets-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Survival by number of metastatic sites
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="hazard-functions" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Hazard Functions</h1>
<p>While survival curves show the probability of surviving beyond time <em>t</em>, hazard functions show the instantaneous rate of the event occurring at time <em>t</em>, given survival up to that point.</p>
<section id="cumulative-hazard-function" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="cumulative-hazard-function"><span class="header-section-number">8.1</span> Cumulative Hazard Function</h2>
<p>The cumulative hazard function, <span class="math inline">\(H(t)\)</span>, represents the accumulated risk up to time <em>t</em>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  km_hr,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> <span class="st">"cumhaz"</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Cumulative hazard"</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Cumulative Hazard by Hormone Receptor Status"</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"HR Status"</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"HR-negative"</span>, <span class="st">"HR-positive"</span>),</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#E74C3C"</span>, <span class="st">"#3498DB"</span>),</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-cumhaz" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cumhaz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="survival_analysis_tutorial_files/figure-html/fig-cumhaz-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cumhaz-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Cumulative hazard function by hormone receptor status
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="smoothed-hazard-function" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="smoothed-hazard-function"><span class="header-section-number">8.2</span> Smoothed Hazard Function</h2>
<p>To visualise the instantaneous hazard rate, we can use kernel smoothing methods.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using muhaz package for smoothed hazard estimation</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(muhaz)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate smoothed hazard for each HR group</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>hr_pos_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(hormone_receptor <span class="sc">==</span> <span class="st">"HR-positive"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>hr_neg_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(hormone_receptor <span class="sc">==</span> <span class="st">"HR-negative"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>haz_pos <span class="ot">&lt;-</span> <span class="fu">muhaz</span>(hr_pos_data<span class="sc">$</span>observed_time, hr_pos_data<span class="sc">$</span>status, </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">min.time =</span> <span class="dv">1</span>, <span class="at">max.time =</span> <span class="dv">60</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>haz_neg <span class="ot">&lt;-</span> <span class="fu">muhaz</span>(hr_neg_data<span class="sc">$</span>observed_time, hr_neg_data<span class="sc">$</span>status, </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">min.time =</span> <span class="dv">1</span>, <span class="at">max.time =</span> <span class="dv">60</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into a data frame for plotting</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>hazard_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> haz_pos<span class="sc">$</span>est.grid,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">hazard =</span> haz_pos<span class="sc">$</span>haz.est,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"HR-positive"</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> haz_neg<span class="sc">$</span>est.grid,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">hazard =</span> haz_neg<span class="sc">$</span>haz.est,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"HR-negative"</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hazard_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> hazard, <span class="at">colour =</span> group)) <span class="sc">+</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"HR-negative"</span> <span class="ot">=</span> <span class="st">"#E74C3C"</span>, <span class="st">"HR-positive"</span> <span class="ot">=</span> <span class="st">"#3498DB"</span>),</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"HR Status"</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Hazard rate"</span>,</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Smoothed Hazard Function by Hormone Receptor Status"</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-hazard" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hazard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="survival_analysis_tutorial_files/figure-html/fig-hazard-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hazard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Smoothed hazard function estimates
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpreting the Hazard Function
</div>
</div>
<div class="callout-body-container callout-body">
<p>The hazard rate represents the instantaneous risk of death at any given time point. A higher hazard indicates greater risk.</p>
</div>
</div>
</section>
</section>
<section id="log-rank-test" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Log-Rank Test</h1>
<p>The log-rank test is the most widely used method to formally compare survival distributions between two or more groups. It tests the null hypothesis that there is no difference in survival between groups.</p>
<section id="how-the-log-rank-test-works" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="how-the-log-rank-test-works"><span class="header-section-number">9.1</span> How the Log-Rank Test Works</h2>
<p>The log-rank test is essentially a chi-squared test applied to survival data. At each time point where an event occurs, the test compares the <strong>observed</strong> number of events in each group to the <strong>expected</strong> number of events if there were truly no difference between groups.</p>
<p>The expected number of events in each group is calculated based on the proportion of patients still at risk in that group. If Group A has 60% of the remaining patients at a given time point, we would expect 60% of the events at that time to occur in Group A.</p>
<p>The test statistic is:</p>
<p><span class="math display">\[\chi^2 = \frac{(O - E)^2}{Var(O-E)}\]</span></p>
<p>Where O is the total observed events and E is the total expected events in a group. Under the null hypothesis of no difference, this follows a chi-squared distribution with degrees of freedom equal to the number of groups minus one.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key Properties of the Log-Rank Test
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>It is a <strong>non-parametric test</strong> — it makes no assumptions about the shape of the survival curves</li>
<li>It compares the <strong>entire survival experience</strong>, not just survival at a single time point</li>
<li>It gives <strong>equal weight</strong> to all time points (early and late events contribute equally)</li>
<li>It is most powerful when the <strong>hazard ratio is constant</strong> over time (proportional hazards)</li>
<li>It does <strong>not</strong> provide an estimate of the size of the difference — only whether a difference exists</li>
</ul>
</div>
</div>
</section>
<section id="comparing-hormone-receptor-groups" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="comparing-hormone-receptor-groups"><span class="header-section-number">9.2</span> Comparing Hormone Receptor Groups</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-rank test for hormone receptor status</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>logrank_hr <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> hormone_receptor, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> mbc_data)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>logrank_hr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(observed_time, status) ~ hormone_receptor, 
    data = mbc_data)

                               N Observed Expected (O-E)^2/E (O-E)^2/V
hormone_receptor=HR-negative 192      176      119     27.33      33.5
hormone_receptor=HR-positive 658      527      584      5.57      33.5

 Chisq= 33.5  on 1 degrees of freedom, p= 7e-09 </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract p-value</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>p_val <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pchisq</span>(logrank_hr<span class="sc">$</span>chisq, <span class="fu">length</span>(logrank_hr<span class="sc">$</span>n) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Log-rank test Chi-squared:"</span>, <span class="fu">round</span>(logrank_hr<span class="sc">$</span>chisq, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Log-rank test Chi-squared: 33.51 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Degrees of freedom:"</span>, <span class="fu">length</span>(logrank_hr<span class="sc">$</span>n) <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Degrees of freedom: 1 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"P-value:"</span>, <span class="fu">format.pval</span>(p_val, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>P-value: 7.09e-09 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Reading the Output
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>survdiff()</code> output shows:</p>
<ul>
<li><strong>N</strong>: Number of patients in each group</li>
<li><strong>Observed</strong>: Total events (deaths) observed in each group</li>
<li><strong>Expected</strong>: Events expected if there were no difference between groups</li>
<li><strong>(O-E)^2/E</strong> and <strong>(O-E)^2/V</strong>: Components of the chi-squared statistic</li>
</ul>
<p>If the observed and expected values are similar, the groups have similar survival. Large differences between observed and expected suggest the groups differ. A group with <strong>fewer observed than expected</strong> events has better survival than average; a group with <strong>more observed than expected</strong> has worse survival.</p>
</div>
</div>
</section>
<section id="comparing-ecog-performance-status-groups" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="comparing-ecog-performance-status-groups"><span class="header-section-number">9.3</span> Comparing ECOG Performance Status Groups</h2>
<p>When comparing more than two groups, the log-rank test provides an overall (omnibus) test of whether any differences exist. A significant result tells you that at least one group differs from the others, but not which specific groups differ.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-rank test for ECOG PS</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>logrank_ecog <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> ecog_ps, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> mbc_data)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>logrank_ecog</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(observed_time, status) ~ ecog_ps, data = mbc_data)

            N Observed Expected (O-E)^2/E (O-E)^2/V
ecog_ps=0 248      190    255.6     16.85     27.08
ecog_ps=1 348      278    303.6      2.16      3.85
ecog_ps=2 192      176    113.6     34.26     42.04
ecog_ps=3  62       59     30.2     27.58     29.20

 Chisq= 84  on 3 degrees of freedom, p= &lt;2e-16 </code></pre>
</div>
</div>
</section>
<section id="stratified-log-rank-test" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="stratified-log-rank-test"><span class="header-section-number">9.4</span> Stratified Log-Rank Test</h2>
<p>Sometimes we want to compare groups while adjusting for a potential confounding variable. The stratified log-rank test performs the comparison within strata of the adjusting variable, then combines the results. This is analogous to the Cochran-Mantel-Haenszel test for contingency tables.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare HR status, stratified by ECOG PS</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>logrank_strat <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> hormone_receptor <span class="sc">+</span> <span class="fu">strata</span>(ecog_ps), </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>logrank_strat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(observed_time, status) ~ hormone_receptor + 
    strata(ecog_ps), data = mbc_data)

                               N Observed Expected (O-E)^2/E (O-E)^2/V
hormone_receptor=HR-negative 192      176      114     33.14        41
hormone_receptor=HR-positive 658      527      589      6.44        41

 Chisq= 41  on 1 degrees of freedom, p= 2e-10 </code></pre>
</div>
</div>
<p>This tests whether hormone receptor status affects survival after accounting for differences in ECOG performance status across the groups.</p>
</section>
</section>
<section id="cox-proportional-hazards-regression" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Cox Proportional Hazards Regression</h1>
<p>The Cox proportional hazards model is the cornerstone of survival analysis, allowing us to examine the relationship between multiple covariates and survival time simultaneously. It was introduced by Sir David Cox in 1972 and remains the most widely used regression method for time-to-event data.</p>
<section id="why-use-cox-regression" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="why-use-cox-regression"><span class="header-section-number">10.1</span> Why Use Cox Regression?</h2>
<p>The log-rank test tells us <em>whether</em> groups differ, but not <em>by how much</em>. It also cannot adjust for multiple confounders simultaneously. Cox regression addresses both limitations:</p>
<ul>
<li>It provides <strong>hazard ratios</strong> that quantify the size of effects</li>
<li>It can include <strong>multiple covariates</strong> (both categorical and continuous)</li>
<li>It can <strong>adjust for confounders</strong> in a single model</li>
<li>It handles <strong>censored data</strong> appropriately</li>
</ul>
</section>
<section id="the-cox-model" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="the-cox-model"><span class="header-section-number">10.2</span> The Cox Model</h2>
<p>The Cox model specifies the hazard function as:</p>
<p><span class="math display">\[h(t|X) = h_0(t) \exp(\beta_1 X_1 + \beta_2 X_2 + ... + \beta_p X_p)\]</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(h(t|X)\)</span> is the hazard at time <span class="math inline">\(t\)</span> for a patient with covariates <span class="math inline">\(X\)</span></li>
<li><span class="math inline">\(h_0(t)\)</span> is the <strong>baseline hazard</strong> — the hazard when all covariates equal zero</li>
<li><span class="math inline">\(\beta_1, \beta_2, ..., \beta_p\)</span> are the regression coefficients</li>
<li><span class="math inline">\(\exp(\beta)\)</span> gives the <strong>hazard ratio</strong> for a one-unit increase in the covariate</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why “Semi-Parametric”?
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Cox model is called semi-parametric because:</p>
<ul>
<li>The <strong>covariate effects</strong> (<span class="math inline">\(\beta\)</span> coefficients) are estimated parametrically</li>
<li>The <strong>baseline hazard</strong> <span class="math inline">\(h_0(t)\)</span> is left completely unspecified — no distributional assumption is made</li>
</ul>
<p>This flexibility is a major advantage: the model works regardless of whether the underlying survival distribution is exponential, Weibull, or any other shape. The trade-off is that we cannot directly estimate survival probabilities without additional assumptions (though we can still compare groups via hazard ratios).</p>
</div>
</div>
</section>
<section id="the-proportional-hazards-assumption" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="the-proportional-hazards-assumption"><span class="header-section-number">10.3</span> The Proportional Hazards Assumption</h2>
<p>The model assumes that hazard ratios are <strong>constant over time</strong>. If patient A has twice the hazard of patient B at 1 month, they should still have twice the hazard at 12 months, 24 months, and so on.</p>
<p>Mathematically, for two patients with covariate values <span class="math inline">\(X_A\)</span> and <span class="math inline">\(X_B\)</span>:</p>
<p><span class="math display">\[\frac{h(t|X_A)}{h(t|X_B)} = \frac{h_0(t) \exp(\beta X_A)}{h_0(t) \exp(\beta X_B)} = \exp(\beta(X_A - X_B))\]</span></p>
<p>The baseline hazard <span class="math inline">\(h_0(t)\)</span> cancels out, leaving a ratio that does not depend on time.</p>
</section>
<section id="univariable-cox-models" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="univariable-cox-models"><span class="header-section-number">10.4</span> Univariable Cox Models</h2>
<p>First, let’s examine each potential predictor individually. Univariable analysis helps identify candidate variables for a multivariable model and provides unadjusted effect estimates.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for modelling</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>mbc_model <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">ecog_ps =</span> <span class="fu">factor</span>(ecog_ps),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">simd_quintile =</span> <span class="fu">factor</span>(simd_quintile),</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_group =</span> <span class="fu">factor</span>(age_group, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"&lt;50"</span>, <span class="st">"50-64"</span>, <span class="st">"65-74"</span>, <span class="st">"75+"</span>))</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create univariable Cox regression table</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>mbc_model <span class="sc">|&gt;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    observed_time, status,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    age_at_diagnosis, age_group, ecog_ps, hormone_receptor,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    her2_status, n_metastatic_sites, mets_group,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    liver_mets, brain_mets, presentation, simd_quintile</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_uvregression</span>(</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> coxph,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">Surv</span>(observed_time, status),</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">exponentiate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">hide_n =</span> <span class="cn">TRUE</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_p</span>() <span class="sc">|&gt;</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-univariable" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-univariable-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Univariable Cox regression analysis
</figcaption>
<div aria-describedby="tbl-univariable-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="bxtfigehvy" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#bxtfigehvy table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#bxtfigehvy thead, #bxtfigehvy tbody, #bxtfigehvy tfoot, #bxtfigehvy tr, #bxtfigehvy td, #bxtfigehvy th {
  border-style: none;
}

#bxtfigehvy p {
  margin: 0;
  padding: 0;
}

#bxtfigehvy .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#bxtfigehvy .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#bxtfigehvy .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#bxtfigehvy .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#bxtfigehvy .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bxtfigehvy .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bxtfigehvy .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bxtfigehvy .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#bxtfigehvy .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#bxtfigehvy .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#bxtfigehvy .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#bxtfigehvy .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#bxtfigehvy .gt_spanner_row {
  border-bottom-style: hidden;
}

#bxtfigehvy .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#bxtfigehvy .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#bxtfigehvy .gt_from_md > :first-child {
  margin-top: 0;
}

#bxtfigehvy .gt_from_md > :last-child {
  margin-bottom: 0;
}

#bxtfigehvy .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#bxtfigehvy .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#bxtfigehvy .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#bxtfigehvy .gt_row_group_first td {
  border-top-width: 2px;
}

#bxtfigehvy .gt_row_group_first th {
  border-top-width: 2px;
}

#bxtfigehvy .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bxtfigehvy .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#bxtfigehvy .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#bxtfigehvy .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bxtfigehvy .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bxtfigehvy .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#bxtfigehvy .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#bxtfigehvy .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#bxtfigehvy .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bxtfigehvy .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bxtfigehvy .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bxtfigehvy .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bxtfigehvy .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#bxtfigehvy .gt_left {
  text-align: left;
}

#bxtfigehvy .gt_center {
  text-align: center;
}

#bxtfigehvy .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#bxtfigehvy .gt_font_normal {
  font-weight: normal;
}

#bxtfigehvy .gt_font_bold {
  font-weight: bold;
}

#bxtfigehvy .gt_font_italic {
  font-style: italic;
}

#bxtfigehvy .gt_super {
  font-size: 65%;
}

#bxtfigehvy .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#bxtfigehvy .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#bxtfigehvy .gt_indent_1 {
  text-indent: 5px;
}

#bxtfigehvy .gt_indent_2 {
  text-indent: 10px;
}

#bxtfigehvy .gt_indent_3 {
  text-indent: 15px;
}

#bxtfigehvy .gt_indent_4 {
  text-indent: 20px;
}

#bxtfigehvy .gt_indent_5 {
  text-indent: 25px;
}

#bxtfigehvy .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#bxtfigehvy div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="gt_col_headings header">
<th id="label" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="estimate" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR</strong></th>
<th id="conf.low" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong></th>
<th id="p.value" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>p-value</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">age_at_diagnosis</td>
<td class="gt_row gt_center" headers="estimate">1.01</td>
<td class="gt_row gt_center" headers="conf.low">1.01, 1.02</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">age_group</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;&lt;50</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;50-64</td>
<td class="gt_row gt_center" headers="estimate">1.24</td>
<td class="gt_row gt_center" headers="conf.low">0.99, 1.56</td>
<td class="gt_row gt_center" headers="p.value">0.066</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;65-74</td>
<td class="gt_row gt_center" headers="estimate">1.63</td>
<td class="gt_row gt_center" headers="conf.low">1.27, 2.10</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;75+</td>
<td class="gt_row gt_center" headers="estimate">1.67</td>
<td class="gt_row gt_center" headers="conf.low">1.26, 2.22</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">ecog_ps</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;0</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td class="gt_row gt_center" headers="estimate">1.24</td>
<td class="gt_row gt_center" headers="conf.low">1.03, 1.49</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">0.022</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;2</td>
<td class="gt_row gt_center" headers="estimate">2.16</td>
<td class="gt_row gt_center" headers="conf.low">1.75, 2.66</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;3</td>
<td class="gt_row gt_center" headers="estimate">2.73</td>
<td class="gt_row gt_center" headers="conf.low">2.04, 3.67</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">hormone_receptor</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;HR-negative</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;HR-positive</td>
<td class="gt_row gt_center" headers="estimate">0.60</td>
<td class="gt_row gt_center" headers="conf.low">0.51, 0.72</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">her2_status</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Negative</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Positive</td>
<td class="gt_row gt_center" headers="estimate">0.83</td>
<td class="gt_row gt_center" headers="conf.low">0.68, 1.01</td>
<td class="gt_row gt_center" headers="p.value">0.062</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">n_metastatic_sites</td>
<td class="gt_row gt_center" headers="estimate">1.20</td>
<td class="gt_row gt_center" headers="conf.low">1.13, 1.28</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">mets_group</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;1 site</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;2 sites</td>
<td class="gt_row gt_center" headers="estimate">1.14</td>
<td class="gt_row gt_center" headers="conf.low">0.94, 1.38</td>
<td class="gt_row gt_center" headers="p.value">0.2</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;3+ sites</td>
<td class="gt_row gt_center" headers="estimate">1.49</td>
<td class="gt_row gt_center" headers="conf.low">1.25, 1.78</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">liver_mets</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;No</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Yes</td>
<td class="gt_row gt_center" headers="estimate">1.08</td>
<td class="gt_row gt_center" headers="conf.low">0.93, 1.26</td>
<td class="gt_row gt_center" headers="p.value">0.3</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">brain_mets</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;No</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Yes</td>
<td class="gt_row gt_center" headers="estimate">1.12</td>
<td class="gt_row gt_center" headers="conf.low">0.88, 1.42</td>
<td class="gt_row gt_center" headers="p.value">0.4</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">presentation</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;De novo metastatic</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Recurrent</td>
<td class="gt_row gt_center" headers="estimate">1.07</td>
<td class="gt_row gt_center" headers="conf.low">0.91, 1.26</td>
<td class="gt_row gt_center" headers="p.value">0.4</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">simd_quintile</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;2</td>
<td class="gt_row gt_center" headers="estimate">1.02</td>
<td class="gt_row gt_center" headers="conf.low">0.82, 1.27</td>
<td class="gt_row gt_center" headers="p.value">0.8</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;3</td>
<td class="gt_row gt_center" headers="estimate">1.11</td>
<td class="gt_row gt_center" headers="conf.low">0.88, 1.40</td>
<td class="gt_row gt_center" headers="p.value">0.4</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;4</td>
<td class="gt_row gt_center" headers="estimate">1.20</td>
<td class="gt_row gt_center" headers="conf.low">0.95, 1.51</td>
<td class="gt_row gt_center" headers="p.value">0.12</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;5</td>
<td class="gt_row gt_center" headers="estimate">1.06</td>
<td class="gt_row gt_center" headers="conf.low">0.83, 1.35</td>
<td class="gt_row gt_center" headers="p.value">0.7</td>
</tr>
</tbody><tfoot class="gt_sourcenotes">
<tr class="odd">
<td colspan="4" class="gt_sourcenote">Abbreviations: CI = Confidence Interval, HR = Hazard Ratio</td>
</tr>
</tfoot>

</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="multivariable-cox-model" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="multivariable-cox-model"><span class="header-section-number">10.5</span> Multivariable Cox Model</h2>
<p>Now we fit a multivariable model including clinically relevant predictors.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit multivariable Cox model</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>cox_multi <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    age_at_diagnosis <span class="sc">+</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    ecog_ps <span class="sc">+</span> </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    hormone_receptor <span class="sc">+</span> </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    her2_status <span class="sc">+</span> </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    n_metastatic_sites <span class="sc">+</span> </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    liver_mets <span class="sc">+</span> </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    brain_mets,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_model</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_multi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(observed_time, status) ~ age_at_diagnosis + 
    ecog_ps + hormone_receptor + her2_status + n_metastatic_sites + 
    liver_mets + brain_mets, data = mbc_model)

  n= 850, number of events= 703 

                                 coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
age_at_diagnosis             0.015183  1.015299  0.003205  4.737 2.17e-06 ***
ecog_ps1                     0.281729  1.325420  0.096426  2.922  0.00348 ** 
ecog_ps2                     0.926369  2.525322  0.109050  8.495  &lt; 2e-16 ***
ecog_ps3                     1.039383  2.827472  0.152049  6.836 8.15e-12 ***
hormone_receptorHR-positive -0.584592  0.557333  0.089281 -6.548 5.84e-11 ***
her2_statusPositive         -0.125108  0.882401  0.100482 -1.245  0.21310    
n_metastatic_sites           0.222397  1.249067  0.034330  6.478 9.29e-11 ***
liver_metsYes                0.104616  1.110285  0.078715  1.329  0.18383    
brain_metsYes                0.139167  1.149316  0.123112  1.130  0.25830    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

                            exp(coef) exp(-coef) lower .95 upper .95
age_at_diagnosis               1.0153     0.9849    1.0089    1.0217
ecog_ps1                       1.3254     0.7545    1.0972    1.6011
ecog_ps2                       2.5253     0.3960    2.0394    3.1271
ecog_ps3                       2.8275     0.3537    2.0988    3.8091
hormone_receptorHR-positive    0.5573     1.7943    0.4679    0.6639
her2_statusPositive            0.8824     1.1333    0.7247    1.0745
n_metastatic_sites             1.2491     0.8006    1.1678    1.3360
liver_metsYes                  1.1103     0.9007    0.9516    1.2955
brain_metsYes                  1.1493     0.8701    0.9029    1.4630

Concordance= 0.644  (se = 0.011 )
Likelihood ratio test= 177.8  on 9 df,   p=&lt;2e-16
Wald test            = 184  on 9 df,   p=&lt;2e-16
Score (logrank) test = 190.1  on 9 df,   p=&lt;2e-16</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Reading the Cox Model Output
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>summary()</code> output provides:</p>
<ul>
<li><strong>coef</strong>: The log hazard ratio (<span class="math inline">\(\beta\)</span>) — positive values indicate increased hazard</li>
<li><strong>exp(coef)</strong>: The hazard ratio — the multiplicative effect on hazard</li>
<li><strong>se(coef)</strong>: Standard error of the coefficient</li>
<li><strong>z</strong>: Wald test statistic (coef/se)</li>
<li><strong>Pr(&gt;|z|)</strong>: P-value for testing whether the coefficient differs from zero</li>
<li><strong>lower .95 / upper .95</strong>: 95% confidence interval for the hazard ratio</li>
<li><strong>Concordance</strong>: A measure of model discrimination (0.5 = no better than chance, 1.0 = perfect)</li>
<li><strong>Likelihood ratio test</strong>: Overall test of whether the model is better than a null model</li>
</ul>
</div>
</div>
</section>
<section id="understanding-hazard-ratios" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="understanding-hazard-ratios"><span class="header-section-number">10.6</span> Understanding Hazard Ratios</h2>
<p>The hazard ratio (HR) is the key output from Cox regression. It represents the relative rate at which events occur in one group compared to another, at any given point in time.</p>
<p><strong>Interpreting HR values:</strong></p>
<ul>
<li><strong>HR = 1</strong>: No difference between groups</li>
<li><strong>HR &gt; 1</strong>: Increased hazard (worse survival) compared to reference</li>
<li><strong>HR &lt; 1</strong>: Decreased hazard (better survival) compared to reference</li>
</ul>
<p><strong>For categorical variables</strong>: The HR compares each category to a reference category. For example, if HR-positive vs HR-negative has HR = 0.6, then HR-positive patients have 40% lower hazard (die at 0.6 times the rate) compared to HR-negative patients.</p>
<p><strong>For continuous variables</strong>: The HR represents the change in hazard for each one-unit increase. For example, if age has HR = 1.02, then each additional year of age increases the hazard by 2%.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
HR is Not a Risk or Probability
</div>
</div>
<div class="callout-body-container callout-body">
<p>The hazard ratio is often misinterpreted as a relative risk. While they can be similar in some situations, they measure different things:</p>
<ul>
<li><strong>Relative risk</strong> compares cumulative probabilities (e.g., “twice as likely to die by 5 years”)</li>
<li><strong>Hazard ratio</strong> compares instantaneous rates (e.g., “dying at twice the rate at any moment”)</li>
</ul>
<p>A HR of 2 does <strong>not</strong> mean twice the probability of the event. Be precise in your interpretation, and avoid phrases like “twice as likely” when reporting hazard ratios.</p>
</div>
</div>
</section>
<section id="formatted-multivariable-results" class="level2" data-number="10.7">
<h2 data-number="10.7" class="anchored" data-anchor-id="formatted-multivariable-results"><span class="header-section-number">10.7</span> Formatted Multivariable Results</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create formatted Cox regression table</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>cox_multi <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_regression</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">exponentiate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">list</span>(</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>      age_at_diagnosis <span class="sc">~</span> <span class="st">"Age at diagnosis (years)"</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>      ecog_ps <span class="sc">~</span> <span class="st">"ECOG Performance Status"</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>      hormone_receptor <span class="sc">~</span> <span class="st">"Hormone receptor status"</span>,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>      her2_status <span class="sc">~</span> <span class="st">"HER2 status"</span>,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>      n_metastatic_sites <span class="sc">~</span> <span class="st">"Number of metastatic sites"</span>,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>      liver_mets <span class="sc">~</span> <span class="st">"Liver metastases"</span>,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>      brain_mets <span class="sc">~</span> <span class="st">"Brain metastases"</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_p</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-multivar" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-multivar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Multivariable Cox regression model
</figcaption>
<div aria-describedby="tbl-multivar-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="nzizdfqwty" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#nzizdfqwty table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#nzizdfqwty thead, #nzizdfqwty tbody, #nzizdfqwty tfoot, #nzizdfqwty tr, #nzizdfqwty td, #nzizdfqwty th {
  border-style: none;
}

#nzizdfqwty p {
  margin: 0;
  padding: 0;
}

#nzizdfqwty .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#nzizdfqwty .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#nzizdfqwty .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#nzizdfqwty .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#nzizdfqwty .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#nzizdfqwty .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#nzizdfqwty .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#nzizdfqwty .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#nzizdfqwty .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#nzizdfqwty .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#nzizdfqwty .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#nzizdfqwty .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#nzizdfqwty .gt_spanner_row {
  border-bottom-style: hidden;
}

#nzizdfqwty .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#nzizdfqwty .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#nzizdfqwty .gt_from_md > :first-child {
  margin-top: 0;
}

#nzizdfqwty .gt_from_md > :last-child {
  margin-bottom: 0;
}

#nzizdfqwty .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#nzizdfqwty .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#nzizdfqwty .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#nzizdfqwty .gt_row_group_first td {
  border-top-width: 2px;
}

#nzizdfqwty .gt_row_group_first th {
  border-top-width: 2px;
}

#nzizdfqwty .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#nzizdfqwty .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#nzizdfqwty .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#nzizdfqwty .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#nzizdfqwty .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#nzizdfqwty .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#nzizdfqwty .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#nzizdfqwty .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#nzizdfqwty .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#nzizdfqwty .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#nzizdfqwty .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#nzizdfqwty .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#nzizdfqwty .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#nzizdfqwty .gt_left {
  text-align: left;
}

#nzizdfqwty .gt_center {
  text-align: center;
}

#nzizdfqwty .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#nzizdfqwty .gt_font_normal {
  font-weight: normal;
}

#nzizdfqwty .gt_font_bold {
  font-weight: bold;
}

#nzizdfqwty .gt_font_italic {
  font-style: italic;
}

#nzizdfqwty .gt_super {
  font-size: 65%;
}

#nzizdfqwty .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#nzizdfqwty .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#nzizdfqwty .gt_indent_1 {
  text-indent: 5px;
}

#nzizdfqwty .gt_indent_2 {
  text-indent: 10px;
}

#nzizdfqwty .gt_indent_3 {
  text-indent: 15px;
}

#nzizdfqwty .gt_indent_4 {
  text-indent: 20px;
}

#nzizdfqwty .gt_indent_5 {
  text-indent: 25px;
}

#nzizdfqwty .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#nzizdfqwty div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table do-not-create-environment cell caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="gt_col_headings header">
<th id="label" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col"><strong>Characteristic</strong></th>
<th id="estimate" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>HR</strong></th>
<th id="conf.low" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>95% CI</strong></th>
<th id="p.value" class="gt_col_heading gt_columns_bottom_border gt_center" data-quarto-table-cell-role="th" scope="col"><strong>p-value</strong></th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">Age at diagnosis (years)</td>
<td class="gt_row gt_center" headers="estimate">1.02</td>
<td class="gt_row gt_center" headers="conf.low">1.01, 1.02</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">ECOG Performance Status</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;0</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;1</td>
<td class="gt_row gt_center" headers="estimate">1.33</td>
<td class="gt_row gt_center" headers="conf.low">1.10, 1.60</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">0.003</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;2</td>
<td class="gt_row gt_center" headers="estimate">2.53</td>
<td class="gt_row gt_center" headers="conf.low">2.04, 3.13</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;3</td>
<td class="gt_row gt_center" headers="estimate">2.83</td>
<td class="gt_row gt_center" headers="conf.low">2.10, 3.81</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">Hormone receptor status</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;HR-negative</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;HR-positive</td>
<td class="gt_row gt_center" headers="estimate">0.56</td>
<td class="gt_row gt_center" headers="conf.low">0.47, 0.66</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">HER2 status</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Negative</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Positive</td>
<td class="gt_row gt_center" headers="estimate">0.88</td>
<td class="gt_row gt_center" headers="conf.low">0.72, 1.07</td>
<td class="gt_row gt_center" headers="p.value">0.2</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">Number of metastatic sites</td>
<td class="gt_row gt_center" headers="estimate">1.25</td>
<td class="gt_row gt_center" headers="conf.low">1.17, 1.34</td>
<td class="gt_row gt_center" headers="p.value" style="font-weight: bold">&lt;0.001</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">Liver metastases</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;No</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Yes</td>
<td class="gt_row gt_center" headers="estimate">1.11</td>
<td class="gt_row gt_center" headers="conf.low">0.95, 1.30</td>
<td class="gt_row gt_center" headers="p.value">0.2</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label" style="font-weight: bold">Brain metastases</td>
<td class="gt_row gt_center" headers="estimate"><br>
</td>
<td class="gt_row gt_center" headers="conf.low"><br>
</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;No</td>
<td class="gt_row gt_center" headers="estimate">—</td>
<td class="gt_row gt_center" headers="conf.low">—</td>
<td class="gt_row gt_center" headers="p.value"><br>
</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="label">&nbsp;&nbsp;&nbsp;&nbsp;Yes</td>
<td class="gt_row gt_center" headers="estimate">1.15</td>
<td class="gt_row gt_center" headers="conf.low">0.90, 1.46</td>
<td class="gt_row gt_center" headers="p.value">0.3</td>
</tr>
</tbody><tfoot class="gt_sourcenotes">
<tr class="odd">
<td colspan="4" class="gt_sourcenote">Abbreviations: CI = Confidence Interval, HR = Hazard Ratio</td>
</tr>
</tfoot>

</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="forest-plot-of-hazard-ratios" class="level2" data-number="10.8">
<h2 data-number="10.8" class="anchored" data-anchor-id="forest-plot-of-hazard-ratios"><span class="header-section-number">10.8</span> Forest Plot of Hazard Ratios</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create forest plot data from model</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>forest_data <span class="ot">&lt;-</span> <span class="fu">tidy</span>(cox_multi, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">exponentiate =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up term names for display</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">term_label =</span> <span class="fu">case_when</span>(</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"age_at_diagnosis"</span> <span class="sc">~</span> <span class="st">"Age (per year)"</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"ecog_ps1"</span> <span class="sc">~</span> <span class="st">"ECOG PS 1 vs 0"</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"ecog_ps2"</span> <span class="sc">~</span> <span class="st">"ECOG PS 2 vs 0"</span>,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"ecog_ps3"</span> <span class="sc">~</span> <span class="st">"ECOG PS 3 vs 0"</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"hormone_receptorHR-positive"</span> <span class="sc">~</span> <span class="st">"HR-positive vs HR-negative"</span>,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"her2_statusPositive"</span> <span class="sc">~</span> <span class="st">"HER2-positive vs negative"</span>,</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"n_metastatic_sites"</span> <span class="sc">~</span> <span class="st">"Metastatic sites (per site)"</span>,</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"liver_metsYes"</span> <span class="sc">~</span> <span class="st">"Liver metastases"</span>,</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"brain_metsYes"</span> <span class="sc">~</span> <span class="st">"Brain metastases"</span>,</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create HR label</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">hr_label =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f (%.2f-%.2f)"</span>, estimate, conf.low, conf.high),</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Significance indicator</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">significant =</span> p.value <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reverse order for plotting (top to bottom)</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">term_label =</span> <span class="fu">fct_inorder</span>(term_label) <span class="sc">|&gt;</span> <span class="fu">fct_rev</span>())</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the forest plot</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(forest_data, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term_label)) <span class="sc">+</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reference line at HR = 1</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">colour =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Confidence intervals</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high),</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="fl">0.2</span>,</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"grey30"</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Point estimates</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">colour =</span> significant),</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># HR labels on the right</span></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">max</span>(conf.high) <span class="sc">*</span> <span class="fl">1.3</span>, <span class="at">label =</span> hr_label),</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Colour scale</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"#E74C3C"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"#3498DB"</span>),</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"p &lt; 0.05"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"p ≥ 0.05"</span>),</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Log scale for x-axis</span></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fu">max</span>(forest_data<span class="sc">$</span>conf.high) <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Hazard Ratio (log scale)"</span>,</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Multivariable Cox Regression: Hazard Ratios"</span>,</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Adjusted for all variables shown"</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-forest" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-forest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="survival_analysis_tutorial_files/figure-html/fig-forest-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-forest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Forest plot of hazard ratios from the multivariable Cox model
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="model-fit-statistics" class="level2" data-number="10.9">
<h2 data-number="10.9" class="anchored" data-anchor-id="model-fit-statistics"><span class="header-section-number">10.9</span> Model Fit Statistics</h2>
<p>We can assess how well the model fits the data using several metrics.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model fit statistics</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(cox_multi) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n, nevent, concordance, std.error.concordance, logLik, AIC, BIC) <span class="sc">|&gt;</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"Statistic"</span>, <span class="at">values_to =</span> <span class="st">"Value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Statistic =</span> <span class="fu">case_when</span>(</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"n"</span> <span class="sc">~</span> <span class="st">"Number of observations"</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"nevent"</span> <span class="sc">~</span> <span class="st">"Number of events"</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"concordance"</span> <span class="sc">~</span> <span class="st">"Concordance (C-statistic)"</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"std.error.concordance"</span> <span class="sc">~</span> <span class="st">"SE of concordance"</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"logLik"</span> <span class="sc">~</span> <span class="st">"Log-likelihood"</span>,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"AIC"</span> <span class="sc">~</span> <span class="st">"AIC"</span>,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"BIC"</span> <span class="sc">~</span> <span class="st">"BIC"</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Value =</span> <span class="fu">round</span>(Value, <span class="dv">3</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Model fit statistics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Model fit statistics</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Statistic</th>
<th style="text-align: right;">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Number of observations</td>
<td style="text-align: right;">850.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of events</td>
<td style="text-align: right;">703.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Concordance (C-statistic)</td>
<td style="text-align: right;">0.644</td>
</tr>
<tr class="even">
<td style="text-align: left;">SE of concordance</td>
<td style="text-align: right;">0.011</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Log-likelihood</td>
<td style="text-align: right;">-4080.457</td>
</tr>
<tr class="even">
<td style="text-align: left;">AIC</td>
<td style="text-align: right;">8178.915</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BIC</td>
<td style="text-align: right;">8219.913</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Interpreting Model Fit Statistics
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p><strong>Concordance (C-statistic)</strong>: Measures discriminative ability — the probability that, for a random pair of patients where one dies first, the model correctly predicts which one. Values range from 0.5 (no better than chance) to 1.0 (perfect discrimination). In clinical models, values of 0.7–0.8 are typically considered acceptable.</p></li>
<li><p><strong>AIC/BIC</strong>: Information criteria for comparing models. Lower values indicate better fit, penalised for model complexity. Useful for comparing alternative models fitted to the same data.</p></li>
<li><p><strong>Log-likelihood</strong>: The basis for likelihood ratio tests comparing nested models.</p></li>
</ul>
</div>
</div>
</section>
<section id="predicting-survival-for-specific-patients" class="level2" data-number="10.10">
<h2 data-number="10.10" class="anchored" data-anchor-id="predicting-survival-for-specific-patients"><span class="header-section-number">10.10</span> Predicting Survival for Specific Patients</h2>
<p>One practical application of Cox models is predicting survival curves for patients with specific characteristics. Although the Cox model does not directly estimate the baseline hazard, the <code>survfit()</code> function can estimate it from the data and combine it with covariate effects to produce predicted survival curves.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create profiles for two hypothetical patients</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>new_patients <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">patient_type =</span> <span class="fu">c</span>(<span class="st">"Lower risk"</span>, <span class="st">"Higher risk"</span>),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_at_diagnosis =</span> <span class="fu">c</span>(<span class="dv">55</span>, <span class="dv">75</span>),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ecog_ps =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(mbc_model<span class="sc">$</span>ecog_ps)),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">hormone_receptor =</span> <span class="fu">c</span>(<span class="st">"HR-positive"</span>, <span class="st">"HR-negative"</span>),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">her2_status =</span> <span class="fu">c</span>(<span class="st">"Negative"</span>, <span class="st">"Negative"</span>),</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_metastatic_sites =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">liver_mets =</span> <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Yes"</span>),</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">brain_mets =</span> <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"No"</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>new_patients <span class="sc">|&gt;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Hypothetical patient profiles"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Hypothetical patient profiles</caption>
<colgroup>
<col style="width: 12%">
<col style="width: 15%">
<col style="width: 7%">
<col style="width: 15%">
<col style="width: 11%">
<col style="width: 17%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">patient_type</th>
<th style="text-align: right;">age_at_diagnosis</th>
<th style="text-align: left;">ecog_ps</th>
<th style="text-align: left;">hormone_receptor</th>
<th style="text-align: left;">her2_status</th>
<th style="text-align: right;">n_metastatic_sites</th>
<th style="text-align: left;">liver_mets</th>
<th style="text-align: left;">brain_mets</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Lower risk</td>
<td style="text-align: right;">55</td>
<td style="text-align: left;">0</td>
<td style="text-align: left;">HR-positive</td>
<td style="text-align: left;">Negative</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">No</td>
<td style="text-align: left;">No</td>
</tr>
<tr class="even">
<td style="text-align: left;">Higher risk</td>
<td style="text-align: right;">75</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">HR-negative</td>
<td style="text-align: left;">Negative</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">Yes</td>
<td style="text-align: left;">No</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predicted survival curves</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>pred_surv <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_multi, <span class="at">newdata =</span> new_patients)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using ggsurvplot</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  pred_surv,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> new_patients,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">censor =</span> <span class="cn">FALSE</span>,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"Lower risk patient"</span>, <span class="st">"Higher risk patient"</span>),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"Patient profile"</span>,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#27AE60"</span>, <span class="st">"#E74C3C"</span>),</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>()</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-cox-predicted" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cox-predicted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="survival_analysis_tutorial_files/figure-html/fig-cox-predicted-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cox-predicted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Predicted survival curves for two hypothetical patient profiles
</figcaption>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How Predictions Work
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Cox model doesn’t directly estimate the survival function — it estimates hazard ratios. To predict survival, R first estimates a baseline survival function (for a patient with all covariates at reference levels), then adjusts this based on the covariate values using the estimated coefficients.</p>
</div>
</div>
</section>
</section>
<section id="practice-exercises" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Practice Exercises</h1>
<p>The following exercises use datasets built into R’s <code>survival</code> package. Try these to consolidate your learning.</p>
<section id="exercise-1-the-lung-cancer-dataset" class="level2" data-number="11.1">
<h2 data-number="11.1" class="anchored" data-anchor-id="exercise-1-the-lung-cancer-dataset"><span class="header-section-number">11.1</span> Exercise 1: The Lung Cancer Dataset</h2>
<p>The <code>lung</code> dataset contains survival data from patients with advanced lung cancer. Load it and explore:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the lung dataset</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(lung)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the structure</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(lung)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 228
Columns: 10
$ inst      &lt;dbl&gt; 3, 3, 3, 5, 1, 12, 7, 11, 1, 7, 6, 16, 11, 21, 12, 1, 22, 16…
$ time      &lt;dbl&gt; 306, 455, 1010, 210, 883, 1022, 310, 361, 218, 166, 170, 654…
$ status    &lt;dbl&gt; 2, 2, 1, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, …
$ age       &lt;dbl&gt; 74, 68, 56, 57, 60, 74, 68, 71, 53, 61, 57, 68, 68, 60, 57, …
$ sex       &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 1, 2, 2, 1, 1, 1, 1, 1, 2, 1, …
$ ph.ecog   &lt;dbl&gt; 1, 0, 0, 1, 0, 1, 2, 2, 1, 2, 1, 2, 1, NA, 1, 1, 1, 2, 2, 1,…
$ ph.karno  &lt;dbl&gt; 90, 90, 90, 90, 100, 50, 70, 60, 70, 70, 80, 70, 90, 60, 80,…
$ pat.karno &lt;dbl&gt; 100, 90, 90, 60, 90, 80, 60, 80, 80, 70, 80, 70, 90, 70, 70,…
$ meal.cal  &lt;dbl&gt; 1175, 1225, NA, 1150, NA, 513, 384, 538, 825, 271, 1025, NA,…
$ wt.loss   &lt;dbl&gt; NA, 15, 15, 11, 0, 0, 10, 1, 16, 34, 27, 23, 5, 32, 60, 15, …</code></pre>
</div>
</div>
<p>Key variables:</p>
<ul>
<li><code>time</code>: Survival time in days</li>
<li><code>status</code>: 1 = censored, 2 = dead (note: non-standard coding!)</li>
<li><code>sex</code>: 1 = Male, 2 = Female</li>
<li><code>ph.ecog</code>: ECOG performance score (0 = good, 5 = dead)</li>
</ul>
<section id="task-1a-recode-the-status-variable" class="level3" data-number="11.1.1">
<h3 data-number="11.1.1" class="anchored" data-anchor-id="task-1a-recode-the-status-variable"><span class="header-section-number">11.1.1</span> Task 1a: Recode the status variable</h3>
<p>The status variable uses non-standard coding. Recode it so that 0 = censored and 1 = event (death).</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>lung <span class="ot">&lt;-</span> lung <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> status <span class="sc">-</span> <span class="dv">1</span>)  <span class="co"># Convert 1,2 to 0,1</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the recoding</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(lung<span class="sc">$</span>status)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  0   1 
 63 165 </code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="task-1b-create-a-kaplan-meier-curve-by-sex" class="level3" data-number="11.1.2">
<h3 data-number="11.1.2" class="anchored" data-anchor-id="task-1b-create-a-kaplan-meier-curve-by-sex"><span class="header-section-number">11.1.2</span> Task 1b: Create a Kaplan-Meier curve by sex</h3>
<p>Fit a survival curve comparing males and females, and create a plot.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-15-contents" aria-controls="callout-15" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-15" class="callout-15-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>lung_sex <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  lung_sex,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> lung,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time (days)"</span>,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"Male"</span>, <span class="st">"Female"</span>),</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by Sex"</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="survival_analysis_tutorial_files/figure-html/ex1b-solution-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Survival by sex in lung cancer patients</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="task-1c-test-for-differences-and-fit-a-cox-model" class="level3" data-number="11.1.3">
<h3 data-number="11.1.3" class="anchored" data-anchor-id="task-1c-test-for-differences-and-fit-a-cox-model"><span class="header-section-number">11.1.3</span> Task 1c: Test for differences and fit a Cox model</h3>
<p>Conduct a log-rank test and fit a Cox model for sex.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-16-contents" aria-controls="callout-16" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-16" class="callout-16-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-rank test</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(time, status) ~ sex, data = lung)

        N Observed Expected (O-E)^2/E (O-E)^2/V
sex=1 138      112     91.6      4.55      10.3
sex=2  90       53     73.4      5.68      10.3

 Chisq= 10.3  on 1 degrees of freedom, p= 0.001 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>cox_lung <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_lung)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ sex, data = lung)

  n= 228, number of events= 165 

       coef exp(coef) se(coef)      z Pr(&gt;|z|)   
sex -0.5310    0.5880   0.1672 -3.176  0.00149 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

    exp(coef) exp(-coef) lower .95 upper .95
sex     0.588      1.701    0.4237     0.816

Concordance= 0.579  (se = 0.021 )
Likelihood ratio test= 10.63  on 1 df,   p=0.001
Wald test            = 10.09  on 1 df,   p=0.001
Score (logrank) test = 10.33  on 1 df,   p=0.001</code></pre>
</div>
</div>
<p><strong>Interpretation</strong>: Females (sex = 2) have significantly better survival than males. The hazard ratio of approximately 0.59 means females die at about 59% the rate of males, or equivalently, males have about 1.7 times higher hazard of death.</p>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-2-the-colon-cancer-dataset" class="level2" data-number="11.2">
<h2 data-number="11.2" class="anchored" data-anchor-id="exercise-2-the-colon-cancer-dataset"><span class="header-section-number">11.2</span> Exercise 2: The Colon Cancer Dataset</h2>
<p>The <code>colon</code> dataset contains data from a trial of adjuvant chemotherapy for colon cancer. It has two rows per patient: one for recurrence and one for death.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(colon)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to death events only</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>colon_death <span class="ot">&lt;-</span> colon <span class="sc">|&gt;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(etype <span class="sc">==</span> <span class="dv">2</span>)  <span class="co"># etype 2 = death</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(colon_death)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 929
Columns: 16
$ id       &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18…
$ study    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ rx       &lt;fct&gt; Lev+5FU, Lev+5FU, Obs, Lev+5FU, Obs, Lev+5FU, Lev, Obs, Lev, …
$ sex      &lt;dbl&gt; 1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1…
$ age      &lt;dbl&gt; 43, 63, 71, 66, 69, 57, 77, 54, 46, 68, 47, 52, 64, 68, 46, 6…
$ obstruct &lt;dbl&gt; 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1…
$ perfor   &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ adhere   &lt;dbl&gt; 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0…
$ nodes    &lt;dbl&gt; 5, 1, 7, 6, 22, 9, 5, 1, 2, 1, 1, 2, 1, 3, 4, 1, 6, 1, 1, 1, …
$ status   &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1…
$ differ   &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2…
$ extent   &lt;dbl&gt; 3, 3, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 3, 3…
$ surg     &lt;dbl&gt; 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1…
$ node4    &lt;dbl&gt; 1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0…
$ time     &lt;dbl&gt; 1521, 3087, 963, 293, 659, 1767, 420, 3192, 3173, 3308, 2908,…
$ etype    &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2…</code></pre>
</div>
</div>
<p>Key variables:</p>
<ul>
<li><code>time</code>: Days until event or censoring</li>
<li><code>status</code>: 0 = censored, 1 = event</li>
<li><code>rx</code>: Treatment (Obs = observation, Lev = levamisole, Lev+5FU = levamisole + 5-fluorouracil)</li>
<li><code>nodes</code>: Number of positive lymph nodes</li>
</ul>
<section id="task-2a-compare-survival-by-treatment" class="level3" data-number="11.2.1">
<h3 data-number="11.2.1" class="anchored" data-anchor-id="task-2a-compare-survival-by-treatment"><span class="header-section-number">11.2.1</span> Task 2a: Compare survival by treatment</h3>
<p>Create KM curves comparing the three treatment groups.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>colon_rx <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> rx, <span class="at">data =</span> colon_death)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  colon_rx,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> colon_death,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time (days)"</span>,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by Treatment"</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="survival_analysis_tutorial_files/figure-html/ex2a-solution-1.png" class="img-fluid figure-img" width="768"></p>
<figcaption>Survival by treatment in colon cancer</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-rank test</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> rx, <span class="at">data =</span> colon_death)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(time, status) ~ rx, data = colon_death)

             N Observed Expected (O-E)^2/E (O-E)^2/V
rx=Obs     315      168      148      2.58      3.85
rx=Lev     310      161      146      1.52      2.25
rx=Lev+5FU 304      123      157      7.55     11.62

 Chisq= 11.7  on 2 degrees of freedom, p= 0.003 </code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="task-2b-fit-a-multivariable-cox-model" class="level3" data-number="11.2.2">
<h3 data-number="11.2.2" class="anchored" data-anchor-id="task-2b-fit-a-multivariable-cox-model"><span class="header-section-number">11.2.2</span> Task 2b: Fit a multivariable Cox model</h3>
<p>Fit a Cox model including treatment (<code>rx</code>), age, sex, and number of positive nodes.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-18-contents" aria-controls="callout-18" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-18" class="callout-18-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>cox_colon <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> rx <span class="sc">+</span> age <span class="sc">+</span> sex <span class="sc">+</span> nodes,</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> colon_death</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_colon)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ rx + age + sex + nodes, 
    data = colon_death)

  n= 911, number of events= 441 
   (18 observations deleted due to missingness)

               coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
rxLev     -0.080072  0.923049  0.111613 -0.717  0.47312    
rxLev+5FU -0.402527  0.668628  0.120539 -3.339  0.00084 ***
age        0.005333  1.005347  0.004045  1.318  0.18739    
sex       -0.028257  0.972138  0.095728 -0.295  0.76786    
nodes      0.092755  1.097193  0.008871 10.456  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

          exp(coef) exp(-coef) lower .95 upper .95
rxLev        0.9230     1.0834    0.7417    1.1488
rxLev+5FU    0.6686     1.4956    0.5279    0.8468
age          1.0053     0.9947    0.9974    1.0134
sex          0.9721     1.0287    0.8058    1.1728
nodes        1.0972     0.9114    1.0783    1.1164

Concordance= 0.638  (se = 0.014 )
Likelihood ratio test= 87.79  on 5 df,   p=&lt;2e-16
Wald test            = 123  on 5 df,   p=&lt;2e-16
Score (logrank) test = 125  on 5 df,   p=&lt;2e-16</code></pre>
</div>
</div>
<p><strong>Interpretation</strong>:</p>
<ul>
<li>Levamisole alone shows no significant benefit over observation</li>
<li>Levamisole + 5FU significantly improves survival (HR ≈ 0.64)</li>
<li>Each additional positive lymph node increases hazard by about 9%</li>
<li>Age and sex are not significantly associated with survival after adjusting for treatment and nodes</li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-3-the-aml-dataset" class="level2" data-number="11.3">
<h2 data-number="11.3" class="anchored" data-anchor-id="exercise-3-the-aml-dataset"><span class="header-section-number">11.3</span> Exercise 3: The AML Dataset</h2>
<p>The <code>aml</code> dataset is a small dataset comparing maintenance chemotherapy for acute myelogenous leukaemia.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(aml)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(aml)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 23
Columns: 3
$ time   &lt;dbl&gt; 9, 13, 13, 18, 23, 28, 31, 34, 45, 48, 161, 5, 5, 8, 8, 12, 16,…
$ status &lt;dbl&gt; 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, …
$ x      &lt;fct&gt; Maintained, Maintained, Maintained, Maintained, Maintained, Mai…</code></pre>
</div>
</div>
<p>Variables:</p>
<ul>
<li><code>time</code>: Survival time in weeks</li>
<li><code>status</code>: 0 = censored, 1 = relapsed</li>
<li><code>x</code>: Treatment group (Maintained or Nonmaintained)</li>
</ul>
<section id="task-3a-calculate-median-survival-by-group" class="level3" data-number="11.3.1">
<h3 data-number="11.3.1" class="anchored" data-anchor-id="task-3a-calculate-median-survival-by-group"><span class="header-section-number">11.3.1</span> Task 3a: Calculate median survival by group</h3>
<p>Estimate median survival time for each treatment group.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-19-contents" aria-controls="callout-19" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-19" class="callout-19-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>aml_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> x, <span class="at">data =</span> aml)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Median survival</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aml_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(time, status) ~ x, data = aml)

                 n events median 0.95LCL 0.95UCL
x=Maintained    11      7     31      18      NA
x=Nonmaintained 12     11     23       8      NA</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="task-3b-estimate-survival-probability-at-30-weeks" class="level3" data-number="11.3.2">
<h3 data-number="11.3.2" class="anchored" data-anchor-id="task-3b-estimate-survival-probability-at-30-weeks"><span class="header-section-number">11.3.2</span> Task 3b: Estimate survival probability at 30 weeks</h3>
<p>What proportion of patients in each group survived beyond 30 weeks?</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the range of times in the data</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(aml<span class="sc">$</span>time)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1]   5 161</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get survival estimates at 30 weeks</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use extend = TRUE to handle times beyond observed data</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(aml_fit, <span class="at">times =</span> <span class="dv">30</span>, <span class="at">extend =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(time, status) ~ x, data = aml)

                x=Maintained 
        time       n.risk      n.event     survival      std.err lower 95% CI 
      30.000        5.000        4.000        0.614        0.153        0.377 
upper 95% CI 
       0.999 

                x=Nonmaintained 
        time       n.risk      n.event     survival      std.err lower 95% CI 
      30.000        4.000        8.000        0.292        0.139        0.115 
upper 95% CI 
       0.741 </code></pre>
</div>
</div>
<p>Note: The <code>extend = TRUE</code> argument allows estimation at time points beyond the last observed event for a group by carrying forward the last survival estimate.</p>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-4-cox-modelling-with-the-veteran-dataset" class="level2" data-number="11.4">
<h2 data-number="11.4" class="anchored" data-anchor-id="exercise-4-cox-modelling-with-the-veteran-dataset"><span class="header-section-number">11.4</span> Exercise 4: Cox Modelling with the Veteran Dataset</h2>
<p>The <code>veteran</code> dataset describes survival of patients with lung cancer in a Veterans Administration trial.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(veteran)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veteran)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 137
Columns: 8
$ trt      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ celltype &lt;fct&gt; squamous, squamous, squamous, squamous, squamous, squamous, s…
$ time     &lt;dbl&gt; 72, 411, 228, 126, 118, 10, 82, 110, 314, 100, 42, 8, 144, 25…
$ status   &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0…
$ karno    &lt;dbl&gt; 60, 70, 60, 60, 70, 20, 40, 80, 50, 70, 60, 40, 30, 80, 70, 6…
$ diagtime &lt;dbl&gt; 7, 5, 3, 9, 11, 5, 10, 29, 18, 6, 4, 58, 4, 9, 11, 3, 9, 2, 4…
$ age      &lt;dbl&gt; 69, 64, 38, 63, 65, 49, 69, 68, 43, 70, 81, 63, 63, 52, 48, 6…
$ prior    &lt;dbl&gt; 0, 10, 0, 10, 10, 0, 10, 0, 0, 0, 0, 10, 0, 10, 10, 0, 0, 0, …</code></pre>
</div>
</div>
<p>Key variables:</p>
<ul>
<li><code>time</code>: Survival time in days</li>
<li><code>status</code>: 0 = censored, 1 = dead</li>
<li><code>trt</code>: Treatment (1 = standard, 2 = test)</li>
<li><code>karno</code>: Karnofsky performance score (0-100, higher is better)</li>
<li><code>age</code>: Age in years</li>
</ul>
<section id="task-4a-fit-a-cox-model" class="level3" data-number="11.4.1">
<h3 data-number="11.4.1" class="anchored" data-anchor-id="task-4a-fit-a-cox-model"><span class="header-section-number">11.4.1</span> Task 4a: Fit a Cox model</h3>
<p>Fit a Cox model with treatment, Karnofsky score, and age as predictors.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-21-contents" aria-controls="callout-21" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-21" class="callout-21-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>cox_veteran <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> karno <span class="sc">+</span> age, <span class="at">data =</span> veteran)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_veteran)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(time, status) ~ trt + karno + age, data = veteran)

  n= 137, number of events= 128 

           coef exp(coef)  se(coef)      z Pr(&gt;|z|)    
trt    0.189546  1.208701  0.185531  1.022    0.307    
karno -0.034444  0.966143  0.005232 -6.583 4.62e-11 ***
age   -0.003864  0.996143  0.009187 -0.421    0.674    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

      exp(coef) exp(-coef) lower .95 upper .95
trt      1.2087     0.8273    0.8402    1.7388
karno    0.9661     1.0350    0.9563    0.9761
age      0.9961     1.0039    0.9784    1.0142

Concordance= 0.712  (se = 0.022 )
Likelihood ratio test= 43.14  on 3 df,   p=2e-09
Wald test            = 44.52  on 3 df,   p=1e-09
Score (logrank) test = 46.84  on 3 df,   p=4e-10</code></pre>
</div>
</div>
<p><strong>Interpretation</strong>:</p>
<ul>
<li>Treatment (test vs standard) shows no significant effect on survival</li>
<li>Each 1-point increase in Karnofsky score reduces hazard by about 3% (HR ≈ 0.97), and this is highly significant</li>
<li>Age shows no significant association with survival after adjusting for treatment and Karnofsky score</li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-5-interpretation-questions" class="level2" data-number="11.5">
<h2 data-number="11.5" class="anchored" data-anchor-id="exercise-5-interpretation-questions"><span class="header-section-number">11.5</span> Exercise 5: Interpretation Questions</h2>
<p>These questions test your understanding of survival analysis concepts. Think about each one before revealing the answer.</p>
<section id="question-5a" class="level3" data-number="11.5.1">
<h3 data-number="11.5.1" class="anchored" data-anchor-id="question-5a"><span class="header-section-number">11.5.1</span> Question 5a</h3>
<p>A Cox model gives a hazard ratio of 2.5 for a binary exposure variable. What does this mean?</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-22-contents" aria-controls="callout-22" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-22" class="callout-22-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The exposed group experiences the event at 2.5 times the rate of the unexposed group at any given time point. This indicates substantially worse survival in the exposed group.</p>
</div>
</div>
</div>
</section>
<section id="question-5b" class="level3" data-number="11.5.2">
<h3 data-number="11.5.2" class="anchored" data-anchor-id="question-5b"><span class="header-section-number">11.5.2</span> Question 5b</h3>
<p>Why can’t we simply calculate “proportion surviving” to estimate 2-year survival?</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-23-contents" aria-controls="callout-23" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-23" class="callout-23-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>A naive calculation would either:</p>
<ol type="1">
<li>Treat censored patients as if they survived the full period (overestimating survival), or</li>
<li>Exclude them entirely (potentially biasing in either direction)</li>
</ol>
<p>The Kaplan-Meier method correctly accounts for censoring by including each patient’s contribution up to their censoring time, then removing them from the risk set.</p>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="summary" class="level1" data-number="12">
<h1 data-number="12"><span class="header-section-number">12</span> Summary</h1>
<p>This tutorial has covered the fundamental techniques of survival analysis in R:</p>
<ol type="1">
<li><strong>Why survival analysis</strong>: Understanding censoring, non-informative censoring assumptions, and why standard methods don’t work for time-to-event data</li>
<li><strong>Survival objects</strong>: Created using <code>Surv()</code> to encode time-to-event data with censoring</li>
<li><strong>Kaplan-Meier estimation</strong>: Non-parametric estimation of survival curves using <code>survfit()</code></li>
<li><strong>Survival estimates</strong>: Calculating median survival and survival probabilities at specific time points</li>
<li><strong>Hazard functions</strong>: Both cumulative and smoothed instantaneous hazard rates</li>
<li><strong>Log-rank tests</strong>: Formal comparison of survival between groups using <code>survdiff()</code>, including weighted alternatives</li>
<li><strong>Cox regression</strong>: Semi-parametric modelling of hazard ratios using <code>coxph()</code>, including interpretation of HRs</li>
<li><strong>Survival predictions</strong>: Generating predicted survival curves for specific patient profiles</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Further Reading
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Introductory tutorials:</strong></p>
<ul>
<li><a href="https://www.emilyzabor.com/survival-analysis-in-r.html">Survival Analysis in R</a> by Emily Zabor — excellent comprehensive tutorial</li>
<li><a href="https://bioconnector.github.io/workshops/r-survival.html">Bioconnector Survival Analysis</a> — hands-on workshop materials</li>
</ul>
<p><strong>Key papers:</strong></p>
<ul>
<li>Clark TG et al.&nbsp;(2003) Survival analysis part I-IV. <em>British Journal of Cancer</em> — four-part series covering basic to advanced concepts</li>
</ul>
<p><strong>Books:</strong></p>
<ul>
<li>Therneau TM &amp; Grambsch PM (2000) <em>Modeling Survival Data: Extending the Cox Model</em>. Springer.</li>
<li>Kleinbaum DG &amp; Klein M (2012) <em>Survival Analysis: A Self-Learning Text</em>. 3rd ed.&nbsp;Springer.</li>
</ul>
<p><strong>R package documentation:</strong></p>
<ul>
<li><code>vignette("survival")</code> — comprehensive introduction to the survival package</li>
<li><code>vignette("timedep")</code> — time-dependent covariates and coefficients</li>
</ul>
</div>
</div>
</section>
<section id="session-information" class="level1" data-number="13">
<h1 data-number="13"><span class="header-section-number">13</span> Session Information</h1>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 26200)

Matrix products: default
  LAPACK version 3.12.1

locale:
[1] LC_COLLATE=English_United Kingdom.utf8 
[2] LC_CTYPE=English_United Kingdom.utf8   
[3] LC_MONETARY=English_United Kingdom.utf8
[4] LC_NUMERIC=C                           
[5] LC_TIME=English_United Kingdom.utf8    

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] muhaz_1.2.6.4    flextable_0.9.10 knitr_1.50       readxl_1.4.5    
 [5] writexl_1.5.4    broom_1.0.8      gtsummary_2.4.0  survminer_0.5.1 
 [9] ggpubr_0.6.1     survival_3.8-3   lubridate_1.9.4  forcats_1.0.0   
[13] stringr_1.5.1    dplyr_1.1.4      purrr_1.0.4      readr_2.1.5     
[17] tidyr_1.3.1      tibble_3.3.0     ggplot2_4.0.0    tidyverse_2.0.0 

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1        viridisLite_0.4.2       farver_2.1.2           
 [4] S7_0.2.0                fastmap_1.2.0           fontquiver_0.2.1       
 [7] broom.helpers_1.22.0    labelled_2.15.0         digest_0.6.37          
[10] timechange_0.3.0        lifecycle_1.0.4         magrittr_2.0.3         
[13] compiler_4.5.1          sass_0.4.10             rlang_1.1.6            
[16] tools_4.5.1             gt_1.0.0                yaml_2.3.10            
[19] data.table_1.17.8       ggsignif_0.6.4          labeling_0.4.3         
[22] askpass_1.2.1           htmlwidgets_1.6.4       xml2_1.4.1             
[25] RColorBrewer_1.1-3      abind_1.4-8             withr_3.0.2            
[28] grid_4.5.1              gdtools_0.4.3           xtable_1.8-4           
[31] scales_1.4.0            cli_3.6.5               rmarkdown_2.29         
[34] ragg_1.4.0              generics_0.1.4          rstudioapi_0.17.1      
[37] km.ci_0.5-6             tzdb_0.5.0              commonmark_2.0.0       
[40] splines_4.5.1           cellranger_1.1.0        base64enc_0.1-3        
[43] survMisc_0.5.6          vctrs_0.6.5             Matrix_1.7-3           
[46] jsonlite_2.0.0          fontBitstreamVera_0.1.1 carData_3.0-5          
[49] litedown_0.7            car_3.1-3               hms_1.1.3              
[52] rstatix_0.7.2           Formula_1.2-5           systemfonts_1.2.3      
[55] glue_1.8.0              ggtext_0.1.2            stringi_1.8.7          
[58] gtable_0.3.6            pillar_1.10.2           htmltools_0.5.8.1      
[61] openssl_2.3.3           R6_2.6.1                KMsurv_0.1-6           
[64] textshaping_1.0.1       evaluate_1.0.4          lattice_0.22-7         
[67] haven_2.5.5             markdown_2.0            backports_1.5.0        
[70] cards_0.7.0             gridtext_0.1.5          ggsci_4.0.0            
[73] fontLiberation_0.1.0    cardx_0.3.0             Rcpp_1.1.0             
[76] zip_2.3.3               uuid_1.2-1              gridExtra_2.3          
[79] officer_0.7.0           xfun_0.52               zoo_1.8-14             
[82] pkgconfig_2.0.3        </code></pre>
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb68" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Survival Analysis in R: A Practical Tutorial"</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Using Scottish Metastatic Breast Cancer Data"</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Edinburgh Cancer Informatics Group"</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: left</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: flatly</span></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: github</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-width: 8</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-height: 6</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required packages</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survminer)</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gtsummary)</span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(writexl)</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(flextable)</span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for reproducibility</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Scottish Health Boards with approximate population weights</span></span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>health_boards <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">health_board =</span> <span class="fu">c</span>(</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Ayrshire and Arran"</span>,</span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Borders"</span>,</span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Dumfries and Galloway"</span>,</span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Fife"</span>,</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Forth Valley"</span>,</span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Grampian"</span>,</span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Greater Glasgow and Clyde"</span>,</span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Highland"</span>,</span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Lanarkshire"</span>,</span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Lothian"</span>,</span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Orkney"</span>,</span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Shetland"</span>,</span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Tayside"</span>,</span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NHS Western Isles"</span></span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">pop_weight =</span> <span class="fu">c</span>(</span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.068</span>, <span class="fl">0.021</span>, <span class="fl">0.027</span>, <span class="fl">0.069</span>, <span class="fl">0.056</span>, <span class="fl">0.107</span>, </span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.216</span>, <span class="fl">0.059</span>, <span class="fl">0.122</span>, <span class="fl">0.165</span>, <span class="fl">0.004</span>, <span class="fl">0.004</span>, </span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.076</span>, <span class="fl">0.005</span></span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate synthetic patient data</span></span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a>n_patients <span class="ot">&lt;-</span> <span class="dv">850</span></span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate correlated survival times based on covariates</span></span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a>generate_survival_data <span class="ot">&lt;-</span> <span class="cf">function</span>(n, </span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a>                                    age, </span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a>                                    ecog, </span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a>                                    n_mets_sites,</span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true" tabindex="-1"></a>                                    er_status,</span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true" tabindex="-1"></a>                                    treatment) {</span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Base hazard parameters</span></span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a>  baseline_median <span class="ot">&lt;-</span> <span class="dv">24</span>  <span class="co"># months</span></span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Hazard ratios (log scale)</span></span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a>  beta_age <span class="ot">&lt;-</span> <span class="fl">0.02</span>        <span class="co"># per year increase</span></span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a>  beta_ecog <span class="ot">&lt;-</span> <span class="fl">0.4</span>        <span class="co"># per unit increase</span></span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a>  beta_mets <span class="ot">&lt;-</span> <span class="fl">0.25</span>       <span class="co"># per additional site</span></span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a>  beta_er_neg <span class="ot">&lt;-</span> <span class="fl">0.5</span>      <span class="co"># ER negative vs positive</span></span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true" tabindex="-1"></a>  beta_chemo <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.15</span>     <span class="co"># chemo vs endocrine only</span></span>
<span id="cb68-90"><a href="#cb68-90" aria-hidden="true" tabindex="-1"></a>  beta_targeted <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.35</span>  <span class="co"># targeted therapy benefit</span></span>
<span id="cb68-91"><a href="#cb68-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate linear predictor</span></span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true" tabindex="-1"></a>  lp <span class="ot">&lt;-</span> beta_age <span class="sc">*</span> (age <span class="sc">-</span> <span class="dv">60</span>) <span class="sc">+</span></span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true" tabindex="-1"></a>        beta_ecog <span class="sc">*</span> ecog <span class="sc">+</span></span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true" tabindex="-1"></a>        beta_mets <span class="sc">*</span> (n_mets_sites <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true" tabindex="-1"></a>        beta_er_neg <span class="sc">*</span> (er_status <span class="sc">==</span> <span class="st">"Negative"</span>) <span class="sc">+</span></span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true" tabindex="-1"></a>        beta_chemo <span class="sc">*</span> (treatment <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Chemotherapy"</span>, <span class="st">"Chemo + Targeted"</span>)) <span class="sc">+</span></span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true" tabindex="-1"></a>        beta_targeted <span class="sc">*</span> (treatment <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Endocrine + Targeted"</span>, <span class="st">"Chemo + Targeted"</span>))</span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate Weibull survival times</span></span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true" tabindex="-1"></a>  shape <span class="ot">&lt;-</span> <span class="fl">1.2</span></span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true" tabindex="-1"></a>  scale <span class="ot">&lt;-</span> baseline_median <span class="sc">/</span> (<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">^</span>(<span class="dv">1</span><span class="sc">/</span>shape)) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>lp<span class="sc">/</span>shape)</span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true" tabindex="-1"></a>  surv_time <span class="ot">&lt;-</span> <span class="fu">rweibull</span>(n, <span class="at">shape =</span> shape, <span class="at">scale =</span> scale)</span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add some noise</span></span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true" tabindex="-1"></a>  surv_time <span class="ot">&lt;-</span> surv_time <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="fl">0.2</span>))</span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">pmax</span>(surv_time, <span class="fl">0.5</span>))  <span class="co"># minimum 0.5 months</span></span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate patient characteristics</span></span>
<span id="cb68-113"><a href="#cb68-113" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb68-114"><a href="#cb68-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">patient_id =</span> <span class="fu">sprintf</span>(<span class="st">"MBC%04d"</span>, <span class="dv">1</span><span class="sc">:</span>n_patients),</span>
<span id="cb68-115"><a href="#cb68-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-116"><a href="#cb68-116" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Health board based on population weights</span></span>
<span id="cb68-117"><a href="#cb68-117" aria-hidden="true" tabindex="-1"></a>  <span class="at">health_board =</span> <span class="fu">sample</span>(</span>
<span id="cb68-118"><a href="#cb68-118" aria-hidden="true" tabindex="-1"></a>    health_boards<span class="sc">$</span>health_board,</span>
<span id="cb68-119"><a href="#cb68-119" aria-hidden="true" tabindex="-1"></a>    n_patients,</span>
<span id="cb68-120"><a href="#cb68-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-121"><a href="#cb68-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob =</span> health_boards<span class="sc">$</span>pop_weight</span>
<span id="cb68-122"><a href="#cb68-122" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb68-123"><a href="#cb68-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-124"><a href="#cb68-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Demographics</span></span>
<span id="cb68-125"><a href="#cb68-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_at_diagnosis =</span> <span class="fu">round</span>(<span class="fu">rnorm</span>(n_patients, <span class="at">mean =</span> <span class="dv">62</span>, <span class="at">sd =</span> <span class="dv">12</span>)),</span>
<span id="cb68-126"><a href="#cb68-126" aria-hidden="true" tabindex="-1"></a>  <span class="at">sex =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Female"</span>, <span class="st">"Male"</span>), n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.99</span>, <span class="fl">0.01</span>)),</span>
<span id="cb68-127"><a href="#cb68-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-128"><a href="#cb68-128" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SIMD quintile (1 = most deprived, 5 = least deprived)</span></span>
<span id="cb68-129"><a href="#cb68-129" aria-hidden="true" tabindex="-1"></a>  <span class="at">simd_quintile =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, </span>
<span id="cb68-130"><a href="#cb68-130" aria-hidden="true" tabindex="-1"></a>                         <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.22</span>, <span class="fl">0.20</span>, <span class="fl">0.18</span>, <span class="fl">0.15</span>)),</span>
<span id="cb68-131"><a href="#cb68-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-132"><a href="#cb68-132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clinical characteristics</span></span>
<span id="cb68-133"><a href="#cb68-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">ecog_ps =</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>, n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.30</span>, <span class="fl">0.40</span>, <span class="fl">0.22</span>, <span class="fl">0.08</span>)),</span>
<span id="cb68-134"><a href="#cb68-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-135"><a href="#cb68-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Receptor status</span></span>
<span id="cb68-136"><a href="#cb68-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">er_status =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Positive"</span>, <span class="st">"Negative"</span>), n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.75</span>, <span class="fl">0.25</span>)),</span>
<span id="cb68-137"><a href="#cb68-137" aria-hidden="true" tabindex="-1"></a>  <span class="at">pr_status =</span> <span class="fu">if_else</span>(</span>
<span id="cb68-138"><a href="#cb68-138" aria-hidden="true" tabindex="-1"></a>    er_status <span class="sc">==</span> <span class="st">"Positive"</span>,</span>
<span id="cb68-139"><a href="#cb68-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Positive"</span>, <span class="st">"Negative"</span>), n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.85</span>, <span class="fl">0.15</span>)),</span>
<span id="cb68-140"><a href="#cb68-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Positive"</span>, <span class="st">"Negative"</span>), n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.10</span>, <span class="fl">0.90</span>))</span>
<span id="cb68-141"><a href="#cb68-141" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb68-142"><a href="#cb68-142" aria-hidden="true" tabindex="-1"></a>  <span class="at">her2_status =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Positive"</span>, <span class="st">"Negative"</span>), n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.20</span>, <span class="fl">0.80</span>)),</span>
<span id="cb68-143"><a href="#cb68-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-144"><a href="#cb68-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Metastatic sites</span></span>
<span id="cb68-145"><a href="#cb68-145" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_metastatic_sites =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.35</span>, <span class="fl">0.30</span>, <span class="fl">0.20</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>)),</span>
<span id="cb68-146"><a href="#cb68-146" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-147"><a href="#cb68-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sites of metastasis</span></span>
<span id="cb68-148"><a href="#cb68-148" aria-hidden="true" tabindex="-1"></a>  <span class="at">bone_mets =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>), n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.70</span>, <span class="fl">0.30</span>)),</span>
<span id="cb68-149"><a href="#cb68-149" aria-hidden="true" tabindex="-1"></a>  <span class="at">liver_mets =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>), n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.35</span>, <span class="fl">0.65</span>)),</span>
<span id="cb68-150"><a href="#cb68-150" aria-hidden="true" tabindex="-1"></a>  <span class="at">lung_mets =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>), n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.30</span>, <span class="fl">0.70</span>)),</span>
<span id="cb68-151"><a href="#cb68-151" aria-hidden="true" tabindex="-1"></a>  <span class="at">brain_mets =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>), n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.10</span>, <span class="fl">0.90</span>)),</span>
<span id="cb68-152"><a href="#cb68-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-153"><a href="#cb68-153" aria-hidden="true" tabindex="-1"></a>  <span class="co"># De novo vs recurrent</span></span>
<span id="cb68-154"><a href="#cb68-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-155"><a href="#cb68-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">presentation =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"De novo metastatic"</span>, <span class="st">"Recurrent"</span>), n_patients, </span>
<span id="cb68-156"><a href="#cb68-156" aria-hidden="true" tabindex="-1"></a>                        <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.30</span>, <span class="fl">0.70</span>)),</span>
<span id="cb68-157"><a href="#cb68-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-158"><a href="#cb68-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Diagnosis date (between 2018-2022)</span></span>
<span id="cb68-159"><a href="#cb68-159" aria-hidden="true" tabindex="-1"></a>  <span class="at">diagnosis_date =</span> <span class="fu">as.Date</span>(<span class="st">"2018-01-01"</span>) <span class="sc">+</span> </span>
<span id="cb68-160"><a href="#cb68-160" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1825</span>, n_patients, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-161"><a href="#cb68-161" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-162"><a href="#cb68-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-163"><a href="#cb68-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Add treatment based on receptor status</span></span>
<span id="cb68-164"><a href="#cb68-164" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-165"><a href="#cb68-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-166"><a href="#cb68-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_line_treatment =</span> <span class="fu">case_when</span>(</span>
<span id="cb68-167"><a href="#cb68-167" aria-hidden="true" tabindex="-1"></a>      er_status <span class="sc">==</span> <span class="st">"Positive"</span> <span class="sc">&amp;</span> her2_status <span class="sc">==</span> <span class="st">"Negative"</span> <span class="sc">~</span> </span>
<span id="cb68-168"><a href="#cb68-168" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Endocrine only"</span>, <span class="st">"Endocrine + Targeted"</span>, <span class="st">"Chemotherapy"</span>), </span>
<span id="cb68-169"><a href="#cb68-169" aria-hidden="true" tabindex="-1"></a>               <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.55</span>, <span class="fl">0.20</span>)),</span>
<span id="cb68-170"><a href="#cb68-170" aria-hidden="true" tabindex="-1"></a>      er_status <span class="sc">==</span> <span class="st">"Positive"</span> <span class="sc">&amp;</span> her2_status <span class="sc">==</span> <span class="st">"Positive"</span> <span class="sc">~</span></span>
<span id="cb68-171"><a href="#cb68-171" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Endocrine + Targeted"</span>, <span class="st">"Chemo + Targeted"</span>), </span>
<span id="cb68-172"><a href="#cb68-172" aria-hidden="true" tabindex="-1"></a>               <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.40</span>, <span class="fl">0.60</span>)),</span>
<span id="cb68-173"><a href="#cb68-173" aria-hidden="true" tabindex="-1"></a>      er_status <span class="sc">==</span> <span class="st">"Negative"</span> <span class="sc">&amp;</span> her2_status <span class="sc">==</span> <span class="st">"Positive"</span> <span class="sc">~</span></span>
<span id="cb68-174"><a href="#cb68-174" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Chemo + Targeted"</span>, <span class="st">"Chemotherapy"</span>), </span>
<span id="cb68-175"><a href="#cb68-175" aria-hidden="true" tabindex="-1"></a>               <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.85</span>, <span class="fl">0.15</span>)),</span>
<span id="cb68-176"><a href="#cb68-176" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Chemotherapy"</span></span>
<span id="cb68-177"><a href="#cb68-177" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-178"><a href="#cb68-178" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-179"><a href="#cb68-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-180"><a href="#cb68-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Regenerate treatment properly (row-wise)</span></span>
<span id="cb68-181"><a href="#cb68-181" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-182"><a href="#cb68-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb68-183"><a href="#cb68-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-184"><a href="#cb68-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_line_treatment =</span> <span class="fu">case_when</span>(</span>
<span id="cb68-185"><a href="#cb68-185" aria-hidden="true" tabindex="-1"></a>      er_status <span class="sc">==</span> <span class="st">"Positive"</span> <span class="sc">&amp;</span> her2_status <span class="sc">==</span> <span class="st">"Negative"</span> <span class="sc">~</span> </span>
<span id="cb68-186"><a href="#cb68-186" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Endocrine only"</span>, <span class="st">"Endocrine + Targeted"</span>, <span class="st">"Chemotherapy"</span>), </span>
<span id="cb68-187"><a href="#cb68-187" aria-hidden="true" tabindex="-1"></a>               <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.55</span>, <span class="fl">0.20</span>)),</span>
<span id="cb68-188"><a href="#cb68-188" aria-hidden="true" tabindex="-1"></a>      er_status <span class="sc">==</span> <span class="st">"Positive"</span> <span class="sc">&amp;</span> her2_status <span class="sc">==</span> <span class="st">"Positive"</span> <span class="sc">~</span></span>
<span id="cb68-189"><a href="#cb68-189" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Endocrine + Targeted"</span>, <span class="st">"Chemo + Targeted"</span>), </span>
<span id="cb68-190"><a href="#cb68-190" aria-hidden="true" tabindex="-1"></a>               <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.40</span>, <span class="fl">0.60</span>)),</span>
<span id="cb68-191"><a href="#cb68-191" aria-hidden="true" tabindex="-1"></a>      er_status <span class="sc">==</span> <span class="st">"Negative"</span> <span class="sc">&amp;</span> her2_status <span class="sc">==</span> <span class="st">"Positive"</span> <span class="sc">~</span></span>
<span id="cb68-192"><a href="#cb68-192" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Chemo + Targeted"</span>, <span class="st">"Chemotherapy"</span>), </span>
<span id="cb68-193"><a href="#cb68-193" aria-hidden="true" tabindex="-1"></a>               <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.85</span>, <span class="fl">0.15</span>)),</span>
<span id="cb68-194"><a href="#cb68-194" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Chemotherapy"</span></span>
<span id="cb68-195"><a href="#cb68-195" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-196"><a href="#cb68-196" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-197"><a href="#cb68-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb68-198"><a href="#cb68-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-199"><a href="#cb68-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Constrain age</span></span>
<span id="cb68-200"><a href="#cb68-200" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-201"><a href="#cb68-201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_at_diagnosis =</span> <span class="fu">pmax</span>(<span class="fu">pmin</span>(age_at_diagnosis, <span class="dv">95</span>), <span class="dv">25</span>))</span>
<span id="cb68-202"><a href="#cb68-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-203"><a href="#cb68-203" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate survival times</span></span>
<span id="cb68-204"><a href="#cb68-204" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-205"><a href="#cb68-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-206"><a href="#cb68-206" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival_months =</span> <span class="fu">generate_survival_data</span>(</span>
<span id="cb68-207"><a href="#cb68-207" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb68-208"><a href="#cb68-208" aria-hidden="true" tabindex="-1"></a>      <span class="at">age =</span> age_at_diagnosis,</span>
<span id="cb68-209"><a href="#cb68-209" aria-hidden="true" tabindex="-1"></a>      <span class="at">ecog =</span> ecog_ps,</span>
<span id="cb68-210"><a href="#cb68-210" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_mets_sites =</span> n_metastatic_sites,</span>
<span id="cb68-211"><a href="#cb68-211" aria-hidden="true" tabindex="-1"></a>      <span class="at">er_status =</span> er_status,</span>
<span id="cb68-212"><a href="#cb68-212" aria-hidden="true" tabindex="-1"></a>      <span class="at">treatment =</span> first_line_treatment</span>
<span id="cb68-213"><a href="#cb68-213" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-214"><a href="#cb68-214" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-215"><a href="#cb68-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-216"><a href="#cb68-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Administrative censoring at study end (December 2023)</span></span>
<span id="cb68-217"><a href="#cb68-217" aria-hidden="true" tabindex="-1"></a>study_end <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2023-12-31"</span>)</span>
<span id="cb68-218"><a href="#cb68-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-219"><a href="#cb68-219" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-220"><a href="#cb68-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-221"><a href="#cb68-221" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate potential follow-up time</span></span>
<span id="cb68-222"><a href="#cb68-222" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_follow_up =</span> <span class="fu">as.numeric</span>(<span class="fu">difftime</span>(study_end, diagnosis_date, <span class="at">units =</span> <span class="st">"days"</span>)) <span class="sc">/</span> <span class="fl">30.44</span>,</span>
<span id="cb68-223"><a href="#cb68-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-224"><a href="#cb68-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply censoring</span></span>
<span id="cb68-225"><a href="#cb68-225" aria-hidden="true" tabindex="-1"></a>    <span class="at">observed_time =</span> <span class="fu">pmin</span>(survival_months, max_follow_up),</span>
<span id="cb68-226"><a href="#cb68-226" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-227"><a href="#cb68-227" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Event indicator (1 = death, 0 = censored)</span></span>
<span id="cb68-228"><a href="#cb68-228" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> <span class="fu">if_else</span>(survival_months <span class="sc">&lt;=</span> max_follow_up, <span class="dv">1</span>L, <span class="dv">0</span>L),</span>
<span id="cb68-229"><a href="#cb68-229" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-230"><a href="#cb68-230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Round observed time</span></span>
<span id="cb68-231"><a href="#cb68-231" aria-hidden="true" tabindex="-1"></a>    <span class="at">observed_time =</span> <span class="fu">round</span>(observed_time, <span class="dv">1</span>)</span>
<span id="cb68-232"><a href="#cb68-232" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-233"><a href="#cb68-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>survival_months, <span class="sc">-</span>max_follow_up)</span>
<span id="cb68-234"><a href="#cb68-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-235"><a href="#cb68-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Create age groups</span></span>
<span id="cb68-236"><a href="#cb68-236" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-237"><a href="#cb68-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-238"><a href="#cb68-238" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_group =</span> <span class="fu">cut</span>(</span>
<span id="cb68-239"><a href="#cb68-239" aria-hidden="true" tabindex="-1"></a>      age_at_diagnosis,</span>
<span id="cb68-240"><a href="#cb68-240" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">65</span>, <span class="dv">75</span>, <span class="cn">Inf</span>),</span>
<span id="cb68-241"><a href="#cb68-241" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"&lt;50"</span>, <span class="st">"50-64"</span>, <span class="st">"65-74"</span>, <span class="st">"75+"</span>),</span>
<span id="cb68-242"><a href="#cb68-242" aria-hidden="true" tabindex="-1"></a>      <span class="at">right =</span> <span class="cn">FALSE</span></span>
<span id="cb68-243"><a href="#cb68-243" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb68-244"><a href="#cb68-244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create binary ER status for simpler analyses</span></span>
<span id="cb68-245"><a href="#cb68-245" aria-hidden="true" tabindex="-1"></a>    <span class="at">hormone_receptor =</span> <span class="fu">if_else</span>(er_status <span class="sc">==</span> <span class="st">"Positive"</span> <span class="sc">|</span> pr_status <span class="sc">==</span> <span class="st">"Positive"</span>,</span>
<span id="cb68-246"><a href="#cb68-246" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"HR-positive"</span>, <span class="st">"HR-negative"</span>)</span>
<span id="cb68-247"><a href="#cb68-247" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-248"><a href="#cb68-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-249"><a href="#cb68-249" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to Excel</span></span>
<span id="cb68-250"><a href="#cb68-250" aria-hidden="true" tabindex="-1"></a><span class="fu">write_xlsx</span>(mbc_data, <span class="st">"scottish_mbc_cohort.xlsx"</span>)</span>
<span id="cb68-251"><a href="#cb68-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-252"><a href="#cb68-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-253"><a href="#cb68-253" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb68-254"><a href="#cb68-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-255"><a href="#cb68-255" aria-hidden="true" tabindex="-1"></a>This tutorial provides a practical introduction to survival analysis using R, illustrated with a synthetic cohort of patients with metastatic breast cancer from Scottish NHS Health Boards. By the end of this tutorial, you will be able to:</span>
<span id="cb68-256"><a href="#cb68-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-257"><a href="#cb68-257" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Create and interpret survival objects</span>
<span id="cb68-258"><a href="#cb68-258" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Fit and visualise Kaplan-Meier survival curves</span>
<span id="cb68-259"><a href="#cb68-259" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Conduct log-rank tests to compare survival between groups</span>
<span id="cb68-260"><a href="#cb68-260" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Fit Cox proportional hazards regression models</span>
<span id="cb68-261"><a href="#cb68-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-262"><a href="#cb68-262" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb68-263"><a href="#cb68-263" aria-hidden="true" tabindex="-1"></a><span class="fu">## About the Data</span></span>
<span id="cb68-264"><a href="#cb68-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-265"><a href="#cb68-265" aria-hidden="true" tabindex="-1"></a>The dataset used in this tutorial is **entirely synthetic** and was generated for educational purposes. It does not contain any real patient data but has been designed to reflect realistic patterns seen in metastatic breast cancer populations.</span>
<span id="cb68-266"><a href="#cb68-266" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-267"><a href="#cb68-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-268"><a href="#cb68-268" aria-hidden="true" tabindex="-1"></a><span class="fu"># Why Survival Analysis?</span></span>
<span id="cb68-269"><a href="#cb68-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-270"><a href="#cb68-270" aria-hidden="true" tabindex="-1"></a>Before diving into the methods, it's worth understanding why we need specialised techniques for time-to-event data.</span>
<span id="cb68-271"><a href="#cb68-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-272"><a href="#cb68-272" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Problem with Standard Methods</span></span>
<span id="cb68-273"><a href="#cb68-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-274"><a href="#cb68-274" aria-hidden="true" tabindex="-1"></a>Imagine you're analysing a clinical trial where patients were followed for up to 5 years. At the end of the study, some patients have died, but others are still alive. If you simply calculate the proportion who died, you're ignoring valuable information — patients who were still alive contributed follow-up time showing they *survived at least that long*.</span>
<span id="cb68-275"><a href="#cb68-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-276"><a href="#cb68-276" aria-hidden="true" tabindex="-1"></a>This is the problem of **censoring**. A patient is censored when we know they survived up to a certain point, but we don't know what happened after that. Common reasons for censoring include:</span>
<span id="cb68-277"><a href="#cb68-277" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The study ended while the patient was still alive</span>
<span id="cb68-278"><a href="#cb68-278" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The patient was lost to follow-up</span>
<span id="cb68-279"><a href="#cb68-279" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The patient withdrew from the study</span>
<span id="cb68-280"><a href="#cb68-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-281"><a href="#cb68-281" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Happens If We Ignore Censoring?</span></span>
<span id="cb68-282"><a href="#cb68-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-283"><a href="#cb68-283" aria-hidden="true" tabindex="-1"></a>Consider a simple example with 10 patients. Five died during follow-up, three were still alive when the study ended (censored), and two were lost to follow-up (also censored).</span>
<span id="cb68-284"><a href="#cb68-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-285"><a href="#cb68-285" aria-hidden="true" tabindex="-1"></a>If we naively calculate survival as "proportion who didn't die", we might include the censored patients in the denominator as if they were followed for the entire study period. This **overestimates survival** because we're treating patients with incomplete follow-up as if they definitely survived.</span>
<span id="cb68-286"><a href="#cb68-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-287"><a href="#cb68-287" aria-hidden="true" tabindex="-1"></a>Conversely, if we calculate median survival time only among those who died, we **underestimate** it because we're excluding patients who survived longer but were censored.</span>
<span id="cb68-288"><a href="#cb68-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-289"><a href="#cb68-289" aria-hidden="true" tabindex="-1"></a>Survival analysis methods — particularly the Kaplan-Meier estimator — correctly account for censored observations by including each patient's follow-up time in the analysis up until the point they were censored.</span>
<span id="cb68-290"><a href="#cb68-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-291"><a href="#cb68-291" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Concepts</span></span>
<span id="cb68-292"><a href="#cb68-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-293"><a href="#cb68-293" aria-hidden="true" tabindex="-1"></a>**Survival function S(t)**: The probability of surviving beyond time *t*. It starts at 1 (everyone alive at time 0) and decreases over time.</span>
<span id="cb68-294"><a href="#cb68-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-295"><a href="#cb68-295" aria-hidden="true" tabindex="-1"></a>**Hazard**: The instantaneous risk of the event occurring at time *t*, given that the individual has survived up to that point. Think of it as the "danger" at each moment.</span>
<span id="cb68-296"><a href="#cb68-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-297"><a href="#cb68-297" aria-hidden="true" tabindex="-1"></a>**Censoring**: When we have incomplete information about a patient's outcome. Most commonly "right-censoring" — we know the patient survived *at least* until a certain time, but not what happened afterwards.</span>
<span id="cb68-298"><a href="#cb68-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-299"><a href="#cb68-299" aria-hidden="true" tabindex="-1"></a>**Proportional hazards**: The assumption (used in Cox regression) that the ratio of hazards between groups remains constant over time. This doesn't mean hazards are constant — they can both increase or decrease — but their *ratio* stays the same.</span>
<span id="cb68-300"><a href="#cb68-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-301"><a href="#cb68-301" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Non-Informative Censoring Assumption</span></span>
<span id="cb68-302"><a href="#cb68-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-303"><a href="#cb68-303" aria-hidden="true" tabindex="-1"></a>Most survival methods assume **non-informative censoring** — that a patient's censoring time is unrelated to their underlying survival time. If this assumption is violated, survival estimates can be biased.</span>
<span id="cb68-304"><a href="#cb68-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-305"><a href="#cb68-305" aria-hidden="true" tabindex="-1"></a>**Examples of potentially informative censoring:**</span>
<span id="cb68-306"><a href="#cb68-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-307"><a href="#cb68-307" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sicker patients drop out of a study because they feel too unwell to attend appointments → survival estimates biased upward (look better than reality)</span>
<span id="cb68-308"><a href="#cb68-308" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Patients who are doing well stop attending follow-up because they feel they don't need it → survival estimates biased downward</span>
<span id="cb68-309"><a href="#cb68-309" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Patients with severe side effects withdraw from a treatment trial → treatment effect estimates biased</span>
<span id="cb68-310"><a href="#cb68-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-311"><a href="#cb68-311" aria-hidden="true" tabindex="-1"></a>When designing or analysing a study, carefully consider whether reasons for censoring might be related to prognosis. If informative censoring is suspected, sensitivity analyses or specialised methods may be needed.</span>
<span id="cb68-312"><a href="#cb68-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-313"><a href="#cb68-313" aria-hidden="true" tabindex="-1"></a><span class="fu"># Loading the Data</span></span>
<span id="cb68-314"><a href="#cb68-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-315"><a href="#cb68-315" aria-hidden="true" tabindex="-1"></a>We begin by loading our synthetic Scottish metastatic breast cancer cohort from the Excel file.</span>
<span id="cb68-316"><a href="#cb68-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-319"><a href="#cb68-319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-320"><a href="#cb68-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-data</span></span>
<span id="cb68-321"><a href="#cb68-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-322"><a href="#cb68-322" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset</span></span>
<span id="cb68-323"><a href="#cb68-323" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"scottish_mbc_cohort.xlsx"</span>)</span>
<span id="cb68-324"><a href="#cb68-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-325"><a href="#cb68-325" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview the data structure</span></span>
<span id="cb68-326"><a href="#cb68-326" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(mbc_data)</span>
<span id="cb68-327"><a href="#cb68-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-328"><a href="#cb68-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-329"><a href="#cb68-329" aria-hidden="true" tabindex="-1"></a>The dataset contains <span class="in">`r nrow(mbc_data)`</span> patients diagnosed between <span class="in">`r min(mbc_data$diagnosis_date)`</span> and <span class="in">`r max(mbc_data$diagnosis_date)`</span> across all 14 Scottish NHS Health Boards.</span>
<span id="cb68-330"><a href="#cb68-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-331"><a href="#cb68-331" aria-hidden="true" tabindex="-1"></a><span class="fu">## Calculating Survival Times from Dates</span></span>
<span id="cb68-332"><a href="#cb68-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-333"><a href="#cb68-333" aria-hidden="true" tabindex="-1"></a>In practice, clinical data often comes with dates rather than pre-calculated survival times. Here's how to calculate follow-up time from diagnosis and last contact dates using the <span class="in">`lubridate`</span> package.</span>
<span id="cb68-334"><a href="#cb68-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-337"><a href="#cb68-337" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-338"><a href="#cb68-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: date-calculation-example</span></span>
<span id="cb68-339"><a href="#cb68-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-340"><a href="#cb68-340" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Creating survival times from dates</span></span>
<span id="cb68-341"><a href="#cb68-341" aria-hidden="true" tabindex="-1"></a>date_example <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb68-342"><a href="#cb68-342" aria-hidden="true" tabindex="-1"></a>  <span class="at">patient_id =</span> <span class="fu">c</span>(<span class="st">"P001"</span>, <span class="st">"P002"</span>, <span class="st">"P003"</span>),</span>
<span id="cb68-343"><a href="#cb68-343" aria-hidden="true" tabindex="-1"></a>  <span class="at">diagnosis_date =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2020-03-15"</span>, <span class="st">"2019-08-22"</span>, <span class="st">"2021-01-10"</span>)),</span>
<span id="cb68-344"><a href="#cb68-344" aria-hidden="true" tabindex="-1"></a>  <span class="at">last_contact_date =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">"2023-06-20"</span>, <span class="st">"2022-04-15"</span>, <span class="st">"2023-12-31"</span>)),</span>
<span id="cb68-345"><a href="#cb68-345" aria-hidden="true" tabindex="-1"></a>  <span class="at">status =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)  <span class="co"># 1 = died, 0 = alive/censored</span></span>
<span id="cb68-346"><a href="#cb68-346" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-347"><a href="#cb68-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-348"><a href="#cb68-348" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate follow-up time in months</span></span>
<span id="cb68-349"><a href="#cb68-349" aria-hidden="true" tabindex="-1"></a>date_example <span class="ot">&lt;-</span> date_example <span class="sc">|&gt;</span></span>
<span id="cb68-350"><a href="#cb68-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-351"><a href="#cb68-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">follow_up_months =</span> <span class="fu">as.numeric</span>(</span>
<span id="cb68-352"><a href="#cb68-352" aria-hidden="true" tabindex="-1"></a>      <span class="fu">difftime</span>(last_contact_date, diagnosis_date, <span class="at">units =</span> <span class="st">"days"</span>)</span>
<span id="cb68-353"><a href="#cb68-353" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">/</span> <span class="fl">30.44</span>  <span class="co"># average days per month</span></span>
<span id="cb68-354"><a href="#cb68-354" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-355"><a href="#cb68-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-356"><a href="#cb68-356" aria-hidden="true" tabindex="-1"></a>date_example <span class="sc">|&gt;</span></span>
<span id="cb68-357"><a href="#cb68-357" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">1</span>)</span>
<span id="cb68-358"><a href="#cb68-358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-359"><a href="#cb68-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-360"><a href="#cb68-360" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb68-361"><a href="#cb68-361" aria-hidden="true" tabindex="-1"></a><span class="fu">## Time Units</span></span>
<span id="cb68-362"><a href="#cb68-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-363"><a href="#cb68-363" aria-hidden="true" tabindex="-1"></a>Choose time units appropriate for your disease. For aggressive cancers like metastatic breast cancer, months are sensible. For slow-growing conditions, years might be better. Whatever you choose, be consistent throughout your analysis.</span>
<span id="cb68-364"><a href="#cb68-364" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-365"><a href="#cb68-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-366"><a href="#cb68-366" aria-hidden="true" tabindex="-1"></a><span class="fu"># Patient Characteristics</span></span>
<span id="cb68-367"><a href="#cb68-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-368"><a href="#cb68-368" aria-hidden="true" tabindex="-1"></a>Before conducting survival analysis, it is essential to understand the composition of our cohort. We present descriptive statistics stratified by hormone receptor status.</span>
<span id="cb68-369"><a href="#cb68-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-370"><a href="#cb68-370" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary Table</span></span>
<span id="cb68-371"><a href="#cb68-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-374"><a href="#cb68-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-375"><a href="#cb68-375" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-characteristics</span></span>
<span id="cb68-376"><a href="#cb68-376" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Patient characteristics by hormone receptor status"</span></span>
<span id="cb68-377"><a href="#cb68-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-378"><a href="#cb68-378" aria-hidden="true" tabindex="-1"></a><span class="co"># Create summary table</span></span>
<span id="cb68-379"><a href="#cb68-379" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-380"><a href="#cb68-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-381"><a href="#cb68-381" aria-hidden="true" tabindex="-1"></a>    <span class="at">simd_quintile =</span> <span class="fu">factor</span>(simd_quintile),</span>
<span id="cb68-382"><a href="#cb68-382" aria-hidden="true" tabindex="-1"></a>    <span class="at">ecog_ps =</span> <span class="fu">factor</span>(ecog_ps),</span>
<span id="cb68-383"><a href="#cb68-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">status =</span> <span class="fu">factor</span>(status, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Censored"</span>, <span class="st">"Died"</span>))</span>
<span id="cb68-384"><a href="#cb68-384" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-385"><a href="#cb68-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb68-386"><a href="#cb68-386" aria-hidden="true" tabindex="-1"></a>    hormone_receptor, age_at_diagnosis, age_group, sex, simd_quintile, ecog_ps,</span>
<span id="cb68-387"><a href="#cb68-387" aria-hidden="true" tabindex="-1"></a>    er_status, pr_status, her2_status,</span>
<span id="cb68-388"><a href="#cb68-388" aria-hidden="true" tabindex="-1"></a>    n_metastatic_sites, bone_mets, liver_mets, lung_mets, brain_mets,</span>
<span id="cb68-389"><a href="#cb68-389" aria-hidden="true" tabindex="-1"></a>    presentation, first_line_treatment, observed_time, status</span>
<span id="cb68-390"><a href="#cb68-390" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-391"><a href="#cb68-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_summary</span>(</span>
<span id="cb68-392"><a href="#cb68-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> hormone_receptor,</span>
<span id="cb68-393"><a href="#cb68-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">statistic =</span> <span class="fu">list</span>(</span>
<span id="cb68-394"><a href="#cb68-394" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="st">"{median} ({p25}, {p75})"</span>,</span>
<span id="cb68-395"><a href="#cb68-395" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all_categorical</span>() <span class="sc">~</span> <span class="st">"{n} ({p}%)"</span></span>
<span id="cb68-396"><a href="#cb68-396" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb68-397"><a href="#cb68-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">digits =</span> <span class="fu">list</span>(<span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="dv">1</span>),</span>
<span id="cb68-398"><a href="#cb68-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing =</span> <span class="st">"ifany"</span></span>
<span id="cb68-399"><a href="#cb68-399" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-400"><a href="#cb68-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_overall</span>() <span class="sc">|&gt;</span></span>
<span id="cb68-401"><a href="#cb68-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>()</span>
<span id="cb68-402"><a href="#cb68-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-403"><a href="#cb68-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-404"><a href="#cb68-404" aria-hidden="true" tabindex="-1"></a><span class="fu">## Distribution by Health Board</span></span>
<span id="cb68-405"><a href="#cb68-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-408"><a href="#cb68-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-409"><a href="#cb68-409" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-healthboard</span></span>
<span id="cb68-410"><a href="#cb68-410" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Patient distribution across Scottish NHS Health Boards"</span></span>
<span id="cb68-411"><a href="#cb68-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-412"><a href="#cb68-412" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-413"><a href="#cb68-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(health_board) <span class="sc">|&gt;</span></span>
<span id="cb68-414"><a href="#cb68-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">health_board =</span> <span class="fu">fct_reorder</span>(health_board, n)) <span class="sc">|&gt;</span></span>
<span id="cb68-415"><a href="#cb68-415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n, <span class="at">y =</span> health_board, <span class="at">fill =</span> n)) <span class="sc">+</span></span>
<span id="cb68-416"><a href="#cb68-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb68-417"><a href="#cb68-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> n), <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.2</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb68-418"><a href="#cb68-418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"plasma"</span>, <span class="at">end =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb68-419"><a href="#cb68-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.15</span>))) <span class="sc">+</span></span>
<span id="cb68-420"><a href="#cb68-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-421"><a href="#cb68-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Number of patients"</span>,</span>
<span id="cb68-422"><a href="#cb68-422" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb68-423"><a href="#cb68-423" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Patient distribution by NHS Health Board"</span></span>
<span id="cb68-424"><a href="#cb68-424" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-425"><a href="#cb68-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb68-426"><a href="#cb68-426" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb68-427"><a href="#cb68-427" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb68-428"><a href="#cb68-428" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb68-429"><a href="#cb68-429" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-430"><a href="#cb68-430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-431"><a href="#cb68-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-432"><a href="#cb68-432" aria-hidden="true" tabindex="-1"></a><span class="fu"># Creating a Survival Object</span></span>
<span id="cb68-433"><a href="#cb68-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-434"><a href="#cb68-434" aria-hidden="true" tabindex="-1"></a>The foundation of survival analysis in R is the <span class="in">`Surv()`</span> function from the <span class="in">`survival`</span> package. This function creates a special object that encodes both the time-to-event and the censoring indicator.</span>
<span id="cb68-435"><a href="#cb68-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-436"><a href="#cb68-436" aria-hidden="true" tabindex="-1"></a><span class="fu">## Understanding Censoring</span></span>
<span id="cb68-437"><a href="#cb68-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-438"><a href="#cb68-438" aria-hidden="true" tabindex="-1"></a>In our dataset:</span>
<span id="cb68-439"><a href="#cb68-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-440"><a href="#cb68-440" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`observed_time`</span>: Time from diagnosis to death or last follow-up (months)</span>
<span id="cb68-441"><a href="#cb68-441" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`status`</span>: Event indicator (1 = death occurred, 0 = censored/alive)</span>
<span id="cb68-442"><a href="#cb68-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-443"><a href="#cb68-443" aria-hidden="true" tabindex="-1"></a>Censoring occurs when we do not observe the event of interest. In this study, patients are censored if they were still alive at the end of the study period.</span>
<span id="cb68-444"><a href="#cb68-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-445"><a href="#cb68-445" aria-hidden="true" tabindex="-1"></a><span class="fu">## Creating the Survival Object</span></span>
<span id="cb68-446"><a href="#cb68-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-449"><a href="#cb68-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-450"><a href="#cb68-450" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: surv-object</span></span>
<span id="cb68-451"><a href="#cb68-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-452"><a href="#cb68-452" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the survival object</span></span>
<span id="cb68-453"><a href="#cb68-453" aria-hidden="true" tabindex="-1"></a>surv_obj <span class="ot">&lt;-</span> <span class="fu">Surv</span>(<span class="at">time =</span> mbc_data<span class="sc">$</span>observed_time, </span>
<span id="cb68-454"><a href="#cb68-454" aria-hidden="true" tabindex="-1"></a>                 <span class="at">event =</span> mbc_data<span class="sc">$</span>status)</span>
<span id="cb68-455"><a href="#cb68-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-456"><a href="#cb68-456" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the first 20 observations</span></span>
<span id="cb68-457"><a href="#cb68-457" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(surv_obj, <span class="dv">20</span>)</span>
<span id="cb68-458"><a href="#cb68-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-459"><a href="#cb68-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-460"><a href="#cb68-460" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb68-461"><a href="#cb68-461" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting the Output</span></span>
<span id="cb68-462"><a href="#cb68-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-463"><a href="#cb68-463" aria-hidden="true" tabindex="-1"></a>In the survival object:</span>
<span id="cb68-464"><a href="#cb68-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-465"><a href="#cb68-465" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Numbers without a <span class="in">`+`</span> indicate observed events (deaths)</span>
<span id="cb68-466"><a href="#cb68-466" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Numbers with a <span class="in">`+`</span> indicate censored observations (patient was alive at that time)</span>
<span id="cb68-467"><a href="#cb68-467" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-468"><a href="#cb68-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-469"><a href="#cb68-469" aria-hidden="true" tabindex="-1"></a><span class="fu"># Kaplan-Meier Survival Estimation</span></span>
<span id="cb68-470"><a href="#cb68-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-471"><a href="#cb68-471" aria-hidden="true" tabindex="-1"></a>The Kaplan-Meier (KM) estimator is a non-parametric method for estimating the survival function from observed survival times.</span>
<span id="cb68-472"><a href="#cb68-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-473"><a href="#cb68-473" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting the KM Curve</span></span>
<span id="cb68-474"><a href="#cb68-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-477"><a href="#cb68-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-478"><a href="#cb68-478" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: km-fit</span></span>
<span id="cb68-479"><a href="#cb68-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-480"><a href="#cb68-480" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Kaplan-Meier estimator for the entire cohort</span></span>
<span id="cb68-481"><a href="#cb68-481" aria-hidden="true" tabindex="-1"></a>km_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> mbc_data)</span>
<span id="cb68-482"><a href="#cb68-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-483"><a href="#cb68-483" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the KM fit</span></span>
<span id="cb68-484"><a href="#cb68-484" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(km_fit, <span class="at">times =</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">36</span>, <span class="dv">48</span>, <span class="dv">60</span>), <span class="at">extend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-485"><a href="#cb68-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-486"><a href="#cb68-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-487"><a href="#cb68-487" aria-hidden="true" tabindex="-1"></a>The output shows survival probabilities at specific time points with 95% confidence intervals.</span>
<span id="cb68-488"><a href="#cb68-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-489"><a href="#cb68-489" aria-hidden="true" tabindex="-1"></a><span class="fu">## Plotting the Overall Survival Curve</span></span>
<span id="cb68-490"><a href="#cb68-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-493"><a href="#cb68-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-494"><a href="#cb68-494" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-km-overall</span></span>
<span id="cb68-495"><a href="#cb68-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Overall survival in the Scottish metastatic breast cancer cohort"</span></span>
<span id="cb68-496"><a href="#cb68-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-497"><a href="#cb68-497" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb68-498"><a href="#cb68-498" aria-hidden="true" tabindex="-1"></a>  km_fit,</span>
<span id="cb68-499"><a href="#cb68-499" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb68-500"><a href="#cb68-500" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb68-501"><a href="#cb68-501" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-502"><a href="#cb68-502" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.col =</span> <span class="st">"strata"</span>,</span>
<span id="cb68-503"><a href="#cb68-503" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.height =</span> <span class="fl">0.25</span>,</span>
<span id="cb68-504"><a href="#cb68-504" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb68-505"><a href="#cb68-505" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb68-506"><a href="#cb68-506" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival in Metastatic Breast Cancer"</span>,</span>
<span id="cb68-507"><a href="#cb68-507" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb68-508"><a href="#cb68-508" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="st">"#2E86AB"</span>,</span>
<span id="cb68-509"><a href="#cb68-509" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span>,</span>
<span id="cb68-510"><a href="#cb68-510" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv.median.line =</span> <span class="st">"hv"</span></span>
<span id="cb68-511"><a href="#cb68-511" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-512"><a href="#cb68-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-513"><a href="#cb68-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-514"><a href="#cb68-514" aria-hidden="true" tabindex="-1"></a><span class="fu">## Median Survival Time</span></span>
<span id="cb68-515"><a href="#cb68-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-518"><a href="#cb68-518" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-519"><a href="#cb68-519" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: median-survival</span></span>
<span id="cb68-520"><a href="#cb68-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-521"><a href="#cb68-521" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract median survival with confidence interval</span></span>
<span id="cb68-522"><a href="#cb68-522" aria-hidden="true" tabindex="-1"></a>surv_median <span class="ot">&lt;-</span> <span class="fu">surv_median</span>(km_fit)</span>
<span id="cb68-523"><a href="#cb68-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-524"><a href="#cb68-524" aria-hidden="true" tabindex="-1"></a>surv_median <span class="sc">|&gt;</span></span>
<span id="cb68-525"><a href="#cb68-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb68-526"><a href="#cb68-526" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Strata"</span>, <span class="st">"Median"</span>, <span class="st">"Lower 95% CI"</span>, <span class="st">"Upper 95% CI"</span>),</span>
<span id="cb68-527"><a href="#cb68-527" aria-hidden="true" tabindex="-1"></a>    <span class="at">digits =</span> <span class="dv">1</span>,</span>
<span id="cb68-528"><a href="#cb68-528" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Median overall survival (months)"</span></span>
<span id="cb68-529"><a href="#cb68-529" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-530"><a href="#cb68-530" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-531"><a href="#cb68-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-532"><a href="#cb68-532" aria-hidden="true" tabindex="-1"></a>The median survival time is the time at which 50% of patients have experienced the event. It's the preferred measure of "average" survival because survival times are typically skewed — a few long survivors can dramatically inflate the mean.</span>
<span id="cb68-533"><a href="#cb68-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-534"><a href="#cb68-534" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimating Survival at Specific Time Points</span></span>
<span id="cb68-535"><a href="#cb68-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-536"><a href="#cb68-536" aria-hidden="true" tabindex="-1"></a>Often we want to report survival probability at clinically meaningful time points, such as 1-year or 2-year survival.</span>
<span id="cb68-537"><a href="#cb68-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-540"><a href="#cb68-540" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-541"><a href="#cb68-541" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: survival-timepoints</span></span>
<span id="cb68-542"><a href="#cb68-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-543"><a href="#cb68-543" aria-hidden="true" tabindex="-1"></a><span class="co"># Get survival estimates at specific times</span></span>
<span id="cb68-544"><a href="#cb68-544" aria-hidden="true" tabindex="-1"></a>time_points <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">36</span>, <span class="dv">48</span>, <span class="dv">60</span>)  <span class="co"># months</span></span>
<span id="cb68-545"><a href="#cb68-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-546"><a href="#cb68-546" aria-hidden="true" tabindex="-1"></a>surv_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(km_fit, <span class="at">times =</span> time_points, <span class="at">extend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-547"><a href="#cb68-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-548"><a href="#cb68-548" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a nice table</span></span>
<span id="cb68-549"><a href="#cb68-549" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb68-550"><a href="#cb68-550" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Time (months)</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>time,</span>
<span id="cb68-551"><a href="#cb68-551" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">N at risk</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>n.risk,</span>
<span id="cb68-552"><a href="#cb68-552" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">Survival probability</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>surv,</span>
<span id="cb68-553"><a href="#cb68-553" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">95% CI lower</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>lower,</span>
<span id="cb68-554"><a href="#cb68-554" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">95% CI upper</span><span class="st">`</span> <span class="ot">=</span> surv_summary<span class="sc">$</span>upper</span>
<span id="cb68-555"><a href="#cb68-555" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb68-556"><a href="#cb68-556" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-557"><a href="#cb68-557" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Survival (95% CI)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%% (%.1f%%-%.1f%%)"</span>, </span>
<span id="cb68-558"><a href="#cb68-558" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">`</span><span class="at">Survival probability</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb68-559"><a href="#cb68-559" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">`</span><span class="at">95% CI lower</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb68-560"><a href="#cb68-560" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">`</span><span class="at">95% CI upper</span><span class="st">`</span> <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb68-561"><a href="#cb68-561" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-562"><a href="#cb68-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">Time (months)</span><span class="st">`</span>, <span class="st">`</span><span class="at">N at risk</span><span class="st">`</span>, <span class="st">`</span><span class="at">Survival (95% CI)</span><span class="st">`</span>) <span class="sc">|&gt;</span></span>
<span id="cb68-563"><a href="#cb68-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span>
<span id="cb68-564"><a href="#cb68-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-565"><a href="#cb68-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-566"><a href="#cb68-566" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb68-567"><a href="#cb68-567" aria-hidden="true" tabindex="-1"></a><span class="fu">## Don't Ignore Censoring!</span></span>
<span id="cb68-568"><a href="#cb68-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-569"><a href="#cb68-569" aria-hidden="true" tabindex="-1"></a>A common mistake is to calculate survival as simply "number who didn't die / total number". This ignores censoring and will give you biased estimates. Always use proper survival analysis methods like Kaplan-Meier.</span>
<span id="cb68-570"><a href="#cb68-570" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-571"><a href="#cb68-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-572"><a href="#cb68-572" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb68-573"><a href="#cb68-573" aria-hidden="true" tabindex="-1"></a><span class="fu">## The `extend` Argument</span></span>
<span id="cb68-574"><a href="#cb68-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-575"><a href="#cb68-575" aria-hidden="true" tabindex="-1"></a>When using <span class="in">`summary()`</span> on a survfit object with specific time points, you may encounter an error if a requested time exceeds the maximum follow-up in your data. Setting <span class="in">`extend = TRUE`</span> allows the function to return the last known survival estimate for times beyond the data — essentially assuming no further events occurred.</span>
<span id="cb68-576"><a href="#cb68-576" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-577"><a href="#cb68-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-578"><a href="#cb68-578" aria-hidden="true" tabindex="-1"></a><span class="fu"># Survival Curves by Subgroups</span></span>
<span id="cb68-579"><a href="#cb68-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-580"><a href="#cb68-580" aria-hidden="true" tabindex="-1"></a>One of the most common uses of KM analysis is comparing survival between different patient groups.</span>
<span id="cb68-581"><a href="#cb68-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-582"><a href="#cb68-582" aria-hidden="true" tabindex="-1"></a><span class="fu">## By Hormone Receptor Status</span></span>
<span id="cb68-583"><a href="#cb68-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-586"><a href="#cb68-586" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-587"><a href="#cb68-587" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-km-hr</span></span>
<span id="cb68-588"><a href="#cb68-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival by hormone receptor status"</span></span>
<span id="cb68-589"><a href="#cb68-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-590"><a href="#cb68-590" aria-hidden="true" tabindex="-1"></a>km_hr <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> hormone_receptor, </span>
<span id="cb68-591"><a href="#cb68-591" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> mbc_data)</span>
<span id="cb68-592"><a href="#cb68-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-593"><a href="#cb68-593" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb68-594"><a href="#cb68-594" aria-hidden="true" tabindex="-1"></a>  km_hr,</span>
<span id="cb68-595"><a href="#cb68-595" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb68-596"><a href="#cb68-596" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb68-597"><a href="#cb68-597" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-598"><a href="#cb68-598" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.height =</span> <span class="fl">0.30</span>,</span>
<span id="cb68-599"><a href="#cb68-599" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb68-600"><a href="#cb68-600" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb68-601"><a href="#cb68-601" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by Hormone Receptor Status"</span>,</span>
<span id="cb68-602"><a href="#cb68-602" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"HR Status"</span>,</span>
<span id="cb68-603"><a href="#cb68-603" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"HR-negative"</span>, <span class="st">"HR-positive"</span>),</span>
<span id="cb68-604"><a href="#cb68-604" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb68-605"><a href="#cb68-605" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#E74C3C"</span>, <span class="st">"#3498DB"</span>),</span>
<span id="cb68-606"><a href="#cb68-606" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span></span>
<span id="cb68-607"><a href="#cb68-607" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-608"><a href="#cb68-608" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-609"><a href="#cb68-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-610"><a href="#cb68-610" aria-hidden="true" tabindex="-1"></a><span class="fu">## By ECOG Performance Status</span></span>
<span id="cb68-611"><a href="#cb68-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-614"><a href="#cb68-614" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-615"><a href="#cb68-615" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-km-ecog</span></span>
<span id="cb68-616"><a href="#cb68-616" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival by ECOG performance status"</span></span>
<span id="cb68-617"><a href="#cb68-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-618"><a href="#cb68-618" aria-hidden="true" tabindex="-1"></a>km_ecog <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> ecog_ps, </span>
<span id="cb68-619"><a href="#cb68-619" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mbc_data)</span>
<span id="cb68-620"><a href="#cb68-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-621"><a href="#cb68-621" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb68-622"><a href="#cb68-622" aria-hidden="true" tabindex="-1"></a>  km_ecog,</span>
<span id="cb68-623"><a href="#cb68-623" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb68-624"><a href="#cb68-624" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb68-625"><a href="#cb68-625" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-626"><a href="#cb68-626" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.height =</span> <span class="fl">0.35</span>,</span>
<span id="cb68-627"><a href="#cb68-627" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb68-628"><a href="#cb68-628" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb68-629"><a href="#cb68-629" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by ECOG Performance Status"</span>,</span>
<span id="cb68-630"><a href="#cb68-630" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"ECOG PS"</span>,</span>
<span id="cb68-631"><a href="#cb68-631" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb68-632"><a href="#cb68-632" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="st">"jco"</span>,</span>
<span id="cb68-633"><a href="#cb68-633" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span></span>
<span id="cb68-634"><a href="#cb68-634" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-635"><a href="#cb68-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-636"><a href="#cb68-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-637"><a href="#cb68-637" aria-hidden="true" tabindex="-1"></a><span class="fu">## By Number of Metastatic Sites</span></span>
<span id="cb68-638"><a href="#cb68-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-641"><a href="#cb68-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-642"><a href="#cb68-642" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-km-mets</span></span>
<span id="cb68-643"><a href="#cb68-643" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival by number of metastatic sites"</span></span>
<span id="cb68-644"><a href="#cb68-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-645"><a href="#cb68-645" aria-hidden="true" tabindex="-1"></a><span class="co"># Create grouped metastatic sites variable</span></span>
<span id="cb68-646"><a href="#cb68-646" aria-hidden="true" tabindex="-1"></a>mbc_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-647"><a href="#cb68-647" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-648"><a href="#cb68-648" aria-hidden="true" tabindex="-1"></a>    <span class="at">mets_group =</span> <span class="fu">case_when</span>(</span>
<span id="cb68-649"><a href="#cb68-649" aria-hidden="true" tabindex="-1"></a>      n_metastatic_sites <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"1 site"</span>,</span>
<span id="cb68-650"><a href="#cb68-650" aria-hidden="true" tabindex="-1"></a>      n_metastatic_sites <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"2 sites"</span>,</span>
<span id="cb68-651"><a href="#cb68-651" aria-hidden="true" tabindex="-1"></a>      n_metastatic_sites <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"3+ sites"</span></span>
<span id="cb68-652"><a href="#cb68-652" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"1 site"</span>, <span class="st">"2 sites"</span>, <span class="st">"3+ sites"</span>))</span>
<span id="cb68-653"><a href="#cb68-653" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-654"><a href="#cb68-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-655"><a href="#cb68-655" aria-hidden="true" tabindex="-1"></a>km_mets <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> mets_group, </span>
<span id="cb68-656"><a href="#cb68-656" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> mbc_data)</span>
<span id="cb68-657"><a href="#cb68-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-658"><a href="#cb68-658" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb68-659"><a href="#cb68-659" aria-hidden="true" tabindex="-1"></a>  km_mets,</span>
<span id="cb68-660"><a href="#cb68-660" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb68-661"><a href="#cb68-661" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb68-662"><a href="#cb68-662" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-663"><a href="#cb68-663" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table.height =</span> <span class="fl">0.30</span>,</span>
<span id="cb68-664"><a href="#cb68-664" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb68-665"><a href="#cb68-665" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb68-666"><a href="#cb68-666" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by Number of Metastatic Sites"</span>,</span>
<span id="cb68-667"><a href="#cb68-667" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"Metastatic Sites"</span>,</span>
<span id="cb68-668"><a href="#cb68-668" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb68-669"><a href="#cb68-669" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#27AE60"</span>, <span class="st">"#F39C12"</span>, <span class="st">"#C0392B"</span>),</span>
<span id="cb68-670"><a href="#cb68-670" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span></span>
<span id="cb68-671"><a href="#cb68-671" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-672"><a href="#cb68-672" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-673"><a href="#cb68-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-674"><a href="#cb68-674" aria-hidden="true" tabindex="-1"></a><span class="fu"># Hazard Functions</span></span>
<span id="cb68-675"><a href="#cb68-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-676"><a href="#cb68-676" aria-hidden="true" tabindex="-1"></a>While survival curves show the probability of surviving beyond time *t*, hazard functions show the instantaneous rate of the event occurring at time *t*, given survival up to that point.</span>
<span id="cb68-677"><a href="#cb68-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-678"><a href="#cb68-678" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cumulative Hazard Function</span></span>
<span id="cb68-679"><a href="#cb68-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-680"><a href="#cb68-680" aria-hidden="true" tabindex="-1"></a>The cumulative hazard function, $H(t)$, represents the accumulated risk up to time *t*.</span>
<span id="cb68-681"><a href="#cb68-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-684"><a href="#cb68-684" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-685"><a href="#cb68-685" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cumhaz</span></span>
<span id="cb68-686"><a href="#cb68-686" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative hazard function by hormone receptor status"</span></span>
<span id="cb68-687"><a href="#cb68-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-688"><a href="#cb68-688" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb68-689"><a href="#cb68-689" aria-hidden="true" tabindex="-1"></a>  km_hr,</span>
<span id="cb68-690"><a href="#cb68-690" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data,</span>
<span id="cb68-691"><a href="#cb68-691" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> <span class="st">"cumhaz"</span>,</span>
<span id="cb68-692"><a href="#cb68-692" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb68-693"><a href="#cb68-693" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb68-694"><a href="#cb68-694" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Cumulative hazard"</span>,</span>
<span id="cb68-695"><a href="#cb68-695" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Cumulative Hazard by Hormone Receptor Status"</span>,</span>
<span id="cb68-696"><a href="#cb68-696" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"HR Status"</span>,</span>
<span id="cb68-697"><a href="#cb68-697" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"HR-negative"</span>, <span class="st">"HR-positive"</span>),</span>
<span id="cb68-698"><a href="#cb68-698" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>(),</span>
<span id="cb68-699"><a href="#cb68-699" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#E74C3C"</span>, <span class="st">"#3498DB"</span>),</span>
<span id="cb68-700"><a href="#cb68-700" aria-hidden="true" tabindex="-1"></a>  <span class="at">break.time.by =</span> <span class="dv">12</span></span>
<span id="cb68-701"><a href="#cb68-701" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-702"><a href="#cb68-702" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-703"><a href="#cb68-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-704"><a href="#cb68-704" aria-hidden="true" tabindex="-1"></a><span class="fu">## Smoothed Hazard Function</span></span>
<span id="cb68-705"><a href="#cb68-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-706"><a href="#cb68-706" aria-hidden="true" tabindex="-1"></a>To visualise the instantaneous hazard rate, we can use kernel smoothing methods.</span>
<span id="cb68-707"><a href="#cb68-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-710"><a href="#cb68-710" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-711"><a href="#cb68-711" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-hazard</span></span>
<span id="cb68-712"><a href="#cb68-712" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Smoothed hazard function estimates"</span></span>
<span id="cb68-713"><a href="#cb68-713" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb68-714"><a href="#cb68-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-715"><a href="#cb68-715" aria-hidden="true" tabindex="-1"></a><span class="co"># Using muhaz package for smoothed hazard estimation</span></span>
<span id="cb68-716"><a href="#cb68-716" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(muhaz)</span>
<span id="cb68-717"><a href="#cb68-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-718"><a href="#cb68-718" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate smoothed hazard for each HR group</span></span>
<span id="cb68-719"><a href="#cb68-719" aria-hidden="true" tabindex="-1"></a>hr_pos_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(hormone_receptor <span class="sc">==</span> <span class="st">"HR-positive"</span>)</span>
<span id="cb68-720"><a href="#cb68-720" aria-hidden="true" tabindex="-1"></a>hr_neg_data <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(hormone_receptor <span class="sc">==</span> <span class="st">"HR-negative"</span>)</span>
<span id="cb68-721"><a href="#cb68-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-722"><a href="#cb68-722" aria-hidden="true" tabindex="-1"></a>haz_pos <span class="ot">&lt;-</span> <span class="fu">muhaz</span>(hr_pos_data<span class="sc">$</span>observed_time, hr_pos_data<span class="sc">$</span>status, </span>
<span id="cb68-723"><a href="#cb68-723" aria-hidden="true" tabindex="-1"></a>                 <span class="at">min.time =</span> <span class="dv">1</span>, <span class="at">max.time =</span> <span class="dv">60</span>)</span>
<span id="cb68-724"><a href="#cb68-724" aria-hidden="true" tabindex="-1"></a>haz_neg <span class="ot">&lt;-</span> <span class="fu">muhaz</span>(hr_neg_data<span class="sc">$</span>observed_time, hr_neg_data<span class="sc">$</span>status, </span>
<span id="cb68-725"><a href="#cb68-725" aria-hidden="true" tabindex="-1"></a>                 <span class="at">min.time =</span> <span class="dv">1</span>, <span class="at">max.time =</span> <span class="dv">60</span>)</span>
<span id="cb68-726"><a href="#cb68-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-727"><a href="#cb68-727" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into a data frame for plotting</span></span>
<span id="cb68-728"><a href="#cb68-728" aria-hidden="true" tabindex="-1"></a>hazard_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb68-729"><a href="#cb68-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb68-730"><a href="#cb68-730" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> haz_pos<span class="sc">$</span>est.grid,</span>
<span id="cb68-731"><a href="#cb68-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">hazard =</span> haz_pos<span class="sc">$</span>haz.est,</span>
<span id="cb68-732"><a href="#cb68-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"HR-positive"</span></span>
<span id="cb68-733"><a href="#cb68-733" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb68-734"><a href="#cb68-734" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb68-735"><a href="#cb68-735" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> haz_neg<span class="sc">$</span>est.grid,</span>
<span id="cb68-736"><a href="#cb68-736" aria-hidden="true" tabindex="-1"></a>    <span class="at">hazard =</span> haz_neg<span class="sc">$</span>haz.est,</span>
<span id="cb68-737"><a href="#cb68-737" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"HR-negative"</span></span>
<span id="cb68-738"><a href="#cb68-738" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-739"><a href="#cb68-739" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-740"><a href="#cb68-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-741"><a href="#cb68-741" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(hazard_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> hazard, <span class="at">colour =</span> group)) <span class="sc">+</span></span>
<span id="cb68-742"><a href="#cb68-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb68-743"><a href="#cb68-743" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb68-744"><a href="#cb68-744" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"HR-negative"</span> <span class="ot">=</span> <span class="st">"#E74C3C"</span>, <span class="st">"HR-positive"</span> <span class="ot">=</span> <span class="st">"#3498DB"</span>),</span>
<span id="cb68-745"><a href="#cb68-745" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"HR Status"</span></span>
<span id="cb68-746"><a href="#cb68-746" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-747"><a href="#cb68-747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-748"><a href="#cb68-748" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb68-749"><a href="#cb68-749" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Hazard rate"</span>,</span>
<span id="cb68-750"><a href="#cb68-750" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Smoothed Hazard Function by Hormone Receptor Status"</span></span>
<span id="cb68-751"><a href="#cb68-751" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-752"><a href="#cb68-752" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb68-753"><a href="#cb68-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb68-754"><a href="#cb68-754" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-755"><a href="#cb68-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-756"><a href="#cb68-756" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb68-757"><a href="#cb68-757" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting the Hazard Function</span></span>
<span id="cb68-758"><a href="#cb68-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-759"><a href="#cb68-759" aria-hidden="true" tabindex="-1"></a>The hazard rate represents the instantaneous risk of death at any given time point. A higher hazard indicates greater risk.</span>
<span id="cb68-760"><a href="#cb68-760" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-761"><a href="#cb68-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-762"><a href="#cb68-762" aria-hidden="true" tabindex="-1"></a><span class="fu"># Log-Rank Test</span></span>
<span id="cb68-763"><a href="#cb68-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-764"><a href="#cb68-764" aria-hidden="true" tabindex="-1"></a>The log-rank test is the most widely used method to formally compare survival distributions between two or more groups. It tests the null hypothesis that there is no difference in survival between groups.</span>
<span id="cb68-765"><a href="#cb68-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-766"><a href="#cb68-766" aria-hidden="true" tabindex="-1"></a><span class="fu">## How the Log-Rank Test Works</span></span>
<span id="cb68-767"><a href="#cb68-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-768"><a href="#cb68-768" aria-hidden="true" tabindex="-1"></a>The log-rank test is essentially a chi-squared test applied to survival data. At each time point where an event occurs, the test compares the **observed** number of events in each group to the **expected** number of events if there were truly no difference between groups.</span>
<span id="cb68-769"><a href="#cb68-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-770"><a href="#cb68-770" aria-hidden="true" tabindex="-1"></a>The expected number of events in each group is calculated based on the proportion of patients still at risk in that group. If Group A has 60% of the remaining patients at a given time point, we would expect 60% of the events at that time to occur in Group A.</span>
<span id="cb68-771"><a href="#cb68-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-772"><a href="#cb68-772" aria-hidden="true" tabindex="-1"></a>The test statistic is:</span>
<span id="cb68-773"><a href="#cb68-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-774"><a href="#cb68-774" aria-hidden="true" tabindex="-1"></a>$$\chi^2 = \frac{(O - E)^2}{Var(O-E)}$$</span>
<span id="cb68-775"><a href="#cb68-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-776"><a href="#cb68-776" aria-hidden="true" tabindex="-1"></a>Where O is the total observed events and E is the total expected events in a group. Under the null hypothesis of no difference, this follows a chi-squared distribution with degrees of freedom equal to the number of groups minus one.</span>
<span id="cb68-777"><a href="#cb68-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-778"><a href="#cb68-778" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb68-779"><a href="#cb68-779" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Properties of the Log-Rank Test</span></span>
<span id="cb68-780"><a href="#cb68-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-781"><a href="#cb68-781" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is a **non-parametric test** — it makes no assumptions about the shape of the survival curves</span>
<span id="cb68-782"><a href="#cb68-782" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It compares the **entire survival experience**, not just survival at a single time point</span>
<span id="cb68-783"><a href="#cb68-783" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It gives **equal weight** to all time points (early and late events contribute equally)</span>
<span id="cb68-784"><a href="#cb68-784" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It is most powerful when the **hazard ratio is constant** over time (proportional hazards)</span>
<span id="cb68-785"><a href="#cb68-785" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It does **not** provide an estimate of the size of the difference — only whether a difference exists</span>
<span id="cb68-786"><a href="#cb68-786" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-787"><a href="#cb68-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-788"><a href="#cb68-788" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparing Hormone Receptor Groups</span></span>
<span id="cb68-789"><a href="#cb68-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-792"><a href="#cb68-792" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-793"><a href="#cb68-793" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: logrank-hr</span></span>
<span id="cb68-794"><a href="#cb68-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-795"><a href="#cb68-795" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-rank test for hormone receptor status</span></span>
<span id="cb68-796"><a href="#cb68-796" aria-hidden="true" tabindex="-1"></a>logrank_hr <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> hormone_receptor, </span>
<span id="cb68-797"><a href="#cb68-797" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> mbc_data)</span>
<span id="cb68-798"><a href="#cb68-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-799"><a href="#cb68-799" aria-hidden="true" tabindex="-1"></a>logrank_hr</span>
<span id="cb68-800"><a href="#cb68-800" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-801"><a href="#cb68-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-804"><a href="#cb68-804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-805"><a href="#cb68-805" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: logrank-interpretation</span></span>
<span id="cb68-806"><a href="#cb68-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-807"><a href="#cb68-807" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract p-value</span></span>
<span id="cb68-808"><a href="#cb68-808" aria-hidden="true" tabindex="-1"></a>p_val <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">pchisq</span>(logrank_hr<span class="sc">$</span>chisq, <span class="fu">length</span>(logrank_hr<span class="sc">$</span>n) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb68-809"><a href="#cb68-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-810"><a href="#cb68-810" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Log-rank test Chi-squared:"</span>, <span class="fu">round</span>(logrank_hr<span class="sc">$</span>chisq, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb68-811"><a href="#cb68-811" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Degrees of freedom:"</span>, <span class="fu">length</span>(logrank_hr<span class="sc">$</span>n) <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb68-812"><a href="#cb68-812" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"P-value:"</span>, <span class="fu">format.pval</span>(p_val, <span class="at">digits =</span> <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb68-813"><a href="#cb68-813" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-814"><a href="#cb68-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-815"><a href="#cb68-815" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb68-816"><a href="#cb68-816" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reading the Output</span></span>
<span id="cb68-817"><a href="#cb68-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-818"><a href="#cb68-818" aria-hidden="true" tabindex="-1"></a>The <span class="in">`survdiff()`</span> output shows:</span>
<span id="cb68-819"><a href="#cb68-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-820"><a href="#cb68-820" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**N**: Number of patients in each group</span>
<span id="cb68-821"><a href="#cb68-821" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Observed**: Total events (deaths) observed in each group</span>
<span id="cb68-822"><a href="#cb68-822" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Expected**: Events expected if there were no difference between groups</span>
<span id="cb68-823"><a href="#cb68-823" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**(O-E)^2/E** and **(O-E)^2/V**: Components of the chi-squared statistic</span>
<span id="cb68-824"><a href="#cb68-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-825"><a href="#cb68-825" aria-hidden="true" tabindex="-1"></a>If the observed and expected values are similar, the groups have similar survival. Large differences between observed and expected suggest the groups differ. A group with **fewer observed than expected** events has better survival than average; a group with **more observed than expected** has worse survival.</span>
<span id="cb68-826"><a href="#cb68-826" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-827"><a href="#cb68-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-828"><a href="#cb68-828" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparing ECOG Performance Status Groups</span></span>
<span id="cb68-829"><a href="#cb68-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-830"><a href="#cb68-830" aria-hidden="true" tabindex="-1"></a>When comparing more than two groups, the log-rank test provides an overall (omnibus) test of whether any differences exist. A significant result tells you that at least one group differs from the others, but not which specific groups differ.</span>
<span id="cb68-831"><a href="#cb68-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-834"><a href="#cb68-834" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-835"><a href="#cb68-835" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: logrank-ecog</span></span>
<span id="cb68-836"><a href="#cb68-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-837"><a href="#cb68-837" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-rank test for ECOG PS</span></span>
<span id="cb68-838"><a href="#cb68-838" aria-hidden="true" tabindex="-1"></a>logrank_ecog <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(<span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> ecog_ps, </span>
<span id="cb68-839"><a href="#cb68-839" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> mbc_data)</span>
<span id="cb68-840"><a href="#cb68-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-841"><a href="#cb68-841" aria-hidden="true" tabindex="-1"></a>logrank_ecog</span>
<span id="cb68-842"><a href="#cb68-842" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-843"><a href="#cb68-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-844"><a href="#cb68-844" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stratified Log-Rank Test</span></span>
<span id="cb68-845"><a href="#cb68-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-846"><a href="#cb68-846" aria-hidden="true" tabindex="-1"></a>Sometimes we want to compare groups while adjusting for a potential confounding variable. The stratified log-rank test performs the comparison within strata of the adjusting variable, then combines the results. This is analogous to the Cochran-Mantel-Haenszel test for contingency tables.</span>
<span id="cb68-847"><a href="#cb68-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-850"><a href="#cb68-850" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-851"><a href="#cb68-851" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: logrank-stratified</span></span>
<span id="cb68-852"><a href="#cb68-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-853"><a href="#cb68-853" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare HR status, stratified by ECOG PS</span></span>
<span id="cb68-854"><a href="#cb68-854" aria-hidden="true" tabindex="-1"></a>logrank_strat <span class="ot">&lt;-</span> <span class="fu">survdiff</span>(</span>
<span id="cb68-855"><a href="#cb68-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> hormone_receptor <span class="sc">+</span> <span class="fu">strata</span>(ecog_ps), </span>
<span id="cb68-856"><a href="#cb68-856" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_data</span>
<span id="cb68-857"><a href="#cb68-857" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-858"><a href="#cb68-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-859"><a href="#cb68-859" aria-hidden="true" tabindex="-1"></a>logrank_strat</span>
<span id="cb68-860"><a href="#cb68-860" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-861"><a href="#cb68-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-862"><a href="#cb68-862" aria-hidden="true" tabindex="-1"></a>This tests whether hormone receptor status affects survival after accounting for differences in ECOG performance status across the groups.</span>
<span id="cb68-863"><a href="#cb68-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-864"><a href="#cb68-864" aria-hidden="true" tabindex="-1"></a><span class="fu"># Cox Proportional Hazards Regression</span></span>
<span id="cb68-865"><a href="#cb68-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-866"><a href="#cb68-866" aria-hidden="true" tabindex="-1"></a>The Cox proportional hazards model is the cornerstone of survival analysis, allowing us to examine the relationship between multiple covariates and survival time simultaneously. It was introduced by Sir David Cox in 1972 and remains the most widely used regression method for time-to-event data.</span>
<span id="cb68-867"><a href="#cb68-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-868"><a href="#cb68-868" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Use Cox Regression?</span></span>
<span id="cb68-869"><a href="#cb68-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-870"><a href="#cb68-870" aria-hidden="true" tabindex="-1"></a>The log-rank test tells us *whether* groups differ, but not *by how much*. It also cannot adjust for multiple confounders simultaneously. Cox regression addresses both limitations:</span>
<span id="cb68-871"><a href="#cb68-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-872"><a href="#cb68-872" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It provides **hazard ratios** that quantify the size of effects</span>
<span id="cb68-873"><a href="#cb68-873" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It can include **multiple covariates** (both categorical and continuous)</span>
<span id="cb68-874"><a href="#cb68-874" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It can **adjust for confounders** in a single model</span>
<span id="cb68-875"><a href="#cb68-875" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>It handles **censored data** appropriately</span>
<span id="cb68-876"><a href="#cb68-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-877"><a href="#cb68-877" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Cox Model</span></span>
<span id="cb68-878"><a href="#cb68-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-879"><a href="#cb68-879" aria-hidden="true" tabindex="-1"></a>The Cox model specifies the hazard function as:</span>
<span id="cb68-880"><a href="#cb68-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-881"><a href="#cb68-881" aria-hidden="true" tabindex="-1"></a>$$h(t|X) = h_0(t) \exp(\beta_1 X_1 + \beta_2 X_2 + ... + \beta_p X_p)$$</span>
<span id="cb68-882"><a href="#cb68-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-883"><a href="#cb68-883" aria-hidden="true" tabindex="-1"></a>Where:</span>
<span id="cb68-884"><a href="#cb68-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-885"><a href="#cb68-885" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$h(t|X)$ is the hazard at time $t$ for a patient with covariates $X$</span>
<span id="cb68-886"><a href="#cb68-886" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$h_0(t)$ is the **baseline hazard** — the hazard when all covariates equal zero</span>
<span id="cb68-887"><a href="#cb68-887" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\beta_1, \beta_2, ..., \beta_p$ are the regression coefficients</span>
<span id="cb68-888"><a href="#cb68-888" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$\exp(\beta)$ gives the **hazard ratio** for a one-unit increase in the covariate</span>
<span id="cb68-889"><a href="#cb68-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-890"><a href="#cb68-890" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb68-891"><a href="#cb68-891" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why "Semi-Parametric"?</span></span>
<span id="cb68-892"><a href="#cb68-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-893"><a href="#cb68-893" aria-hidden="true" tabindex="-1"></a>The Cox model is called semi-parametric because:</span>
<span id="cb68-894"><a href="#cb68-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-895"><a href="#cb68-895" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The **covariate effects** ($\beta$ coefficients) are estimated parametrically</span>
<span id="cb68-896"><a href="#cb68-896" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The **baseline hazard** $h_0(t)$ is left completely unspecified — no distributional assumption is made</span>
<span id="cb68-897"><a href="#cb68-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-898"><a href="#cb68-898" aria-hidden="true" tabindex="-1"></a>This flexibility is a major advantage: the model works regardless of whether the underlying survival distribution is exponential, Weibull, or any other shape. The trade-off is that we cannot directly estimate survival probabilities without additional assumptions (though we can still compare groups via hazard ratios).</span>
<span id="cb68-899"><a href="#cb68-899" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-900"><a href="#cb68-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-901"><a href="#cb68-901" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Proportional Hazards Assumption</span></span>
<span id="cb68-902"><a href="#cb68-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-903"><a href="#cb68-903" aria-hidden="true" tabindex="-1"></a>The model assumes that hazard ratios are **constant over time**. If patient A has twice the hazard of patient B at 1 month, they should still have twice the hazard at 12 months, 24 months, and so on.</span>
<span id="cb68-904"><a href="#cb68-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-905"><a href="#cb68-905" aria-hidden="true" tabindex="-1"></a>Mathematically, for two patients with covariate values $X_A$ and $X_B$:</span>
<span id="cb68-906"><a href="#cb68-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-907"><a href="#cb68-907" aria-hidden="true" tabindex="-1"></a>$$\frac{h(t|X_A)}{h(t|X_B)} = \frac{h_0(t) \exp(\beta X_A)}{h_0(t) \exp(\beta X_B)} = \exp(\beta(X_A - X_B))$$</span>
<span id="cb68-908"><a href="#cb68-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-909"><a href="#cb68-909" aria-hidden="true" tabindex="-1"></a>The baseline hazard $h_0(t)$ cancels out, leaving a ratio that does not depend on time.</span>
<span id="cb68-910"><a href="#cb68-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-911"><a href="#cb68-911" aria-hidden="true" tabindex="-1"></a><span class="fu">## Univariable Cox Models</span></span>
<span id="cb68-912"><a href="#cb68-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-913"><a href="#cb68-913" aria-hidden="true" tabindex="-1"></a>First, let's examine each potential predictor individually. Univariable analysis helps identify candidate variables for a multivariable model and provides unadjusted effect estimates.</span>
<span id="cb68-914"><a href="#cb68-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-917"><a href="#cb68-917" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-918"><a href="#cb68-918" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-univariable</span></span>
<span id="cb68-919"><a href="#cb68-919" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Univariable Cox regression analysis"</span></span>
<span id="cb68-920"><a href="#cb68-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-921"><a href="#cb68-921" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for modelling</span></span>
<span id="cb68-922"><a href="#cb68-922" aria-hidden="true" tabindex="-1"></a>mbc_model <span class="ot">&lt;-</span> mbc_data <span class="sc">|&gt;</span></span>
<span id="cb68-923"><a href="#cb68-923" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-924"><a href="#cb68-924" aria-hidden="true" tabindex="-1"></a>    <span class="at">ecog_ps =</span> <span class="fu">factor</span>(ecog_ps),</span>
<span id="cb68-925"><a href="#cb68-925" aria-hidden="true" tabindex="-1"></a>    <span class="at">simd_quintile =</span> <span class="fu">factor</span>(simd_quintile),</span>
<span id="cb68-926"><a href="#cb68-926" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_group =</span> <span class="fu">factor</span>(age_group, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"&lt;50"</span>, <span class="st">"50-64"</span>, <span class="st">"65-74"</span>, <span class="st">"75+"</span>))</span>
<span id="cb68-927"><a href="#cb68-927" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-928"><a href="#cb68-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-929"><a href="#cb68-929" aria-hidden="true" tabindex="-1"></a><span class="co"># Create univariable Cox regression table</span></span>
<span id="cb68-930"><a href="#cb68-930" aria-hidden="true" tabindex="-1"></a>mbc_model <span class="sc">|&gt;</span></span>
<span id="cb68-931"><a href="#cb68-931" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb68-932"><a href="#cb68-932" aria-hidden="true" tabindex="-1"></a>    observed_time, status,</span>
<span id="cb68-933"><a href="#cb68-933" aria-hidden="true" tabindex="-1"></a>    age_at_diagnosis, age_group, ecog_ps, hormone_receptor,</span>
<span id="cb68-934"><a href="#cb68-934" aria-hidden="true" tabindex="-1"></a>    her2_status, n_metastatic_sites, mets_group,</span>
<span id="cb68-935"><a href="#cb68-935" aria-hidden="true" tabindex="-1"></a>    liver_mets, brain_mets, presentation, simd_quintile</span>
<span id="cb68-936"><a href="#cb68-936" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-937"><a href="#cb68-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_uvregression</span>(</span>
<span id="cb68-938"><a href="#cb68-938" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> coxph,</span>
<span id="cb68-939"><a href="#cb68-939" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">Surv</span>(observed_time, status),</span>
<span id="cb68-940"><a href="#cb68-940" aria-hidden="true" tabindex="-1"></a>    <span class="at">exponentiate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-941"><a href="#cb68-941" aria-hidden="true" tabindex="-1"></a>    <span class="at">hide_n =</span> <span class="cn">TRUE</span></span>
<span id="cb68-942"><a href="#cb68-942" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-943"><a href="#cb68-943" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_p</span>() <span class="sc">|&gt;</span></span>
<span id="cb68-944"><a href="#cb68-944" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>()</span>
<span id="cb68-945"><a href="#cb68-945" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-946"><a href="#cb68-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-947"><a href="#cb68-947" aria-hidden="true" tabindex="-1"></a><span class="fu">## Multivariable Cox Model</span></span>
<span id="cb68-948"><a href="#cb68-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-949"><a href="#cb68-949" aria-hidden="true" tabindex="-1"></a>Now we fit a multivariable model including clinically relevant predictors.</span>
<span id="cb68-950"><a href="#cb68-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-953"><a href="#cb68-953" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-954"><a href="#cb68-954" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cox-multivar</span></span>
<span id="cb68-955"><a href="#cb68-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-956"><a href="#cb68-956" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit multivariable Cox model</span></span>
<span id="cb68-957"><a href="#cb68-957" aria-hidden="true" tabindex="-1"></a>cox_multi <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb68-958"><a href="#cb68-958" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(observed_time, status) <span class="sc">~</span> </span>
<span id="cb68-959"><a href="#cb68-959" aria-hidden="true" tabindex="-1"></a>    age_at_diagnosis <span class="sc">+</span> </span>
<span id="cb68-960"><a href="#cb68-960" aria-hidden="true" tabindex="-1"></a>    ecog_ps <span class="sc">+</span> </span>
<span id="cb68-961"><a href="#cb68-961" aria-hidden="true" tabindex="-1"></a>    hormone_receptor <span class="sc">+</span> </span>
<span id="cb68-962"><a href="#cb68-962" aria-hidden="true" tabindex="-1"></a>    her2_status <span class="sc">+</span> </span>
<span id="cb68-963"><a href="#cb68-963" aria-hidden="true" tabindex="-1"></a>    n_metastatic_sites <span class="sc">+</span> </span>
<span id="cb68-964"><a href="#cb68-964" aria-hidden="true" tabindex="-1"></a>    liver_mets <span class="sc">+</span> </span>
<span id="cb68-965"><a href="#cb68-965" aria-hidden="true" tabindex="-1"></a>    brain_mets,</span>
<span id="cb68-966"><a href="#cb68-966" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> mbc_model</span>
<span id="cb68-967"><a href="#cb68-967" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-968"><a href="#cb68-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-969"><a href="#cb68-969" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_multi)</span>
<span id="cb68-970"><a href="#cb68-970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-971"><a href="#cb68-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-972"><a href="#cb68-972" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb68-973"><a href="#cb68-973" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reading the Cox Model Output</span></span>
<span id="cb68-974"><a href="#cb68-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-975"><a href="#cb68-975" aria-hidden="true" tabindex="-1"></a>The <span class="in">`summary()`</span> output provides:</span>
<span id="cb68-976"><a href="#cb68-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-977"><a href="#cb68-977" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**coef**: The log hazard ratio ($\beta$) — positive values indicate increased hazard</span>
<span id="cb68-978"><a href="#cb68-978" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**exp(coef)**: The hazard ratio — the multiplicative effect on hazard</span>
<span id="cb68-979"><a href="#cb68-979" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**se(coef)**: Standard error of the coefficient</span>
<span id="cb68-980"><a href="#cb68-980" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**z**: Wald test statistic (coef/se)</span>
<span id="cb68-981"><a href="#cb68-981" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Pr(&gt;|z|)**: P-value for testing whether the coefficient differs from zero</span>
<span id="cb68-982"><a href="#cb68-982" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**lower .95 / upper .95**: 95% confidence interval for the hazard ratio</span>
<span id="cb68-983"><a href="#cb68-983" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Concordance**: A measure of model discrimination (0.5 = no better than chance, 1.0 = perfect)</span>
<span id="cb68-984"><a href="#cb68-984" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Likelihood ratio test**: Overall test of whether the model is better than a null model</span>
<span id="cb68-985"><a href="#cb68-985" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-986"><a href="#cb68-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-987"><a href="#cb68-987" aria-hidden="true" tabindex="-1"></a><span class="fu">## Understanding Hazard Ratios</span></span>
<span id="cb68-988"><a href="#cb68-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-989"><a href="#cb68-989" aria-hidden="true" tabindex="-1"></a>The hazard ratio (HR) is the key output from Cox regression. It represents the relative rate at which events occur in one group compared to another, at any given point in time.</span>
<span id="cb68-990"><a href="#cb68-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-991"><a href="#cb68-991" aria-hidden="true" tabindex="-1"></a>**Interpreting HR values:**</span>
<span id="cb68-992"><a href="#cb68-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-993"><a href="#cb68-993" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**HR = 1**: No difference between groups</span>
<span id="cb68-994"><a href="#cb68-994" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**HR &gt; 1**: Increased hazard (worse survival) compared to reference</span>
<span id="cb68-995"><a href="#cb68-995" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**HR &lt; 1**: Decreased hazard (better survival) compared to reference</span>
<span id="cb68-996"><a href="#cb68-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-997"><a href="#cb68-997" aria-hidden="true" tabindex="-1"></a>**For categorical variables**: The HR compares each category to a reference category. For example, if HR-positive vs HR-negative has HR = 0.6, then HR-positive patients have 40% lower hazard (die at 0.6 times the rate) compared to HR-negative patients.</span>
<span id="cb68-998"><a href="#cb68-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-999"><a href="#cb68-999" aria-hidden="true" tabindex="-1"></a>**For continuous variables**: The HR represents the change in hazard for each one-unit increase. For example, if age has HR = 1.02, then each additional year of age increases the hazard by 2%.</span>
<span id="cb68-1000"><a href="#cb68-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1001"><a href="#cb68-1001" aria-hidden="true" tabindex="-1"></a>::: callout-warning</span>
<span id="cb68-1002"><a href="#cb68-1002" aria-hidden="true" tabindex="-1"></a><span class="fu">## HR is Not a Risk or Probability</span></span>
<span id="cb68-1003"><a href="#cb68-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1004"><a href="#cb68-1004" aria-hidden="true" tabindex="-1"></a>The hazard ratio is often misinterpreted as a relative risk. While they can be similar in some situations, they measure different things:</span>
<span id="cb68-1005"><a href="#cb68-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1006"><a href="#cb68-1006" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Relative risk** compares cumulative probabilities (e.g., "twice as likely to die by 5 years")</span>
<span id="cb68-1007"><a href="#cb68-1007" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Hazard ratio** compares instantaneous rates (e.g., "dying at twice the rate at any moment")</span>
<span id="cb68-1008"><a href="#cb68-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1009"><a href="#cb68-1009" aria-hidden="true" tabindex="-1"></a>A HR of 2 does **not** mean twice the probability of the event. Be precise in your interpretation, and avoid phrases like "twice as likely" when reporting hazard ratios.</span>
<span id="cb68-1010"><a href="#cb68-1010" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1011"><a href="#cb68-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1012"><a href="#cb68-1012" aria-hidden="true" tabindex="-1"></a><span class="fu">## Formatted Multivariable Results</span></span>
<span id="cb68-1013"><a href="#cb68-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1016"><a href="#cb68-1016" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1017"><a href="#cb68-1017" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-multivar</span></span>
<span id="cb68-1018"><a href="#cb68-1018" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Multivariable Cox regression model"</span></span>
<span id="cb68-1019"><a href="#cb68-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1020"><a href="#cb68-1020" aria-hidden="true" tabindex="-1"></a><span class="co"># Create formatted Cox regression table</span></span>
<span id="cb68-1021"><a href="#cb68-1021" aria-hidden="true" tabindex="-1"></a>cox_multi <span class="sc">|&gt;</span></span>
<span id="cb68-1022"><a href="#cb68-1022" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_regression</span>(</span>
<span id="cb68-1023"><a href="#cb68-1023" aria-hidden="true" tabindex="-1"></a>    <span class="at">exponentiate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-1024"><a href="#cb68-1024" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">list</span>(</span>
<span id="cb68-1025"><a href="#cb68-1025" aria-hidden="true" tabindex="-1"></a>      age_at_diagnosis <span class="sc">~</span> <span class="st">"Age at diagnosis (years)"</span>,</span>
<span id="cb68-1026"><a href="#cb68-1026" aria-hidden="true" tabindex="-1"></a>      ecog_ps <span class="sc">~</span> <span class="st">"ECOG Performance Status"</span>,</span>
<span id="cb68-1027"><a href="#cb68-1027" aria-hidden="true" tabindex="-1"></a>      hormone_receptor <span class="sc">~</span> <span class="st">"Hormone receptor status"</span>,</span>
<span id="cb68-1028"><a href="#cb68-1028" aria-hidden="true" tabindex="-1"></a>      her2_status <span class="sc">~</span> <span class="st">"HER2 status"</span>,</span>
<span id="cb68-1029"><a href="#cb68-1029" aria-hidden="true" tabindex="-1"></a>      n_metastatic_sites <span class="sc">~</span> <span class="st">"Number of metastatic sites"</span>,</span>
<span id="cb68-1030"><a href="#cb68-1030" aria-hidden="true" tabindex="-1"></a>      liver_mets <span class="sc">~</span> <span class="st">"Liver metastases"</span>,</span>
<span id="cb68-1031"><a href="#cb68-1031" aria-hidden="true" tabindex="-1"></a>      brain_mets <span class="sc">~</span> <span class="st">"Brain metastases"</span></span>
<span id="cb68-1032"><a href="#cb68-1032" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb68-1033"><a href="#cb68-1033" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-1034"><a href="#cb68-1034" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_p</span>() <span class="sc">|&gt;</span></span>
<span id="cb68-1035"><a href="#cb68-1035" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bold_labels</span>()</span>
<span id="cb68-1036"><a href="#cb68-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1037"><a href="#cb68-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1038"><a href="#cb68-1038" aria-hidden="true" tabindex="-1"></a><span class="fu">## Forest Plot of Hazard Ratios</span></span>
<span id="cb68-1039"><a href="#cb68-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1042"><a href="#cb68-1042" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1043"><a href="#cb68-1043" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-forest</span></span>
<span id="cb68-1044"><a href="#cb68-1044" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Forest plot of hazard ratios from the multivariable Cox model"</span></span>
<span id="cb68-1045"><a href="#cb68-1045" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 6</span></span>
<span id="cb68-1046"><a href="#cb68-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1047"><a href="#cb68-1047" aria-hidden="true" tabindex="-1"></a><span class="co"># Create forest plot data from model</span></span>
<span id="cb68-1048"><a href="#cb68-1048" aria-hidden="true" tabindex="-1"></a>forest_data <span class="ot">&lt;-</span> <span class="fu">tidy</span>(cox_multi, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">exponentiate =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb68-1049"><a href="#cb68-1049" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-1050"><a href="#cb68-1050" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up term names for display</span></span>
<span id="cb68-1051"><a href="#cb68-1051" aria-hidden="true" tabindex="-1"></a>    <span class="at">term_label =</span> <span class="fu">case_when</span>(</span>
<span id="cb68-1052"><a href="#cb68-1052" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"age_at_diagnosis"</span> <span class="sc">~</span> <span class="st">"Age (per year)"</span>,</span>
<span id="cb68-1053"><a href="#cb68-1053" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"ecog_ps1"</span> <span class="sc">~</span> <span class="st">"ECOG PS 1 vs 0"</span>,</span>
<span id="cb68-1054"><a href="#cb68-1054" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"ecog_ps2"</span> <span class="sc">~</span> <span class="st">"ECOG PS 2 vs 0"</span>,</span>
<span id="cb68-1055"><a href="#cb68-1055" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"ecog_ps3"</span> <span class="sc">~</span> <span class="st">"ECOG PS 3 vs 0"</span>,</span>
<span id="cb68-1056"><a href="#cb68-1056" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"hormone_receptorHR-positive"</span> <span class="sc">~</span> <span class="st">"HR-positive vs HR-negative"</span>,</span>
<span id="cb68-1057"><a href="#cb68-1057" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"her2_statusPositive"</span> <span class="sc">~</span> <span class="st">"HER2-positive vs negative"</span>,</span>
<span id="cb68-1058"><a href="#cb68-1058" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"n_metastatic_sites"</span> <span class="sc">~</span> <span class="st">"Metastatic sites (per site)"</span>,</span>
<span id="cb68-1059"><a href="#cb68-1059" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"liver_metsYes"</span> <span class="sc">~</span> <span class="st">"Liver metastases"</span>,</span>
<span id="cb68-1060"><a href="#cb68-1060" aria-hidden="true" tabindex="-1"></a>      term <span class="sc">==</span> <span class="st">"brain_metsYes"</span> <span class="sc">~</span> <span class="st">"Brain metastases"</span>,</span>
<span id="cb68-1061"><a href="#cb68-1061" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> term</span>
<span id="cb68-1062"><a href="#cb68-1062" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb68-1063"><a href="#cb68-1063" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create HR label</span></span>
<span id="cb68-1064"><a href="#cb68-1064" aria-hidden="true" tabindex="-1"></a>    <span class="at">hr_label =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f (%.2f-%.2f)"</span>, estimate, conf.low, conf.high),</span>
<span id="cb68-1065"><a href="#cb68-1065" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Significance indicator</span></span>
<span id="cb68-1066"><a href="#cb68-1066" aria-hidden="true" tabindex="-1"></a>    <span class="at">significant =</span> p.value <span class="sc">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb68-1067"><a href="#cb68-1067" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-1068"><a href="#cb68-1068" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reverse order for plotting (top to bottom)</span></span>
<span id="cb68-1069"><a href="#cb68-1069" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">term_label =</span> <span class="fu">fct_inorder</span>(term_label) <span class="sc">|&gt;</span> <span class="fu">fct_rev</span>())</span>
<span id="cb68-1070"><a href="#cb68-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1071"><a href="#cb68-1071" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the forest plot</span></span>
<span id="cb68-1072"><a href="#cb68-1072" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(forest_data, <span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> term_label)) <span class="sc">+</span></span>
<span id="cb68-1073"><a href="#cb68-1073" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reference line at HR = 1</span></span>
<span id="cb68-1074"><a href="#cb68-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1075"><a href="#cb68-1075" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">colour =</span> <span class="st">"grey50"</span>) <span class="sc">+</span></span>
<span id="cb68-1076"><a href="#cb68-1076" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Confidence intervals</span></span>
<span id="cb68-1077"><a href="#cb68-1077" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbarh</span>(</span>
<span id="cb68-1078"><a href="#cb68-1078" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high),</span>
<span id="cb68-1079"><a href="#cb68-1079" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="fl">0.2</span>,</span>
<span id="cb68-1080"><a href="#cb68-1080" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"grey30"</span></span>
<span id="cb68-1081"><a href="#cb68-1081" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-1082"><a href="#cb68-1082" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Point estimates</span></span>
<span id="cb68-1083"><a href="#cb68-1083" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb68-1084"><a href="#cb68-1084" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">colour =</span> significant),</span>
<span id="cb68-1085"><a href="#cb68-1085" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb68-1086"><a href="#cb68-1086" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-1087"><a href="#cb68-1087" aria-hidden="true" tabindex="-1"></a>  <span class="co"># HR labels on the right</span></span>
<span id="cb68-1088"><a href="#cb68-1088" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb68-1089"><a href="#cb68-1089" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">max</span>(conf.high) <span class="sc">*</span> <span class="fl">1.3</span>, <span class="at">label =</span> hr_label),</span>
<span id="cb68-1090"><a href="#cb68-1090" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb68-1091"><a href="#cb68-1091" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb68-1092"><a href="#cb68-1092" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-1093"><a href="#cb68-1093" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Colour scale</span></span>
<span id="cb68-1094"><a href="#cb68-1094" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(</span>
<span id="cb68-1095"><a href="#cb68-1095" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"#E74C3C"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"#3498DB"</span>),</span>
<span id="cb68-1096"><a href="#cb68-1096" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"p &lt; 0.05"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"p ≥ 0.05"</span>),</span>
<span id="cb68-1097"><a href="#cb68-1097" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span></span>
<span id="cb68-1098"><a href="#cb68-1098" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-1099"><a href="#cb68-1099" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Log scale for x-axis</span></span>
<span id="cb68-1100"><a href="#cb68-1100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(</span>
<span id="cb68-1101"><a href="#cb68-1101" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>),</span>
<span id="cb68-1102"><a href="#cb68-1102" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fu">max</span>(forest_data<span class="sc">$</span>conf.high) <span class="sc">*</span> <span class="dv">2</span>)</span>
<span id="cb68-1103"><a href="#cb68-1103" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-1104"><a href="#cb68-1104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-1105"><a href="#cb68-1105" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Hazard Ratio (log scale)"</span>,</span>
<span id="cb68-1106"><a href="#cb68-1106" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb68-1107"><a href="#cb68-1107" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Multivariable Cox Regression: Hazard Ratios"</span>,</span>
<span id="cb68-1108"><a href="#cb68-1108" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Adjusted for all variables shown"</span></span>
<span id="cb68-1109"><a href="#cb68-1109" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-1110"><a href="#cb68-1110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb68-1111"><a href="#cb68-1111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb68-1112"><a href="#cb68-1112" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb68-1113"><a href="#cb68-1113" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb68-1114"><a href="#cb68-1114" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb68-1115"><a href="#cb68-1115" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb68-1116"><a href="#cb68-1116" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb68-1117"><a href="#cb68-1117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1118"><a href="#cb68-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1119"><a href="#cb68-1119" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Fit Statistics</span></span>
<span id="cb68-1120"><a href="#cb68-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1121"><a href="#cb68-1121" aria-hidden="true" tabindex="-1"></a>We can assess how well the model fits the data using several metrics.</span>
<span id="cb68-1122"><a href="#cb68-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1125"><a href="#cb68-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1126"><a href="#cb68-1126" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model-fit</span></span>
<span id="cb68-1127"><a href="#cb68-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1128"><a href="#cb68-1128" aria-hidden="true" tabindex="-1"></a><span class="co"># Model fit statistics</span></span>
<span id="cb68-1129"><a href="#cb68-1129" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(cox_multi) <span class="sc">|&gt;</span></span>
<span id="cb68-1130"><a href="#cb68-1130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(n, nevent, concordance, std.error.concordance, logLik, AIC, BIC) <span class="sc">|&gt;</span></span>
<span id="cb68-1131"><a href="#cb68-1131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"Statistic"</span>, <span class="at">values_to =</span> <span class="st">"Value"</span>) <span class="sc">|&gt;</span></span>
<span id="cb68-1132"><a href="#cb68-1132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb68-1133"><a href="#cb68-1133" aria-hidden="true" tabindex="-1"></a>    <span class="at">Statistic =</span> <span class="fu">case_when</span>(</span>
<span id="cb68-1134"><a href="#cb68-1134" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"n"</span> <span class="sc">~</span> <span class="st">"Number of observations"</span>,</span>
<span id="cb68-1135"><a href="#cb68-1135" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"nevent"</span> <span class="sc">~</span> <span class="st">"Number of events"</span>,</span>
<span id="cb68-1136"><a href="#cb68-1136" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"concordance"</span> <span class="sc">~</span> <span class="st">"Concordance (C-statistic)"</span>,</span>
<span id="cb68-1137"><a href="#cb68-1137" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"std.error.concordance"</span> <span class="sc">~</span> <span class="st">"SE of concordance"</span>,</span>
<span id="cb68-1138"><a href="#cb68-1138" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"logLik"</span> <span class="sc">~</span> <span class="st">"Log-likelihood"</span>,</span>
<span id="cb68-1139"><a href="#cb68-1139" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"AIC"</span> <span class="sc">~</span> <span class="st">"AIC"</span>,</span>
<span id="cb68-1140"><a href="#cb68-1140" aria-hidden="true" tabindex="-1"></a>      Statistic <span class="sc">==</span> <span class="st">"BIC"</span> <span class="sc">~</span> <span class="st">"BIC"</span></span>
<span id="cb68-1141"><a href="#cb68-1141" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb68-1142"><a href="#cb68-1142" aria-hidden="true" tabindex="-1"></a>    <span class="at">Value =</span> <span class="fu">round</span>(Value, <span class="dv">3</span>)</span>
<span id="cb68-1143"><a href="#cb68-1143" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb68-1144"><a href="#cb68-1144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Model fit statistics"</span>)</span>
<span id="cb68-1145"><a href="#cb68-1145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1146"><a href="#cb68-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1147"><a href="#cb68-1147" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb68-1148"><a href="#cb68-1148" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting Model Fit Statistics</span></span>
<span id="cb68-1149"><a href="#cb68-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1150"><a href="#cb68-1150" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Concordance (C-statistic)**: Measures discriminative ability — the probability that, for a random pair of patients where one dies first, the model correctly predicts which one. Values range from 0.5 (no better than chance) to 1.0 (perfect discrimination). In clinical models, values of 0.7–0.8 are typically considered acceptable.</span>
<span id="cb68-1151"><a href="#cb68-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1152"><a href="#cb68-1152" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**AIC/BIC**: Information criteria for comparing models. Lower values indicate better fit, penalised for model complexity. Useful for comparing alternative models fitted to the same data.</span>
<span id="cb68-1153"><a href="#cb68-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1154"><a href="#cb68-1154" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Log-likelihood**: The basis for likelihood ratio tests comparing nested models.</span>
<span id="cb68-1155"><a href="#cb68-1155" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1156"><a href="#cb68-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1157"><a href="#cb68-1157" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predicting Survival for Specific Patients</span></span>
<span id="cb68-1158"><a href="#cb68-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1159"><a href="#cb68-1159" aria-hidden="true" tabindex="-1"></a>One practical application of Cox models is predicting survival curves for patients with specific characteristics. Although the Cox model does not directly estimate the baseline hazard, the <span class="in">`survfit()`</span> function can estimate it from the data and combine it with covariate effects to produce predicted survival curves.</span>
<span id="cb68-1160"><a href="#cb68-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1163"><a href="#cb68-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1164"><a href="#cb68-1164" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cox-predictions</span></span>
<span id="cb68-1165"><a href="#cb68-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1166"><a href="#cb68-1166" aria-hidden="true" tabindex="-1"></a><span class="co"># Create profiles for two hypothetical patients</span></span>
<span id="cb68-1167"><a href="#cb68-1167" aria-hidden="true" tabindex="-1"></a>new_patients <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb68-1168"><a href="#cb68-1168" aria-hidden="true" tabindex="-1"></a>  <span class="at">patient_type =</span> <span class="fu">c</span>(<span class="st">"Lower risk"</span>, <span class="st">"Higher risk"</span>),</span>
<span id="cb68-1169"><a href="#cb68-1169" aria-hidden="true" tabindex="-1"></a>  <span class="at">age_at_diagnosis =</span> <span class="fu">c</span>(<span class="dv">55</span>, <span class="dv">75</span>),</span>
<span id="cb68-1170"><a href="#cb68-1170" aria-hidden="true" tabindex="-1"></a>  <span class="at">ecog_ps =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">levels =</span> <span class="fu">levels</span>(mbc_model<span class="sc">$</span>ecog_ps)),</span>
<span id="cb68-1171"><a href="#cb68-1171" aria-hidden="true" tabindex="-1"></a>  <span class="at">hormone_receptor =</span> <span class="fu">c</span>(<span class="st">"HR-positive"</span>, <span class="st">"HR-negative"</span>),</span>
<span id="cb68-1172"><a href="#cb68-1172" aria-hidden="true" tabindex="-1"></a>  <span class="at">her2_status =</span> <span class="fu">c</span>(<span class="st">"Negative"</span>, <span class="st">"Negative"</span>),</span>
<span id="cb68-1173"><a href="#cb68-1173" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_metastatic_sites =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb68-1174"><a href="#cb68-1174" aria-hidden="true" tabindex="-1"></a>  <span class="at">liver_mets =</span> <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Yes"</span>),</span>
<span id="cb68-1175"><a href="#cb68-1175" aria-hidden="true" tabindex="-1"></a>  <span class="at">brain_mets =</span> <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"No"</span>)</span>
<span id="cb68-1176"><a href="#cb68-1176" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-1177"><a href="#cb68-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1178"><a href="#cb68-1178" aria-hidden="true" tabindex="-1"></a>new_patients <span class="sc">|&gt;</span></span>
<span id="cb68-1179"><a href="#cb68-1179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Hypothetical patient profiles"</span>)</span>
<span id="cb68-1180"><a href="#cb68-1180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1181"><a href="#cb68-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1184"><a href="#cb68-1184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1185"><a href="#cb68-1185" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cox-predicted</span></span>
<span id="cb68-1186"><a href="#cb68-1186" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Predicted survival curves for two hypothetical patient profiles"</span></span>
<span id="cb68-1187"><a href="#cb68-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1188"><a href="#cb68-1188" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predicted survival curves</span></span>
<span id="cb68-1189"><a href="#cb68-1189" aria-hidden="true" tabindex="-1"></a>pred_surv <span class="ot">&lt;-</span> <span class="fu">survfit</span>(cox_multi, <span class="at">newdata =</span> new_patients)</span>
<span id="cb68-1190"><a href="#cb68-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1191"><a href="#cb68-1191" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using ggsurvplot</span></span>
<span id="cb68-1192"><a href="#cb68-1192" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb68-1193"><a href="#cb68-1193" aria-hidden="true" tabindex="-1"></a>  pred_surv,</span>
<span id="cb68-1194"><a href="#cb68-1194" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> new_patients,</span>
<span id="cb68-1195"><a href="#cb68-1195" aria-hidden="true" tabindex="-1"></a>  <span class="at">conf.int =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-1196"><a href="#cb68-1196" aria-hidden="true" tabindex="-1"></a>  <span class="at">censor =</span> <span class="cn">FALSE</span>,</span>
<span id="cb68-1197"><a href="#cb68-1197" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time since diagnosis (months)"</span>,</span>
<span id="cb68-1198"><a href="#cb68-1198" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb68-1199"><a href="#cb68-1199" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"Lower risk patient"</span>, <span class="st">"Higher risk patient"</span>),</span>
<span id="cb68-1200"><a href="#cb68-1200" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.title =</span> <span class="st">"Patient profile"</span>,</span>
<span id="cb68-1201"><a href="#cb68-1201" aria-hidden="true" tabindex="-1"></a>  <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"#27AE60"</span>, <span class="st">"#E74C3C"</span>),</span>
<span id="cb68-1202"><a href="#cb68-1202" aria-hidden="true" tabindex="-1"></a>  <span class="at">ggtheme =</span> <span class="fu">theme_minimal</span>()</span>
<span id="cb68-1203"><a href="#cb68-1203" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-1204"><a href="#cb68-1204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1205"><a href="#cb68-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1206"><a href="#cb68-1206" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb68-1207"><a href="#cb68-1207" aria-hidden="true" tabindex="-1"></a><span class="fu">## How Predictions Work</span></span>
<span id="cb68-1208"><a href="#cb68-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1209"><a href="#cb68-1209" aria-hidden="true" tabindex="-1"></a>The Cox model doesn't directly estimate the survival function — it estimates hazard ratios. To predict survival, R first estimates a baseline survival function (for a patient with all covariates at reference levels), then adjusts this based on the covariate values using the estimated coefficients.</span>
<span id="cb68-1210"><a href="#cb68-1210" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1211"><a href="#cb68-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1212"><a href="#cb68-1212" aria-hidden="true" tabindex="-1"></a><span class="fu"># Practice Exercises</span></span>
<span id="cb68-1213"><a href="#cb68-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1214"><a href="#cb68-1214" aria-hidden="true" tabindex="-1"></a>The following exercises use datasets built into R's <span class="in">`survival`</span> package. Try these to consolidate your learning.</span>
<span id="cb68-1215"><a href="#cb68-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1216"><a href="#cb68-1216" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 1: The Lung Cancer Dataset</span></span>
<span id="cb68-1217"><a href="#cb68-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1218"><a href="#cb68-1218" aria-hidden="true" tabindex="-1"></a>The <span class="in">`lung`</span> dataset contains survival data from patients with advanced lung cancer. Load it and explore:</span>
<span id="cb68-1219"><a href="#cb68-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1222"><a href="#cb68-1222" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1223"><a href="#cb68-1223" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex1-data</span></span>
<span id="cb68-1224"><a href="#cb68-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1225"><a href="#cb68-1225" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the lung dataset</span></span>
<span id="cb68-1226"><a href="#cb68-1226" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(lung)</span>
<span id="cb68-1227"><a href="#cb68-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1228"><a href="#cb68-1228" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the structure</span></span>
<span id="cb68-1229"><a href="#cb68-1229" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(lung)</span>
<span id="cb68-1230"><a href="#cb68-1230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1231"><a href="#cb68-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1232"><a href="#cb68-1232" aria-hidden="true" tabindex="-1"></a>Key variables:</span>
<span id="cb68-1233"><a href="#cb68-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1234"><a href="#cb68-1234" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`time`</span>: Survival time in days</span>
<span id="cb68-1235"><a href="#cb68-1235" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`status`</span>: 1 = censored, 2 = dead (note: non-standard coding!)</span>
<span id="cb68-1236"><a href="#cb68-1236" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`sex`</span>: 1 = Male, 2 = Female</span>
<span id="cb68-1237"><a href="#cb68-1237" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`ph.ecog`</span>: ECOG performance score (0 = good, 5 = dead)</span>
<span id="cb68-1238"><a href="#cb68-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1239"><a href="#cb68-1239" aria-hidden="true" tabindex="-1"></a><span class="fu">### Task 1a: Recode the status variable</span></span>
<span id="cb68-1240"><a href="#cb68-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1241"><a href="#cb68-1241" aria-hidden="true" tabindex="-1"></a>The status variable uses non-standard coding. Recode it so that 0 = censored and 1 = event (death).</span>
<span id="cb68-1242"><a href="#cb68-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1243"><a href="#cb68-1243" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1244"><a href="#cb68-1244" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb68-1245"><a href="#cb68-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1248"><a href="#cb68-1248" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1249"><a href="#cb68-1249" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex1a-solution</span></span>
<span id="cb68-1250"><a href="#cb68-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1251"><a href="#cb68-1251" aria-hidden="true" tabindex="-1"></a>lung <span class="ot">&lt;-</span> lung <span class="sc">|&gt;</span></span>
<span id="cb68-1252"><a href="#cb68-1252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">status =</span> status <span class="sc">-</span> <span class="dv">1</span>)  <span class="co"># Convert 1,2 to 0,1</span></span>
<span id="cb68-1253"><a href="#cb68-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1254"><a href="#cb68-1254" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the recoding</span></span>
<span id="cb68-1255"><a href="#cb68-1255" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(lung<span class="sc">$</span>status)</span>
<span id="cb68-1256"><a href="#cb68-1256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1257"><a href="#cb68-1257" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1258"><a href="#cb68-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1259"><a href="#cb68-1259" aria-hidden="true" tabindex="-1"></a><span class="fu">### Task 1b: Create a Kaplan-Meier curve by sex</span></span>
<span id="cb68-1260"><a href="#cb68-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1261"><a href="#cb68-1261" aria-hidden="true" tabindex="-1"></a>Fit a survival curve comparing males and females, and create a plot.</span>
<span id="cb68-1262"><a href="#cb68-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1263"><a href="#cb68-1263" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1264"><a href="#cb68-1264" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb68-1265"><a href="#cb68-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1268"><a href="#cb68-1268" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1269"><a href="#cb68-1269" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex1b-solution</span></span>
<span id="cb68-1270"><a href="#cb68-1270" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival by sex in lung cancer patients"</span></span>
<span id="cb68-1271"><a href="#cb68-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1272"><a href="#cb68-1272" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb68-1273"><a href="#cb68-1273" aria-hidden="true" tabindex="-1"></a>lung_sex <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb68-1274"><a href="#cb68-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1275"><a href="#cb68-1275" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb68-1276"><a href="#cb68-1276" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb68-1277"><a href="#cb68-1277" aria-hidden="true" tabindex="-1"></a>  lung_sex,</span>
<span id="cb68-1278"><a href="#cb68-1278" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> lung,</span>
<span id="cb68-1279"><a href="#cb68-1279" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-1280"><a href="#cb68-1280" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time (days)"</span>,</span>
<span id="cb68-1281"><a href="#cb68-1281" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Survival probability"</span>,</span>
<span id="cb68-1282"><a href="#cb68-1282" aria-hidden="true" tabindex="-1"></a>  <span class="at">legend.labs =</span> <span class="fu">c</span>(<span class="st">"Male"</span>, <span class="st">"Female"</span>),</span>
<span id="cb68-1283"><a href="#cb68-1283" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by Sex"</span></span>
<span id="cb68-1284"><a href="#cb68-1284" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-1285"><a href="#cb68-1285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1286"><a href="#cb68-1286" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1287"><a href="#cb68-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1288"><a href="#cb68-1288" aria-hidden="true" tabindex="-1"></a><span class="fu">### Task 1c: Test for differences and fit a Cox model</span></span>
<span id="cb68-1289"><a href="#cb68-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1290"><a href="#cb68-1290" aria-hidden="true" tabindex="-1"></a>Conduct a log-rank test and fit a Cox model for sex.</span>
<span id="cb68-1291"><a href="#cb68-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1292"><a href="#cb68-1292" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1293"><a href="#cb68-1293" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb68-1294"><a href="#cb68-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1297"><a href="#cb68-1297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1298"><a href="#cb68-1298" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex1c-solution</span></span>
<span id="cb68-1299"><a href="#cb68-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1300"><a href="#cb68-1300" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-rank test</span></span>
<span id="cb68-1301"><a href="#cb68-1301" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb68-1302"><a href="#cb68-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1303"><a href="#cb68-1303" aria-hidden="true" tabindex="-1"></a><span class="co"># Cox model</span></span>
<span id="cb68-1304"><a href="#cb68-1304" aria-hidden="true" tabindex="-1"></a>cox_lung <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> sex, <span class="at">data =</span> lung)</span>
<span id="cb68-1305"><a href="#cb68-1305" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_lung)</span>
<span id="cb68-1306"><a href="#cb68-1306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1307"><a href="#cb68-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1308"><a href="#cb68-1308" aria-hidden="true" tabindex="-1"></a>**Interpretation**: Females (sex = 2) have significantly better survival than males. The hazard ratio of approximately 0.59 means females die at about 59% the rate of males, or equivalently, males have about 1.7 times higher hazard of death.</span>
<span id="cb68-1309"><a href="#cb68-1309" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1310"><a href="#cb68-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1311"><a href="#cb68-1311" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 2: The Colon Cancer Dataset</span></span>
<span id="cb68-1312"><a href="#cb68-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1313"><a href="#cb68-1313" aria-hidden="true" tabindex="-1"></a>The <span class="in">`colon`</span> dataset contains data from a trial of adjuvant chemotherapy for colon cancer. It has two rows per patient: one for recurrence and one for death.</span>
<span id="cb68-1314"><a href="#cb68-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1317"><a href="#cb68-1317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1318"><a href="#cb68-1318" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex2-data</span></span>
<span id="cb68-1319"><a href="#cb68-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1320"><a href="#cb68-1320" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(colon)</span>
<span id="cb68-1321"><a href="#cb68-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1322"><a href="#cb68-1322" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to death events only</span></span>
<span id="cb68-1323"><a href="#cb68-1323" aria-hidden="true" tabindex="-1"></a>colon_death <span class="ot">&lt;-</span> colon <span class="sc">|&gt;</span></span>
<span id="cb68-1324"><a href="#cb68-1324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(etype <span class="sc">==</span> <span class="dv">2</span>)  <span class="co"># etype 2 = death</span></span>
<span id="cb68-1325"><a href="#cb68-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1326"><a href="#cb68-1326" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(colon_death)</span>
<span id="cb68-1327"><a href="#cb68-1327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1328"><a href="#cb68-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1329"><a href="#cb68-1329" aria-hidden="true" tabindex="-1"></a>Key variables:</span>
<span id="cb68-1330"><a href="#cb68-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1331"><a href="#cb68-1331" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`time`</span>: Days until event or censoring</span>
<span id="cb68-1332"><a href="#cb68-1332" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`status`</span>: 0 = censored, 1 = event</span>
<span id="cb68-1333"><a href="#cb68-1333" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`rx`</span>: Treatment (Obs = observation, Lev = levamisole, Lev+5FU = levamisole + 5-fluorouracil)</span>
<span id="cb68-1334"><a href="#cb68-1334" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`nodes`</span>: Number of positive lymph nodes</span>
<span id="cb68-1335"><a href="#cb68-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1336"><a href="#cb68-1336" aria-hidden="true" tabindex="-1"></a><span class="fu">### Task 2a: Compare survival by treatment</span></span>
<span id="cb68-1337"><a href="#cb68-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1338"><a href="#cb68-1338" aria-hidden="true" tabindex="-1"></a>Create KM curves comparing the three treatment groups.</span>
<span id="cb68-1339"><a href="#cb68-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1340"><a href="#cb68-1340" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1341"><a href="#cb68-1341" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb68-1342"><a href="#cb68-1342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1345"><a href="#cb68-1345" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1346"><a href="#cb68-1346" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex2a-solution</span></span>
<span id="cb68-1347"><a href="#cb68-1347" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival by treatment in colon cancer"</span></span>
<span id="cb68-1348"><a href="#cb68-1348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1349"><a href="#cb68-1349" aria-hidden="true" tabindex="-1"></a>colon_rx <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> rx, <span class="at">data =</span> colon_death)</span>
<span id="cb68-1350"><a href="#cb68-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1351"><a href="#cb68-1351" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(</span>
<span id="cb68-1352"><a href="#cb68-1352" aria-hidden="true" tabindex="-1"></a>  colon_rx,</span>
<span id="cb68-1353"><a href="#cb68-1353" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> colon_death,</span>
<span id="cb68-1354"><a href="#cb68-1354" aria-hidden="true" tabindex="-1"></a>  <span class="at">risk.table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb68-1355"><a href="#cb68-1355" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Time (days)"</span>,</span>
<span id="cb68-1356"><a href="#cb68-1356" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">"Overall Survival by Treatment"</span></span>
<span id="cb68-1357"><a href="#cb68-1357" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-1358"><a href="#cb68-1358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1359"><a href="#cb68-1359" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-rank test</span></span>
<span id="cb68-1360"><a href="#cb68-1360" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> rx, <span class="at">data =</span> colon_death)</span>
<span id="cb68-1361"><a href="#cb68-1361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1362"><a href="#cb68-1362" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1363"><a href="#cb68-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1364"><a href="#cb68-1364" aria-hidden="true" tabindex="-1"></a><span class="fu">### Task 2b: Fit a multivariable Cox model</span></span>
<span id="cb68-1365"><a href="#cb68-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1366"><a href="#cb68-1366" aria-hidden="true" tabindex="-1"></a>Fit a Cox model including treatment (<span class="in">`rx`</span>), age, sex, and number of positive nodes.</span>
<span id="cb68-1367"><a href="#cb68-1367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1368"><a href="#cb68-1368" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1369"><a href="#cb68-1369" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb68-1370"><a href="#cb68-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1373"><a href="#cb68-1373" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1374"><a href="#cb68-1374" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex2b-solution</span></span>
<span id="cb68-1375"><a href="#cb68-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1376"><a href="#cb68-1376" aria-hidden="true" tabindex="-1"></a>cox_colon <span class="ot">&lt;-</span> <span class="fu">coxph</span>(</span>
<span id="cb68-1377"><a href="#cb68-1377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Surv</span>(time, status) <span class="sc">~</span> rx <span class="sc">+</span> age <span class="sc">+</span> sex <span class="sc">+</span> nodes,</span>
<span id="cb68-1378"><a href="#cb68-1378" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> colon_death</span>
<span id="cb68-1379"><a href="#cb68-1379" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-1380"><a href="#cb68-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1381"><a href="#cb68-1381" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_colon)</span>
<span id="cb68-1382"><a href="#cb68-1382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1383"><a href="#cb68-1383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1384"><a href="#cb68-1384" aria-hidden="true" tabindex="-1"></a>**Interpretation**: </span>
<span id="cb68-1385"><a href="#cb68-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1386"><a href="#cb68-1386" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Levamisole alone shows no significant benefit over observation</span>
<span id="cb68-1387"><a href="#cb68-1387" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Levamisole + 5FU significantly improves survival (HR ≈ 0.64)</span>
<span id="cb68-1388"><a href="#cb68-1388" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each additional positive lymph node increases hazard by about 9%</span>
<span id="cb68-1389"><a href="#cb68-1389" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Age and sex are not significantly associated with survival after adjusting for treatment and nodes</span>
<span id="cb68-1390"><a href="#cb68-1390" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1391"><a href="#cb68-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1392"><a href="#cb68-1392" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 3: The AML Dataset</span></span>
<span id="cb68-1393"><a href="#cb68-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1394"><a href="#cb68-1394" aria-hidden="true" tabindex="-1"></a>The <span class="in">`aml`</span> dataset is a small dataset comparing maintenance chemotherapy for acute myelogenous leukaemia.</span>
<span id="cb68-1395"><a href="#cb68-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1398"><a href="#cb68-1398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1399"><a href="#cb68-1399" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex3-data</span></span>
<span id="cb68-1400"><a href="#cb68-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1401"><a href="#cb68-1401" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(aml)</span>
<span id="cb68-1402"><a href="#cb68-1402" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(aml)</span>
<span id="cb68-1403"><a href="#cb68-1403" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1404"><a href="#cb68-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1405"><a href="#cb68-1405" aria-hidden="true" tabindex="-1"></a>Variables:</span>
<span id="cb68-1406"><a href="#cb68-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1407"><a href="#cb68-1407" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`time`</span>: Survival time in weeks</span>
<span id="cb68-1408"><a href="#cb68-1408" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`status`</span>: 0 = censored, 1 = relapsed</span>
<span id="cb68-1409"><a href="#cb68-1409" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`x`</span>: Treatment group (Maintained or Nonmaintained)</span>
<span id="cb68-1410"><a href="#cb68-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1411"><a href="#cb68-1411" aria-hidden="true" tabindex="-1"></a><span class="fu">### Task 3a: Calculate median survival by group</span></span>
<span id="cb68-1412"><a href="#cb68-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1413"><a href="#cb68-1413" aria-hidden="true" tabindex="-1"></a>Estimate median survival time for each treatment group.</span>
<span id="cb68-1414"><a href="#cb68-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1415"><a href="#cb68-1415" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1416"><a href="#cb68-1416" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb68-1417"><a href="#cb68-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1420"><a href="#cb68-1420" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1421"><a href="#cb68-1421" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex3a-solution</span></span>
<span id="cb68-1422"><a href="#cb68-1422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1423"><a href="#cb68-1423" aria-hidden="true" tabindex="-1"></a>aml_fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> x, <span class="at">data =</span> aml)</span>
<span id="cb68-1424"><a href="#cb68-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1425"><a href="#cb68-1425" aria-hidden="true" tabindex="-1"></a><span class="co"># Median survival</span></span>
<span id="cb68-1426"><a href="#cb68-1426" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(aml_fit)</span>
<span id="cb68-1427"><a href="#cb68-1427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1428"><a href="#cb68-1428" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1429"><a href="#cb68-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1430"><a href="#cb68-1430" aria-hidden="true" tabindex="-1"></a><span class="fu">### Task 3b: Estimate survival probability at 30 weeks</span></span>
<span id="cb68-1431"><a href="#cb68-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1432"><a href="#cb68-1432" aria-hidden="true" tabindex="-1"></a>What proportion of patients in each group survived beyond 30 weeks?</span>
<span id="cb68-1433"><a href="#cb68-1433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1434"><a href="#cb68-1434" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1435"><a href="#cb68-1435" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb68-1436"><a href="#cb68-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1439"><a href="#cb68-1439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1440"><a href="#cb68-1440" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex3b-solution</span></span>
<span id="cb68-1441"><a href="#cb68-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1442"><a href="#cb68-1442" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the range of times in the data</span></span>
<span id="cb68-1443"><a href="#cb68-1443" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(aml<span class="sc">$</span>time)</span>
<span id="cb68-1444"><a href="#cb68-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1445"><a href="#cb68-1445" aria-hidden="true" tabindex="-1"></a><span class="co"># Get survival estimates at 30 weeks</span></span>
<span id="cb68-1446"><a href="#cb68-1446" aria-hidden="true" tabindex="-1"></a><span class="co"># Use extend = TRUE to handle times beyond observed data</span></span>
<span id="cb68-1447"><a href="#cb68-1447" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(aml_fit, <span class="at">times =</span> <span class="dv">30</span>, <span class="at">extend =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-1448"><a href="#cb68-1448" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1449"><a href="#cb68-1449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1450"><a href="#cb68-1450" aria-hidden="true" tabindex="-1"></a>Note: The <span class="in">`extend = TRUE`</span> argument allows estimation at time points beyond the last observed event for a group by carrying forward the last survival estimate.</span>
<span id="cb68-1451"><a href="#cb68-1451" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1452"><a href="#cb68-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1453"><a href="#cb68-1453" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 4: Cox Modelling with the Veteran Dataset</span></span>
<span id="cb68-1454"><a href="#cb68-1454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1455"><a href="#cb68-1455" aria-hidden="true" tabindex="-1"></a>The <span class="in">`veteran`</span> dataset describes survival of patients with lung cancer in a Veterans Administration trial.</span>
<span id="cb68-1456"><a href="#cb68-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1459"><a href="#cb68-1459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1460"><a href="#cb68-1460" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex4-data</span></span>
<span id="cb68-1461"><a href="#cb68-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1462"><a href="#cb68-1462" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(veteran)</span>
<span id="cb68-1463"><a href="#cb68-1463" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(veteran)</span>
<span id="cb68-1464"><a href="#cb68-1464" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1465"><a href="#cb68-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1466"><a href="#cb68-1466" aria-hidden="true" tabindex="-1"></a>Key variables:</span>
<span id="cb68-1467"><a href="#cb68-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1468"><a href="#cb68-1468" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`time`</span>: Survival time in days</span>
<span id="cb68-1469"><a href="#cb68-1469" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`status`</span>: 0 = censored, 1 = dead</span>
<span id="cb68-1470"><a href="#cb68-1470" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`trt`</span>: Treatment (1 = standard, 2 = test)</span>
<span id="cb68-1471"><a href="#cb68-1471" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`karno`</span>: Karnofsky performance score (0-100, higher is better)</span>
<span id="cb68-1472"><a href="#cb68-1472" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`age`</span>: Age in years</span>
<span id="cb68-1473"><a href="#cb68-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1474"><a href="#cb68-1474" aria-hidden="true" tabindex="-1"></a><span class="fu">### Task 4a: Fit a Cox model</span></span>
<span id="cb68-1475"><a href="#cb68-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1476"><a href="#cb68-1476" aria-hidden="true" tabindex="-1"></a>Fit a Cox model with treatment, Karnofsky score, and age as predictors.</span>
<span id="cb68-1477"><a href="#cb68-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1478"><a href="#cb68-1478" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1479"><a href="#cb68-1479" aria-hidden="true" tabindex="-1"></a><span class="fu">## Solution</span></span>
<span id="cb68-1480"><a href="#cb68-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1483"><a href="#cb68-1483" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1484"><a href="#cb68-1484" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ex4a-solution</span></span>
<span id="cb68-1485"><a href="#cb68-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1486"><a href="#cb68-1486" aria-hidden="true" tabindex="-1"></a>cox_veteran <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, status) <span class="sc">~</span> trt <span class="sc">+</span> karno <span class="sc">+</span> age, <span class="at">data =</span> veteran)</span>
<span id="cb68-1487"><a href="#cb68-1487" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cox_veteran)</span>
<span id="cb68-1488"><a href="#cb68-1488" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb68-1489"><a href="#cb68-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1490"><a href="#cb68-1490" aria-hidden="true" tabindex="-1"></a>**Interpretation**: </span>
<span id="cb68-1491"><a href="#cb68-1491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1492"><a href="#cb68-1492" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Treatment (test vs standard) shows no significant effect on survival</span>
<span id="cb68-1493"><a href="#cb68-1493" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Each 1-point increase in Karnofsky score reduces hazard by about 3% (HR ≈ 0.97), and this is highly significant</span>
<span id="cb68-1494"><a href="#cb68-1494" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Age shows no significant association with survival after adjusting for treatment and Karnofsky score</span>
<span id="cb68-1495"><a href="#cb68-1495" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1496"><a href="#cb68-1496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1497"><a href="#cb68-1497" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 5: Interpretation Questions</span></span>
<span id="cb68-1498"><a href="#cb68-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1499"><a href="#cb68-1499" aria-hidden="true" tabindex="-1"></a>These questions test your understanding of survival analysis concepts. Think about each one before revealing the answer.</span>
<span id="cb68-1500"><a href="#cb68-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1501"><a href="#cb68-1501" aria-hidden="true" tabindex="-1"></a><span class="fu">### Question 5a</span></span>
<span id="cb68-1502"><a href="#cb68-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1503"><a href="#cb68-1503" aria-hidden="true" tabindex="-1"></a>A Cox model gives a hazard ratio of 2.5 for a binary exposure variable. What does this mean?</span>
<span id="cb68-1504"><a href="#cb68-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1505"><a href="#cb68-1505" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1506"><a href="#cb68-1506" aria-hidden="true" tabindex="-1"></a><span class="fu">## Answer</span></span>
<span id="cb68-1507"><a href="#cb68-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1508"><a href="#cb68-1508" aria-hidden="true" tabindex="-1"></a>The exposed group experiences the event at 2.5 times the rate of the unexposed group at any given time point. This indicates substantially worse survival in the exposed group.</span>
<span id="cb68-1509"><a href="#cb68-1509" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1510"><a href="#cb68-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1511"><a href="#cb68-1511" aria-hidden="true" tabindex="-1"></a><span class="fu">### Question 5b</span></span>
<span id="cb68-1512"><a href="#cb68-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1513"><a href="#cb68-1513" aria-hidden="true" tabindex="-1"></a>Why can't we simply calculate "proportion surviving" to estimate 2-year survival?</span>
<span id="cb68-1514"><a href="#cb68-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1515"><a href="#cb68-1515" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb68-1516"><a href="#cb68-1516" aria-hidden="true" tabindex="-1"></a><span class="fu">## Answer</span></span>
<span id="cb68-1517"><a href="#cb68-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1518"><a href="#cb68-1518" aria-hidden="true" tabindex="-1"></a>A naive calculation would either:</span>
<span id="cb68-1519"><a href="#cb68-1519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1520"><a href="#cb68-1520" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Treat censored patients as if they survived the full period (overestimating survival), or</span>
<span id="cb68-1521"><a href="#cb68-1521" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Exclude them entirely (potentially biasing in either direction)</span>
<span id="cb68-1522"><a href="#cb68-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1523"><a href="#cb68-1523" aria-hidden="true" tabindex="-1"></a>The Kaplan-Meier method correctly accounts for censoring by including each patient's contribution up to their censoring time, then removing them from the risk set.</span>
<span id="cb68-1524"><a href="#cb68-1524" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1525"><a href="#cb68-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1526"><a href="#cb68-1526" aria-hidden="true" tabindex="-1"></a><span class="fu"># Summary</span></span>
<span id="cb68-1527"><a href="#cb68-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1528"><a href="#cb68-1528" aria-hidden="true" tabindex="-1"></a>This tutorial has covered the fundamental techniques of survival analysis in R:</span>
<span id="cb68-1529"><a href="#cb68-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1530"><a href="#cb68-1530" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Why survival analysis**: Understanding censoring, non-informative censoring assumptions, and why standard methods don't work for time-to-event data</span>
<span id="cb68-1531"><a href="#cb68-1531" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Survival objects**: Created using <span class="in">`Surv()`</span> to encode time-to-event data with censoring</span>
<span id="cb68-1532"><a href="#cb68-1532" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Kaplan-Meier estimation**: Non-parametric estimation of survival curves using <span class="in">`survfit()`</span></span>
<span id="cb68-1533"><a href="#cb68-1533" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Survival estimates**: Calculating median survival and survival probabilities at specific time points</span>
<span id="cb68-1534"><a href="#cb68-1534" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**Hazard functions**: Both cumulative and smoothed instantaneous hazard rates</span>
<span id="cb68-1535"><a href="#cb68-1535" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>**Log-rank tests**: Formal comparison of survival between groups using <span class="in">`survdiff()`</span>, including weighted alternatives</span>
<span id="cb68-1536"><a href="#cb68-1536" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>**Cox regression**: Semi-parametric modelling of hazard ratios using <span class="in">`coxph()`</span>, including interpretation of HRs</span>
<span id="cb68-1537"><a href="#cb68-1537" aria-hidden="true" tabindex="-1"></a><span class="ss">8.  </span>**Survival predictions**: Generating predicted survival curves for specific patient profiles</span>
<span id="cb68-1538"><a href="#cb68-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1539"><a href="#cb68-1539" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb68-1540"><a href="#cb68-1540" aria-hidden="true" tabindex="-1"></a><span class="fu">## Further Reading</span></span>
<span id="cb68-1541"><a href="#cb68-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1542"><a href="#cb68-1542" aria-hidden="true" tabindex="-1"></a>**Introductory tutorials:**</span>
<span id="cb68-1543"><a href="#cb68-1543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1544"><a href="#cb68-1544" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Survival Analysis in R</span><span class="co">](https://www.emilyzabor.com/survival-analysis-in-r.html)</span> by Emily Zabor — excellent comprehensive tutorial</span>
<span id="cb68-1545"><a href="#cb68-1545" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Bioconnector Survival Analysis</span><span class="co">](https://bioconnector.github.io/workshops/r-survival.html)</span> — hands-on workshop materials</span>
<span id="cb68-1546"><a href="#cb68-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1547"><a href="#cb68-1547" aria-hidden="true" tabindex="-1"></a>**Key papers:**</span>
<span id="cb68-1548"><a href="#cb68-1548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1549"><a href="#cb68-1549" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Clark TG et al. (2003) Survival analysis part I-IV. *British Journal of Cancer* — four-part series covering basic to advanced concepts</span>
<span id="cb68-1550"><a href="#cb68-1550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1551"><a href="#cb68-1551" aria-hidden="true" tabindex="-1"></a>**Books:**</span>
<span id="cb68-1552"><a href="#cb68-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1553"><a href="#cb68-1553" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Therneau TM &amp; Grambsch PM (2000) *Modeling Survival Data: Extending the Cox Model*. Springer.</span>
<span id="cb68-1554"><a href="#cb68-1554" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Kleinbaum DG &amp; Klein M (2012) *Survival Analysis: A Self-Learning Text*. 3rd ed. Springer.</span>
<span id="cb68-1555"><a href="#cb68-1555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1556"><a href="#cb68-1556" aria-hidden="true" tabindex="-1"></a>**R package documentation:**</span>
<span id="cb68-1557"><a href="#cb68-1557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1558"><a href="#cb68-1558" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`vignette("survival")`</span> — comprehensive introduction to the survival package</span>
<span id="cb68-1559"><a href="#cb68-1559" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`vignette("timedep")`</span> — time-dependent covariates and coefficients</span>
<span id="cb68-1560"><a href="#cb68-1560" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb68-1561"><a href="#cb68-1561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1562"><a href="#cb68-1562" aria-hidden="true" tabindex="-1"></a><span class="fu"># Session Information</span></span>
<span id="cb68-1563"><a href="#cb68-1563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1566"><a href="#cb68-1566" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb68-1567"><a href="#cb68-1567" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: session-info</span></span>
<span id="cb68-1568"><a href="#cb68-1568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-1569"><a href="#cb68-1569" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb68-1570"><a href="#cb68-1570" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>